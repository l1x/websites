<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=/css/dosis.min.css><link rel=stylesheet href=/css/tachyons.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/fontawesome.min.css><title>l1x/dev | Data-cat</title><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/img/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><meta name=image property="og:image" content><meta name=title property="og:title" content="Data-cat"><meta name=description property="og:description" content="Deploying DataDog for a large scale infrastructure"><meta name=type property="og:type" content="article"><meta name=url property="og:url" content="https://dev.l1x.be/projects/data-cat/"><meta name=author content="l1x"></head><body><div class="content mw8-l center pl4"><header class="flex mw8-l center pt4"><div class=pt3><img src=/img/apple-touch-icon.png width=60 alt=apple-touch-icon></div><a href=/ class="title link pl3 pt2"><h1>l1x/dev</h1></a></header><div><h1 id=data-cat>Data-cat</h1><p>Deploying DataDog for a large scale infrastructure</p><h2 id=definitions>Definitions</h2><ul><li>Geographic Regions</li><li>Stages</li><li>Applications</li></ul><h3 id=geographic-regions>Geographic Regions</h3><p>Matches the definitions of AWS Regions. It can be used for GCP or on-prem datacenter as well.</p><h3 id=stages>Stages</h3><p>Different stages of application deployments, usually: dev, qa, prod.</p><h3 id=applications>Applications</h3><p>A service that provides a distinct business functionality.</p><h2 id=goals>Goals</h2><ul><li>having all monitors and dashboards in version control</li><li>having all monitors templated</li><li>being able to address smaller parts of the infrastructure</li></ul><h2 id=implementation>Implementation</h2><p>4 files represent the DataDog configuration for the whole infrastructure.</p><ul><li>infrastructure.yaml</li></ul><p>It contains the logical grouping of applications into stages and regions. The relations are always N:M. 1 region can contain many stages and many applications in each stage.</p><ul><li>region.yaml</li></ul><p>Defaults for a certain region (region).</p><ul><li>stage.yaml</li></ul><p>Defaults for a certain stage (region, stage).</p><ul><li>application.yaml</li></ul><p>Configuration that is specific for a certain application (region, stage, application).</p><h3 id=generating-infrastructureyaml>Generating infrastructure.yaml</h3><p>I recently discovered <a href=https://dhall-lang.org>Dhall</a> that seems like the perfect fit to write the infrastructure in and than generate the YAML files.</p><p>The type safe definitions looks like the following:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Haskell data-lang=Haskell><span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>keyValue</span> <span style=color:#204a87;font-weight:700>=</span>
        <span style=color:#000>λ</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>k</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Type</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#a40000>→</span> <span style=color:#000>λ</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Type</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#a40000>→</span> <span style=color:#000>λ</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mapKey</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#000>k</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#a40000>→</span> <span style=color:#000>λ</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mapValue</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#000>v</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#a40000>→</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>mapKey</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>mapKey</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>mapValue</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>mapValue</span> <span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>let</span> <span style=color:#204a87;font-weight:700>ApplicationConfig</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Type</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>created_at</span> <span style=color:#204a87;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>Text</span> <span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>let</span> <span style=color:#204a87;font-weight:700>Application</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>etcd</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>postgresql</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>hadoop</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
<span style=color:#204a87;font-weight:700>let</span> <span style=color:#204a87;font-weight:700>Applications</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>Prelude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#204a87;font-weight:700>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#204a87;font-weight:700>Type</span> <span style=color:#204a87;font-weight:700>Application</span> <span style=color:#204a87;font-weight:700>ApplicationConfig</span>
<span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>application</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>keyValue</span> <span style=color:#204a87;font-weight:700>Application</span> <span style=color:#204a87;font-weight:700>ApplicationConfig</span>

<span style=color:#204a87;font-weight:700>let</span> <span style=color:#204a87;font-weight:700>Stage</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>dev</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>qa</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>prod</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
<span style=color:#204a87;font-weight:700>let</span> <span style=color:#204a87;font-weight:700>Stages</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>Prelude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#204a87;font-weight:700>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#204a87;font-weight:700>Type</span> <span style=color:#204a87;font-weight:700>Stage</span> <span style=color:#204a87;font-weight:700>Applications</span>
<span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>stage</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>keyValue</span> <span style=color:#204a87;font-weight:700>Stage</span> <span style=color:#204a87;font-weight:700>Applications</span>

<span style=color:#204a87;font-weight:700>let</span> <span style=color:#204a87;font-weight:700>AwsRegion</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>us</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>east</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>eu</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>central</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>eu</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>west</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>&gt;</span>
<span style=color:#204a87;font-weight:700>let</span> <span style=color:#204a87;font-weight:700>AwsRegions</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>Prelude</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#204a87;font-weight:700>Map</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#204a87;font-weight:700>Type</span> <span style=color:#204a87;font-weight:700>AwsRegion</span> <span style=color:#204a87;font-weight:700>Stages</span>
<span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>awsRegion</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#000>keyValue</span> <span style=color:#204a87;font-weight:700>AwsRegion</span> <span style=color:#204a87;font-weight:700>Stages</span>
</code></pre></div><p>After having these definitions we can create the infrastructure:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Haskell data-lang=Haskell><span style=color:#204a87;font-weight:700>in</span>  <span style=color:#000;font-weight:700>[</span> <span style=color:#000>awsRegion</span> <span style=color:#204a87;font-weight:700>AwsRegion</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>us</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>east</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span>
        <span style=color:#000;font-weight:700>[</span> <span style=color:#000>stage</span> <span style=color:#204a87;font-weight:700>Stage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>dev</span>
             <span style=color:#000;font-weight:700>[</span> <span style=color:#000>application</span> <span style=color:#204a87;font-weight:700>Application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hadoop</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>created_at</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;2019-11-04T09:00:00Z&#34;</span> <span style=color:#000;font-weight:700>}</span>
             <span style=color:#000;font-weight:700>,</span> <span style=color:#000>application</span> <span style=color:#204a87;font-weight:700>Application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>etcd</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>created_at</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;2019-11-04T09:00:00Z&#34;</span> <span style=color:#000;font-weight:700>}</span>
             <span style=color:#000;font-weight:700>]</span>
        <span style=color:#000;font-weight:700>,</span> <span style=color:#000>stage</span> <span style=color:#204a87;font-weight:700>Stage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>qa</span>
             <span style=color:#000;font-weight:700>[</span> <span style=color:#000>application</span> <span style=color:#204a87;font-weight:700>Application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hadoop</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>created_at</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;2019-11-04T09:00:00Z&#34;</span> <span style=color:#000;font-weight:700>}</span>
             <span style=color:#000;font-weight:700>,</span> <span style=color:#000>application</span> <span style=color:#204a87;font-weight:700>Application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>etcd</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>created_at</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;2019-11-04T09:00:00Z&#34;</span> <span style=color:#000;font-weight:700>}</span>
             <span style=color:#000;font-weight:700>]</span>
        <span style=color:#000;font-weight:700>]</span>

    <span style=color:#000;font-weight:700>,</span> <span style=color:#000>awsRegion</span> <span style=color:#204a87;font-weight:700>AwsRegion</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>eu</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>west</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span>
        <span style=color:#000;font-weight:700>[</span> <span style=color:#000>stage</span> <span style=color:#204a87;font-weight:700>Stage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>dev</span>
             <span style=color:#000;font-weight:700>[</span> <span style=color:#000>application</span> <span style=color:#204a87;font-weight:700>Application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hadoop</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>created_at</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;2019-11-04T09:00:00Z&#34;</span> <span style=color:#000;font-weight:700>}</span>
             <span style=color:#000;font-weight:700>,</span> <span style=color:#000>application</span> <span style=color:#204a87;font-weight:700>Application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>etcd</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>created_at</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;2019-11-04T09:00:00Z&#34;</span> <span style=color:#000;font-weight:700>}</span>
             <span style=color:#000;font-weight:700>]</span>
        <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>,</span> <span style=color:#000>awsRegion</span> <span style=color:#204a87;font-weight:700>AwsRegion</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>eu</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>central</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span>
        <span style=color:#000;font-weight:700>[</span> <span style=color:#000>stage</span> <span style=color:#204a87;font-weight:700>Stage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>dev</span>
            <span style=color:#000;font-weight:700>[</span> <span style=color:#000>application</span> <span style=color:#204a87;font-weight:700>Application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hadoop</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>created_at</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;2019-11-04T09:00:00Z&#34;</span> <span style=color:#000;font-weight:700>}</span>
            <span style=color:#000;font-weight:700>,</span> <span style=color:#000>application</span> <span style=color:#204a87;font-weight:700>Application</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>etcd</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>created_at</span> <span style=color:#204a87;font-weight:700>=</span> <span style=color:#4e9a06>&#34;2019-11-04T09:00:00Z&#34;</span> <span style=color:#000;font-weight:700>}</span>
            <span style=color:#000;font-weight:700>]</span>
        <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>]</span>
</code></pre></div><p>Generating the YAML:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>dhall-to-yaml --file infrastructure.dhall &gt; infrastructure.yaml
</code></pre></div><h3 id=generating-the-folder-structure>Generating the folder structure</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Bash data-lang=Bash>python3 gen.py
region: eu-central-1, stage: dev
region: eu-central-1, stage: dev, app: etcd
region: eu-central-1, stage: dev, app: hadoop
region: eu-west-1, stage: dev
region: eu-west-1, stage: dev, app: etcd
region: eu-west-1, stage: dev, app: hadoop
region: eu-west-1, stage: prod
region: eu-west-1, stage: prod, app: etcd
region: eu-west-1, stage: prod, app: hadoop
</code></pre></div><h3 id=templates>Templates</h3><p>Templates folder has the monitor templates.</p><p>Example template:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-YAML data-lang=YAML>---<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>High<span style=color:#f8f8f8;text-decoration:underline> </span>CPU<span style=color:#f8f8f8;text-decoration:underline> </span>load<span style=color:#f8f8f8;text-decoration:underline> </span>on<span style=color:#f8f8f8;text-decoration:underline> </span>application_name<span style=color:#000;font-weight:700>:</span>{application_name}<span style=color:#f8f8f8;text-decoration:underline> </span>stage<span style=color:#000;font-weight:700>:</span>{stage}<span style=color:#f8f8f8;text-decoration:underline> </span>{{{{host.name}}}}<span style=color:#f8f8f8;text-decoration:underline> </span>/<span style=color:#f8f8f8;text-decoration:underline> </span>{{{{host.ip}}}}<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>tags</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- application_name<span style=color:#000;font-weight:700>:</span>{application_name}<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- stage<span style=color:#000;font-weight:700>:</span>{stage}<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- region<span style=color:#000;font-weight:700>:</span>{region}<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>metric<span style=color:#f8f8f8;text-decoration:underline> </span>alert<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>avg(last_5m)<span style=color:#000;font-weight:700>:</span>avg<span style=color:#000;font-weight:700>:</span>system.load.norm<span style=color:#0000cf;font-weight:700>.5</span>{{application_name<span style=color:#000;font-weight:700>:</span>{application_name}<span style=color:#000;font-weight:700>,</span>stage<span style=color:#000;font-weight:700>:</span>{stage}}}<span style=color:#f8f8f8;text-decoration:underline> </span>by<span style=color:#f8f8f8;text-decoration:underline> </span>{{host}}<span style=color:#f8f8f8;text-decoration:underline> </span>&gt;<span style=color:#f8f8f8;text-decoration:underline> </span>{critical_threshold}<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>&gt;-<span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>High<span style=color:#f8f8f8;text-decoration:underline> </span>CPU<span style=color:#f8f8f8;text-decoration:underline> </span>load<span style=color:#f8f8f8;text-decoration:underline> </span>on<span style=color:#f8f8f8;text-decoration:underline> </span>application_name<span style=color:#000;font-weight:700>:</span>{application_name}<span style=color:#f8f8f8;text-decoration:underline> </span>stage<span style=color:#000;font-weight:700>:</span>{stage}<span style=color:#f8f8f8;text-decoration:underline> </span>{{{{host.name}}}}<span style=color:#f8f8f8;text-decoration:underline> </span>/<span style=color:#f8f8f8;text-decoration:underline> </span>{{{{host.ip}}}}<span style=color:#f8f8f8;text-decoration:underline> </span>for<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8;text-decoration:underline> </span>consecutive<span style=color:#f8f8f8;text-decoration:underline> </span>minutes<span style=color:#f8f8f8;text-decoration:underline> </span>on<span style=color:#f8f8f8;text-decoration:underline> </span>this<span style=color:#f8f8f8;text-decoration:underline> </span>node.<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>Url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>https<span style=color:#000;font-weight:700>:</span>//wd-global-prod.datadoghq.com/monitors/{monitor_id}<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>{slack_notification_channel}<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>monitor_options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>notify_audit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>False<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>locked</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>False<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>timeout_h</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>silenced</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{{}}<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>include_tags</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>True<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>require_full_window</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>True<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>new_host_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>300</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>notify_no_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>False<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>renotify_interval</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>escalation_message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>&gt;-<span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>CPU<span style=color:#f8f8f8;text-decoration:underline> </span>load<span style=color:#f8f8f8;text-decoration:underline> </span>is<span style=color:#f8f8f8;text-decoration:underline> </span>still<span style=color:#f8f8f8;text-decoration:underline> </span>damn<span style=color:#f8f8f8;text-decoration:underline> </span>high.<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>thresholds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>critical</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{critical_threshold}<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>warning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{warning_threshold}<span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>This gets rendered using Python format and converted to a dict that used to talk to the DataDog API.</p><h3 id=defaults-and-specifics>Defaults and specifics</h3><p>Defaults are stage wide settings specifics are specific to a single application (in a region & stage).</p><h3 id=tags-alignment>Tags alignment</h3><p>For all of these above to work together nicely there is a dependency on tags being deployed every node, ELB, etc., so that we can reference those in monitors and dashboards.</p><h2 id=deployment>Deployment</h2><p>I gave up on Conda and now just using venv from Python.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Bash data-lang=Bash>/usr/local/opt/python3/bin/python3 -m venv venv
. venv/bin/activate.fish <span style=color:#8f5902;font-style:italic>#or the shell you are using</span>
pip install --upgrade pip
pip install --upgrade toml pyyaml
</code></pre></div><h3 id=deploying-monitors>Deploying monitors</h3><p>Deploying a whole stage:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>./data-cat/data-cat.py deploy-monitors -r eu-west-1 -s qa
</code></pre></div><p>Deploying a single application:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>./data-cat/data-cat.py deploy-monitors -r eu-west-1 -s qa -a etcd
</code></pre></div><h3 id=deploying-dashboards>Deploying dashboards</h3><p>Deploying a whole stage:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>./data-cat/data-cat.py deploy-dashboards -r eu-west-1 -s qa
</code></pre></div><p>Deploying a single application:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>./data-cat/data-cat.py deploy-dashboards -r eu-west-1 -s qa -a etcd
</code></pre></div><h2 id=what-to-monitor>What to monitor</h2><p>Following <a href=http://www.brendangregg.com/usemethod.html>Brendan Gregg&rsquo;s use method</a> and the suggested things to monitor:</p><ul><li>CPUs: sockets, cores, hardware threads (virtual CPUs)</li><li>Memory: capacity</li><li>Network interfaces</li><li>Storage devices: I/O, capacity</li><li>Controllers: storage, network cards</li><li>Interconnects: CPUs, memory, I/O</li></ul><p>How to monitor it (examples):</p><ul><li>utilization: as a percent over a time interval. eg, &ldquo;one disk is running at 90% utilization&rdquo;</li><li>saturation: as a queue length. eg, &ldquo;the CPUs have an average run queue length of four&rdquo;</li><li>errors: scalar counts. eg, &ldquo;this network interface has had fifty late collisions&rdquo;</li></ul></div></div></body><footer class="mw8-l center pa4"><a href=https://github.com/l1x class=pa2><i class="fab fa-github fa-2x"></i></a><a href=https://twitter.com/lix class=pa2><i class="fab fa-twitter fa-2x"></i></a><a href=https://www.linkedin.com/in/iszukacs class=pa2><i class="fab fa-linkedin fa-2x"></i></a><a href=https://dev.to/l1x class=pa2><i class="fab fa-dev fa-2x"></i></a></footer></html>