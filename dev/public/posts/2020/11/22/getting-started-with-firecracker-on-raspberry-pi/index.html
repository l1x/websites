<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=/css/dosis.min.css><link rel=stylesheet href=/css/tachyons.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/fontawesome.min.css><title>l1x/dev | Getting started with Firecracker on Raspberry Pi</title><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/img/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><meta name=image property="og:image" content><meta name=title property="og:title" content="Getting started with Firecracker on Raspberry Pi"><meta name=description property="og:description" content="Firecracker is an open source virtualisation technology for creating and managing secure, multi-tenant container services."><meta name=type property="og:type" content="article"><meta name=url property="og:url" content="https://dev.l1x.be/posts/2020/11/22/getting-started-with-firecracker-on-raspberry-pi/"><meta name=author content="l1x"></head><body><div class="content mw8-l center pl4"><header class="flex mw8-l center pt4"><div class=pt3><img src=/img/apple-touch-icon.png width=60></div><a href=/ class="title link pl3 pt2"><h1>l1x/dev</h1></a></header><h2 class=post-title>Getting started with Firecracker on Raspberry Pi</h2><div class=white>2020/11/22 :: #containerisation #virtualisation #linux #cgroups #cloud</div><div class="f4 lh-copy"><h2 id=abstract>Abstract</h2><p>Traditionally services were deployed on bare metal and in the last decades we have seen the rise of virtualisation (running additional operating systems in a operating system process) and lately containerisation (running an operating system process in a separate security context from the rest of processes on the same host). Virtualisation and containerisation offers different levels of isolation by moving some operating system functionality to the guest systems.</p><p>The following chart illustrates that pretty well:</p><p><img src=https://dev.l1x.be/img/isolation.png alt="OS functionality location"></p><p>Source: <a href=https://research.cs.wisc.edu/multifacet/papers/vee20_blending.pdf>https://research.cs.wisc.edu/multifacet/papers/vee20_blending.pdf</a></p><p>In this article, I perform a deep dive into Firecracker and how it can be used for deploying services on Raspberry Pi (4B).</p><h2 id=getting-started>Getting started</h2><p>There are few paths to take here. First I am going to try the easy one, using Ubuntu. Later on we can investigate the use of Alpine Linux which is much more lightweight than Ubuntu, ideal for devices like RPI.</p><h3 id=installing-the-image-on-a-microsd-card>Installing the image on a microSD card</h3><p>We need a 64 bit Ubuntu image and a microsd card. For the imaging I use <a href=https://www.balena.io/etcher/>Balena Etcher</a> that makes the imaging process super easy.</p><p>Getting the pre-installed image:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>wget https://cdimage.ubuntu.com/releases/20.04/release/<span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>ubuntu-20.04.1-preinstalled-server-arm64+raspi.img.xz
</code></pre></div><p>Preinstalled means that we get a fully working operating system and there is no need for additional installation steps after booting up. With Balena Etcher it is super easy to write the compressed image file to the sd card and boot the system up once ready. SSHD starts up after the installation and we can log in via ssh if we know the IP address that the DHCP server issues to our device (assuming DHCP server is present in our LAN).</p><p>There are few mildly annoying things with Ubuntu (snaps, unattended-upgrades) that I usually remove. I also prefer to use Chrony over the systemd equivalent. Ansible repo for these is available here: <a href=https://github.com/l1x/rpi/blob/main/ubuntu.20/ansible/roles/os/tasks/main.yml>https://github.com/l1x/rpi/blob/main/ubuntu.20/ansible/roles/os/tasks/main.yml</a></p><h3 id=installing-firecracker-jailer-and-firectl>Installing Firecracker, Jailer and Firectl</h3><ul><li>Firecracker: The main component, it is a virtual machine monitor (VMM) that uses the Linux Kernel Virtual Machine (KVM) to create and run microVMs.</li><li>Jailer: For starting Firecracker in production mode, applies a cgroup/namespace isolation barrier and then drops privileges. There</li><li>Firectl: A command line utility for convenience</li></ul><h4 id=getting-firecracker-and-jailer>Getting Firecracker and Jailer</h4><p>For the first two it is possible to download the release binaries from Github.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#40ffff>version</span>=<span style=color:#ed9d13>&#39;v0.23.0&#39;</span>

wget https://github.com/firecracker-microvm/firecracker/<span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>releases/download/<span style=color:#ed9d13>${</span><span style=color:#40ffff>version</span><span style=color:#ed9d13>}</span>/firecracker-<span style=color:#ed9d13>${</span><span style=color:#40ffff>version</span><span style=color:#ed9d13>}</span>-aarch64
wget https://github.com/firecracker-microvm/firecracker/<span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>releases/download/<span style=color:#ed9d13>${</span><span style=color:#40ffff>version</span><span style=color:#ed9d13>}</span>/jailer-<span style=color:#ed9d13>${</span><span style=color:#40ffff>version</span><span style=color:#ed9d13>}</span>-aarch64

mv firecracker-<span style=color:#ed9d13>${</span><span style=color:#40ffff>version</span><span style=color:#ed9d13>}</span>-aarch64 firecracker
mv jailer-<span style=color:#ed9d13>${</span><span style=color:#40ffff>version</span><span style=color:#ed9d13>}</span>-aarch64 jailer

chmod +x firecracker jailer

./firecracker --help
./jailer --help
</code></pre></div><h4 id=firectl>Firectl</h4><p>Firectl is a bit trickier to install because there is no release binary and it requires Golang 1.14 to compile. We can do these in two steps.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>wget https://golang.org/dl/go1.14.12.linux-arm64.tar.gz
tar xzvf go1.14.12.linux-arm64.tar.gz
</code></pre></div><p>After getting go we can get the source of firectl and compile it:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>git clone https://github.com/firecracker-microvm/firectl.git
<span style=color:#24909d>cd</span> firectl/
 ~/go/bin/go build -x
</code></pre></div><p>Testing Firectl:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>./firectl --help
</code></pre></div><p>We have all the tools we need for running our first microVM the only thing is missing: something to run.</p><h3 id=downloading-our-first-image>Downloading our first image</h3><p>For a microVM there are two things necessary to have:</p><ul><li>an uncompressed linux kernel (vmlinux)</li><li>a filesystem</li></ul><p>Later on we are going to investigate how we could create our own version of these, but for now we are going to use images from</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>wget https://s3.amazonaws.com/spec.ccfc.min/<span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>img/aarch64/ubuntu_with_ssh/kernel/vmlinux.bin
wget https://s3.amazonaws.com/spec.ccfc.min/<span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>img/aarch64/ubuntu_with_ssh/fsfiles/xenial.rootfs.ext4
</code></pre></div><h3 id=configuring-network>Configuring network</h3><p>For the microVM to function properly we need a networking device. For this scenario we are going to use tap and create a device:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo ip tuntap add dev tap0 mode tap
sudo ip addr add 172.16.0.1/24 dev tap0
sudo ip link <span style=color:#24909d>set</span> tap0 up
ip addr show dev tap0
</code></pre></div><p>If we want to give access to our VM we have to enable IP forwarding:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#40ffff>DEVICE_NAME</span>=eth0
sudo sh -c <span style=color:#ed9d13>&#34;echo 1 &gt; /proc/sys/net/ipv4/ip_forward&#34;</span>
sudo iptables -t nat -A POSTROUTING -o <span style=color:#40ffff>$DEVICE_NAME</span> -j MASQUERADE
sudo iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i tap0 -o <span style=color:#40ffff>$DEVICE_NAME</span> -j ACCEPT
</code></pre></div><h3 id=running-our-first-microvm>Running our first microVM</h3><p>This is how we can start up our first microVM. I usually start it in screen so I can open a new session easily because it will use the standard input and output for the newly started of console (unless you redirect it).</p><p>This is for debug mode, starting with sudo:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo ./firectl/firectl <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>--firecracker-binary=./firecracker <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>--kernel=vmlinux.bin <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>--tap-device=tap0/aa:fc:00:00:00:01 <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>--kernel-opts=<span style=color:#ed9d13>&#34;console=ttyS0 reboot=k panic=1 pci=off ip=172.16.0.42::172.16.0.1:255.255.255.0::eth0:off&#34;</span> <span style=color:#ed9d13>\
</span><span style=color:#ed9d13></span>--root-drive=./xenial.rootfs.ext4
</code></pre></div><p>If everything went well you can see something like this:</p><pre><code>Ubuntu 18.04.2 LTS fadfdd4af58a ttyS0

fadfdd4af58a login:
</code></pre><p>User and password is root:root.</p><h3 id=testing-networking>Testing networking</h3><p>For this we need to have a bit bigger image.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>dd <span style=color:#6ab825;font-weight:700>if</span>=/dev/zero <span style=color:#40ffff>bs</span>=1M <span style=color:#40ffff>count</span>=<span style=color:#3677a9>800</span> &gt;&gt; xenial.rootfs.ext4
resize2fs -f xenial.rootfs.ext4
</code></pre></div><p>After starting up the usual way and logging in we need to fix few things:</p><p>Adding some working nameserver:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#24909d>echo</span> <span style=color:#ed9d13>&#39;nameserver 1.1.1.1&#39;</span> &gt;  /etc/resolv.conf
</code></pre></div><p>Now trying to update:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>root@fadfdd4af58a:~# apt update
Get:1 http://ports.ubuntu.com/ubuntu-ports bionic InRelease [<span style=color:#3677a9>242</span> kB]
Get:2 http://ports.ubuntu.com/ubuntu-ports bionic-updates InRelease [88.7 kB]
Hit:3 http://ports.ubuntu.com/ubuntu-ports bionic-backports InRelease
Hit:4 http://ports.ubuntu.com/ubuntu-ports bionic-security InRelease
Get:5 http://ports.ubuntu.com/ubuntu-ports bionic/universe arm64 Packages [11.0 MB]
Get:6 http://ports.ubuntu.com/ubuntu-ports bionic/multiverse arm64 Packages [<span style=color:#3677a9>153</span> kB]
Get:7 http://ports.ubuntu.com/ubuntu-ports bionic/main arm64 Packages [<span style=color:#3677a9>1285</span> kB]
Get:8 http://ports.ubuntu.com/ubuntu-ports bionic/restricted arm64 Packages [<span style=color:#3677a9>572</span> B]
Get:9 http://ports.ubuntu.com/ubuntu-ports bionic-updates/universe arm64 Packages [<span style=color:#3677a9>1865</span> kB]
Get:10 http://ports.ubuntu.com/ubuntu-ports bionic-updates/restricted arm64 Packages [<span style=color:#3677a9>2262</span> B]
Get:11 http://ports.ubuntu.com/ubuntu-ports bionic-updates/main arm64 Packages [<span style=color:#3677a9>1431</span> kB]
Get:12 http://ports.ubuntu.com/ubuntu-ports bionic-updates/multiverse arm64 Packages [<span style=color:#3677a9>5758</span> B]
Fetched 16.1 MB in 6s (<span style=color:#3677a9>2543</span> kB/s)
Reading package lists... Error!
E: flAbsPath on /var/lib/dpkg/status failed - realpath (2: No such file or directory)
E: Could not open file  - open (2: No such file or directory)
E: Problem opening
E: The package lists or status file could not be parsed or opened.
</code></pre></div><p>Fixing the apt issues:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>mkdir -p /var/lib/dpkg/{info,alternatives}
touch /var/lib/dpkg/status
apt install apt-utils -y
</code></pre></div><p>Enjoy!</p><p>Next time we can go through how to compile a new kernel and have a different rootfs (potentially using Alpine).</p></div></div></body><footer class="mw8-l center pa4"><a href=https://github.com/l1x class=pa2><i class="fab fa-github fa-2x"></i></a><a href=https://twitter.com/lix class=pa2><i class="fab fa-twitter fa-2x"></i></a><a href=https://www.linkedin.com/in/iszukacs class=pa2><i class="fab fa-linkedin fa-2x"></i></a><a href=https://dev.to/l1x class=pa2><i class="fab fa-dev fa-2x"></i></a></footer></html>