<!doctype html><html lang=en><head><link rel=stylesheet href=/css/dosis.min.css><link rel=stylesheet href=/css/tachyons.min.css><link rel=stylesheet href=/css/style.min.css><title>l1x/dev | Why I chose Fsharp for our AWS Lambda project</title><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=apple-touch-icon sizes=57x57 href=/img/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/img/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/img/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/img/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/img/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/img/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/img/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/img/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/img/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/img/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/img/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Why I chose Fsharp for our AWS Lambda project"><meta property="og:description" content="Writing AWS Lambda functions in F#"><meta property="og:type" content="article"><meta property="og:url" content="http://dev.l1x.be/posts/2020/05/08/why-i-chose-fsharp-for-our-aws-lambda-project/"><meta property="og:image" content></head><body class="body bg-near-white"><header class="bg-dark-gray pt3"><div class="mw9 mw8-ns center ph3-ns"><div class=pa1><a href=/ class="header-logo link near-white"><div class="pr3 f2 lh-copy">l1x/dev</div></a></div><div class="pa2 tc"><a href=https://github.com/l1x class="pa2 link dim near-white">Github</a>
<a href=https://twitter.com/lix class="pa2 link dim near-white">Twitter</a>
<a href=https://www.linkedin.com/in/iszukacs/ class="pa2 link dim near-white">Linkedin</a>
<a href=https://dev.to/l1x class="pa2 link dim near-white">Dev</a></div></div></header><div class="mw9 mw8-ns center ph3-ns bg-white f5 dark-gray"><h1 id=why-i-chose-fsharp-for-our-aws-lambda-project>Why I chose Fsharp for our AWS Lambda project</h1><h2 id=the-dilema>The dilema</h2><p>I wanted to create a simple Lambda function to be able to track how our users use the website and the web application without a 3rd party and a ton of external dependencies, especially avoiding 3rd party Javascript and leaking out data to mass surveillance companies. The easiest way is to use a simple tracking 1x1 pixel or beacon that collects just the right amount of information (strictly non-PII). This gives us enough information for creating basic funnels, that covers most of our needs.</p><h2 id=first-option-python>First Option: Python</h2><p>My default language (regardless of what I am going to work on) is Python. It has many great features and it is easy to prototype in it and the performance is great once you are using a C++ or Rust backed library. This also introduces a few issues when you are trying to deploy to AWS Lambda. I develop mainly on macOS and Lambda runs on Linux. Once you need to compile anything it is hard to get it right because Python does not support compiling to a different platform.</p><p><a href>https://stackoverflow.com/questions/44490197/how-to-cross-compile-python-packages-with-pip</a></p><p>I was running into packaging issues because on Mac it is not easy to cross-compile and package Python code, maybe if I would create a proper package but I could not find a simple way without Docket. It would extremely valuable if Python had a way to compile a package that you upload to AWS and it works, 100%. I was running into problems that it was working on my Mac and did not work on AWS. I haven&rsquo;t had enough time to investigate.</p><h2 id=second-option-rust>Second Option: Rust</h2><p>Rust became the rising star over the years and I try to use it as much as possible with mixed success. My biggest problem is with Rust the low-level nature and the quirky features, that are hard to reason about. From AWS Lambda examples:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Rust data-lang=Rust><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>lambda::handler_fn;<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#069;font-weight:700>use</span><span style=color:#bbb> </span>serde_json::Value;<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#069;font-weight:700>type</span> <span style=color:#0a8;font-weight:700>Error</span><span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span><span style=color:#366>Box</span><span style=color:#555>&lt;</span>dyn<span style=color:#bbb> </span>std::error::Error<span style=color:#bbb> </span><span style=color:#555>+</span><span style=color:#bbb> </span><span style=color:#366>Send</span><span style=color:#bbb> </span><span style=color:#555>+</span><span style=color:#bbb> </span><span style=color:#366>Sync</span><span style=color:#bbb> </span><span style=color:#555>+</span><span style=color:#bbb> </span><span style=color:#366>&#39;static</span><span style=color:#555>&gt;</span>;<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#099>#[tokio::main]</span><span style=color:#bbb>
</span><span style=color:#bbb></span>async<span style=color:#bbb> </span><span style=color:#069;font-weight:700>fn</span> <span style=color:#c0f>main</span>()<span style=color:#bbb> </span>-&gt; <span style=color:#366>Result</span><span style=color:#555>&lt;</span>(),<span style=color:#bbb> </span>Error<span style=color:#555>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#069;font-weight:700>let</span><span style=color:#bbb> </span>func<span style=color:#bbb> </span><span style=color:#555>=</span><span style=color:#bbb> </span>handler_fn(func);<span style=color:#bbb>
</span><span style=color:#bbb>    </span>lambda::run(func).await<span style=color:#555>?</span>;<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#366>Ok</span>(())<span style=color:#bbb>
</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span>async<span style=color:#bbb> </span><span style=color:#069;font-weight:700>fn</span> <span style=color:#c0f>func</span>(event: <span style=color:#0a8;font-weight:700>Value</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#366>Result</span><span style=color:#555>&lt;</span>Value,<span style=color:#bbb> </span>Error<span style=color:#555>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#366>Ok</span>(event)<span style=color:#bbb>
</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></code></pre></div><p>Do you think that everybody understands immediately what is going on here? I don&rsquo;t. Even if I do, how am I going to explain this to a junior dev? How long does it take to get productive in Rust? I know that for extreme performance we might need this, but our current application is super happy without Rust, we do not have a performance problem. It is more important that developers are productive and the code is super simple to understand.</p><h2 id=and-the-winner-is-fsharp>And the winner is: Fsharp</h2><p>Member of the ML family, running on the .NET platform, pretty mature ecosystem. Developers can pick up quickly, especially the way we use it, simple functions will do with small types. The performance is great out of the box, in case you need more you have great tooling around it.</p><p>Our handler function:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Fsharp data-lang=Fsharp>  <span style=color:#069;font-weight:700>let</span> <span style=color:#033>handler</span><span style=color:#555>(</span>request<span style=color:#555>:</span>APIGatewayProxyRequest<span style=color:#555>)</span> <span style=color:#555>=</span>

    <span style=color:#069;font-weight:700>let</span> <span style=color:#033>httpResource</span> <span style=color:#555>=</span>
      <span style=color:#069;font-weight:700>match</span> isNull request<span style=color:#555>.</span>Resource <span style=color:#069;font-weight:700>with</span>
      <span style=color:#555>|</span> <span style=color:#069;font-weight:700>true</span>  <span style=color:#555>-&gt;</span> <span style=color:#c30>&#34;None&#34;</span>
      <span style=color:#555>|</span> <span style=color:#555>_</span>     <span style=color:#555>-&gt;</span> request<span style=color:#555>.</span>Resource

    <span style=color:#069;font-weight:700>let</span> <span style=color:#033>httpMethod</span> <span style=color:#555>=</span>
      <span style=color:#069;font-weight:700>match</span> isNull request<span style=color:#555>.</span>HttpMethod <span style=color:#069;font-weight:700>with</span>
      <span style=color:#555>|</span> <span style=color:#069;font-weight:700>true</span>  <span style=color:#555>-&gt;</span> <span style=color:#c30>&#34;None&#34;</span>
      <span style=color:#555>|</span> <span style=color:#555>_</span>     <span style=color:#555>-&gt;</span> request<span style=color:#555>.</span>HttpMethod

    <span style=color:#069;font-weight:700>let</span> <span style=color:#033>httpHeadersAccept</span> <span style=color:#555>=</span>
      <span style=color:#069;font-weight:700>match</span> isNull request<span style=color:#555>.</span>Headers <span style=color:#069;font-weight:700>with</span>
      <span style=color:#555>|</span> <span style=color:#069;font-weight:700>true</span>  <span style=color:#555>-&gt;</span> <span style=color:#c30>&#34;None&#34;</span>
      <span style=color:#555>|</span> <span style=color:#555>_</span>     <span style=color:#555>-&gt;</span> getOrDefault request<span style=color:#555>.</span>Headers  <span style=color:#c30>&#34;Accept&#34;</span> <span style=color:#c30>&#34;None&#34;</span>

    <span style=color:#069;font-weight:700>let</span> <span style=color:#033>acceptImage</span> <span style=color:#555>=</span>
      <span style=color:#069;font-weight:700>let</span> <span style=color:#033>pattern</span> <span style=color:#555>=</span> <span style=color:#c30>@&#34;image/&#34;</span>
      <span style=color:#069;font-weight:700>let</span> <span style=color:#033>m</span> <span style=color:#555>=</span> <span style=color:#0cf;font-weight:700>Regex</span>.Match<span style=color:#555>(</span>httpHeadersAccept<span style=color:#555>,</span> pattern<span style=color:#555>)</span>
      m<span style=color:#555>.</span>Success

    <span style=color:#069;font-weight:700>let</span> <span style=color:#033>log</span> <span style=color:#555>=</span> <span style=color:#0cf;font-weight:700>String</span>.Format<span style=color:#555>(</span><span style=color:#c30>&#34;{0} :: {1} :: {2}&#34;</span><span style=color:#555>,</span> httpResource<span style=color:#555>,</span> httpMethod<span style=color:#555>,</span> httpHeadersAccept<span style=color:#555>)</span>
    <span style=color:#0cf;font-weight:700>LambdaLogger</span>.Log<span style=color:#555>(</span>log<span style=color:#555>)</span>
    <span style=color:#069;font-weight:700>match</span> <span style=color:#555>(</span>httpResource<span style=color:#555>,</span> httpMethod<span style=color:#555>,</span> httpHeadersAccept<span style=color:#555>,</span> acceptImage<span style=color:#555>)</span> <span style=color:#069;font-weight:700>with</span>
    <span style=color:#555>|</span> <span style=color:#555>(</span><span style=color:#c30>&#34;/trck&#34;</span><span style=color:#555>,</span>         <span style=color:#c30>&#34;POST&#34;</span><span style=color:#555>,</span> <span style=color:#c30>&#34;application/json&#34;</span><span style=color:#555>,</span> <span style=color:#555>_</span>    <span style=color:#555>)</span> <span style=color:#555>-&gt;</span> trckPost<span style=color:#555>(</span>request<span style=color:#555>)</span>
    <span style=color:#555>|</span> <span style=color:#555>(</span><span style=color:#c30>&#34;/trck&#34;</span><span style=color:#555>,</span>         <span style=color:#c30>&#34;GET&#34;</span><span style=color:#555>,</span>  <span style=color:#555>_,</span>                  <span style=color:#069;font-weight:700>true</span> <span style=color:#555>)</span> <span style=color:#555>-&gt;</span> trckGet<span style=color:#555>(</span>request<span style=color:#555>)</span>
    <span style=color:#555>|</span> <span style=color:#555>(</span><span style=color:#c30>&#34;/trck/{image}&#34;</span><span style=color:#555>,</span> <span style=color:#c30>&#34;GET&#34;</span><span style=color:#555>,</span>  <span style=color:#555>_,</span>                  <span style=color:#069;font-weight:700>true</span> <span style=color:#555>)</span> <span style=color:#555>-&gt;</span> trckGet<span style=color:#555>(</span>request<span style=color:#555>)</span>
    <span style=color:#555>|</span> <span style=color:#555>(</span><span style=color:#c30>&#34;/echo&#34;</span><span style=color:#555>,</span>         <span style=color:#c30>&#34;GET&#34;</span><span style=color:#555>,</span>  <span style=color:#555>_,</span>                  <span style=color:#555>_</span>    <span style=color:#555>)</span> <span style=color:#555>-&gt;</span> echoGet<span style=color:#555>(</span>request<span style=color:#555>)</span>
    <span style=color:#555>|</span> <span style=color:#555>(_,</span>               <span style=color:#555>_,</span>      <span style=color:#555>_,</span>                  <span style=color:#555>_</span>    <span style=color:#555>)</span> <span style=color:#555>-&gt;</span> notFound<span style=color:#555>(</span>request<span style=color:#555>)</span>
</code></pre></div><p>Pretty readable code, sure, you have to deal with nulls but Fsharp gives you great tooling around it. It took me probably a couple of days from having zero experience with .NET to deploy the first working API that has all of the functionality we are looking for. I might not have idiomatic Fsharp yet, but I am happy with the results so far. In the last couple of weeks, I have written many small tools in Fsharp, mostly dealing with the AWS APIs, I like it so much that I replaced my Python first approach and I go and try to implement everything in F# first. I can develop at the same pace as with Python but the result is much more solid code and easier on deployments (goodbye pip).</p><p>I think Fsharp is exactly in the sweet spot of programming languages, good enough performance, nice enough features, and a ton of great libraries. It does not have the problem that Python suffers, you can create a single zip that will work on all platforms. It also free from exposing the low-level details that I do not want to care about in business domain code, what Rust does.</p></div></body><footer class="pa4 center bg-dark-gray v-btm"><div class="mw9 mw8-ns center ph3-ns"><div class="pt2 tc"><a href=https://github.com/l1x class="pa1 link dim near-white">Github</a>
<a href=https://twitter.com/lix class="pa1 link dim near-white">Twitter</a>
<a href=https://www.linkedin.com/in/iszukacs/ class="pa1 link dim near-white">Linkedin</a></div></div></footer></html>