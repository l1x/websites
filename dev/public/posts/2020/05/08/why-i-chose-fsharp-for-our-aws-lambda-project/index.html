<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=/css/dosis.min.css><link rel=stylesheet href=/css/tachyons.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/fontawesome.min.css><title>l1x/dev | Why I chose Fsharp for our AWS Lambda project</title><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/img/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><meta name=image property="og:image" content><meta name=title property="og:title" content="Why I chose Fsharp for our AWS Lambda project"><meta name=description property="og:description" content="Writing AWS Lambda functions in F#"><meta name=type property="og:type" content="article"><meta name=url property="og:url" content="https://dev.l1x.be/posts/2020/05/08/why-i-chose-fsharp-for-our-aws-lambda-project/"><meta name=author content="l1x"></head><body><div class="content mw8-l center pl4"><header class="flex mw8-l center pt4"><div class=pt3><img src=/img/apple-touch-icon.png width=60></div><a href=/ class="title link pl3 pt2"><h1>l1x/dev</h1></a></header><h2 class=post-title>Why I chose Fsharp for our AWS Lambda project</h2><div class=white>2020/05/08 :: #fsharp #dotnet #aws #lambda #serverless</div><div class="f4 lh-copy"><h1 id=why-i-chose-fsharp-for-our-aws-lambda-project>Why I chose Fsharp for our AWS Lambda project</h1><h2 id=the-dilema>The dilema</h2><p>I wanted to create a simple Lambda function to be able to track how our users use the website and the web application without a 3rd party and a ton of external dependencies, especially avoiding 3rd party Javascript and leaking out data to mass surveillance companies. The easiest way is to use a simple tracking 1x1 pixel or beacon that collects just the right amount of information (strictly non-PII). This gives us enough information for creating basic funnels, that covers most of our needs.</p><h2 id=first-option-python>First Option: Python</h2><p>My default language (regardless of what I am going to work on) is Python. It has many great features and it is easy to prototype in it and the performance is great once you are using a C++ or Rust backed library. This also introduces a few issues when you are trying to deploy to AWS Lambda. I develop mainly on macOS and Lambda runs on Linux. Once you need to compile anything it is hard to get it right because Python does not support compiling to a different platform.</p><p><a href>https://stackoverflow.com/questions/44490197/how-to-cross-compile-python-packages-with-pip</a></p><p>I was running into packaging issues because on Mac it is not easy to cross-compile and package Python code, maybe if I would create a proper package but I could not find a simple way without Docket. It would extremely valuable if Python had a way to compile a package that you upload to AWS and it works, 100%. I was running into problems that it was working on my Mac and did not work on AWS. I haven&rsquo;t had enough time to investigate.</p><h2 id=second-option-rust>Second Option: Rust</h2><p>Rust became the rising star over the years and I try to use it as much as possible with mixed success. My biggest problem is with Rust the low-level nature and the quirky features, that are hard to reason about. From AWS Lambda examples:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Rust data-lang=Rust><span style=color:#6ab825;font-weight:700>use</span><span style=color:#666> </span>lambda::handler_fn;<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>use</span><span style=color:#666> </span>serde_json::Value;<span style=color:#666>
</span><span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>type</span> <span style=color:#447fcf;text-decoration:underline>Error</span><span style=color:#666> </span>=<span style=color:#666> </span><span style=color:#24909d>Box</span>&lt;dyn<span style=color:#666> </span>std::error::Error<span style=color:#666> </span>+<span style=color:#666> </span><span style=color:#24909d>Send</span><span style=color:#666> </span>+<span style=color:#666> </span><span style=color:#24909d>Sync</span><span style=color:#666> </span>+<span style=color:#666> </span><span style=color:#24909d>&#39;static</span>&gt;;<span style=color:#666>
</span><span style=color:#666>
</span><span style=color:#666></span><span style=color:#cd2828;font-weight:700>#[tokio::main]</span><span style=color:#666>
</span><span style=color:#666></span>async<span style=color:#666> </span><span style=color:#6ab825;font-weight:700>fn</span> <span style=color:#447fcf>main</span>()<span style=color:#666> </span>-&gt; <span style=color:#24909d>Result</span>&lt;(),<span style=color:#666> </span>Error&gt;<span style=color:#666> </span>{<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>let</span><span style=color:#666> </span>func<span style=color:#666> </span>=<span style=color:#666> </span>handler_fn(func);<span style=color:#666>
</span><span style=color:#666>    </span>lambda::run(func).await?;<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#24909d>Ok</span>(())<span style=color:#666>
</span><span style=color:#666></span>}<span style=color:#666>
</span><span style=color:#666>
</span><span style=color:#666></span>async<span style=color:#666> </span><span style=color:#6ab825;font-weight:700>fn</span> <span style=color:#447fcf>func</span>(event: <span style=color:#447fcf;text-decoration:underline>Value</span>)<span style=color:#666> </span>-&gt; <span style=color:#24909d>Result</span>&lt;Value,<span style=color:#666> </span>Error&gt;<span style=color:#666> </span>{<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#24909d>Ok</span>(event)<span style=color:#666>
</span><span style=color:#666></span>}<span style=color:#666>
</span></code></pre></div><p>Do you think that everybody understands immediately what is going on here? I don&rsquo;t. Even if I do, how am I going to explain this to a junior dev? How long does it take to get productive in Rust? I know that for extreme performance we might need this, but our current application is super happy without Rust, we do not have a performance problem. It is more important that developers are productive and the code is super simple to understand.</p><h2 id=and-the-winner-is-fsharp>And the winner is: Fsharp</h2><p>Member of the ML family, running on the .NET platform, pretty mature ecosystem. Developers can pick up quickly, especially the way we use it, simple functions will do with small types. The performance is great out of the box, in case you need more you have great tooling around it.</p><p>Our handler function:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Fsharp data-lang=Fsharp>  <span style=color:#6ab825;font-weight:700>let</span> <span style=color:#40ffff>handler</span>(request:APIGatewayProxyRequest) =

    <span style=color:#6ab825;font-weight:700>let</span> <span style=color:#40ffff>httpResource</span> =
      <span style=color:#6ab825;font-weight:700>match</span> isNull request.Resource <span style=color:#6ab825;font-weight:700>with</span>
      | <span style=color:#6ab825;font-weight:700>true</span>  -&gt; <span style=color:#ed9d13>&#34;None&#34;</span>
      | _     -&gt; request.Resource

    <span style=color:#6ab825;font-weight:700>let</span> <span style=color:#40ffff>httpMethod</span> =
      <span style=color:#6ab825;font-weight:700>match</span> isNull request.HttpMethod <span style=color:#6ab825;font-weight:700>with</span>
      | <span style=color:#6ab825;font-weight:700>true</span>  -&gt; <span style=color:#ed9d13>&#34;None&#34;</span>
      | _     -&gt; request.HttpMethod

    <span style=color:#6ab825;font-weight:700>let</span> <span style=color:#40ffff>httpHeadersAccept</span> =
      <span style=color:#6ab825;font-weight:700>match</span> isNull request.Headers <span style=color:#6ab825;font-weight:700>with</span>
      | <span style=color:#6ab825;font-weight:700>true</span>  -&gt; <span style=color:#ed9d13>&#34;None&#34;</span>
      | _     -&gt; getOrDefault request.Headers  <span style=color:#ed9d13>&#34;Accept&#34;</span> <span style=color:#ed9d13>&#34;None&#34;</span>

    <span style=color:#6ab825;font-weight:700>let</span> <span style=color:#40ffff>acceptImage</span> =
      <span style=color:#6ab825;font-weight:700>let</span> <span style=color:#40ffff>pattern</span> = <span style=color:#ed9d13>@&#34;image/&#34;</span>
      <span style=color:#6ab825;font-weight:700>let</span> <span style=color:#40ffff>m</span> = <span style=color:#447fcf;text-decoration:underline>Regex</span>.Match(httpHeadersAccept, pattern)
      m.Success

    <span style=color:#6ab825;font-weight:700>let</span> <span style=color:#40ffff>log</span> = <span style=color:#447fcf;text-decoration:underline>String</span>.Format(<span style=color:#ed9d13>&#34;{0} :: {1} :: {2}&#34;</span>, httpResource, httpMethod, httpHeadersAccept)
    <span style=color:#447fcf;text-decoration:underline>LambdaLogger</span>.Log(log)
    <span style=color:#6ab825;font-weight:700>match</span> (httpResource, httpMethod, httpHeadersAccept, acceptImage) <span style=color:#6ab825;font-weight:700>with</span>
    | (<span style=color:#ed9d13>&#34;/trck&#34;</span>,         <span style=color:#ed9d13>&#34;POST&#34;</span>, <span style=color:#ed9d13>&#34;application/json&#34;</span>, _    ) -&gt; trckPost(request)
    | (<span style=color:#ed9d13>&#34;/trck&#34;</span>,         <span style=color:#ed9d13>&#34;GET&#34;</span>,  _,                  <span style=color:#6ab825;font-weight:700>true</span> ) -&gt; trckGet(request)
    | (<span style=color:#ed9d13>&#34;/trck/{image}&#34;</span>, <span style=color:#ed9d13>&#34;GET&#34;</span>,  _,                  <span style=color:#6ab825;font-weight:700>true</span> ) -&gt; trckGet(request)
    | (<span style=color:#ed9d13>&#34;/echo&#34;</span>,         <span style=color:#ed9d13>&#34;GET&#34;</span>,  _,                  _    ) -&gt; echoGet(request)
    | (_,               _,      _,                  _    ) -&gt; notFound(request)
</code></pre></div><p>Pretty readable code, sure, you have to deal with nulls but Fsharp gives you great tooling around it. It took me probably a couple of days from having zero experience with .NET to deploy the first working API that has all of the functionality we are looking for. I might not have idiomatic Fsharp yet, but I am happy with the results so far. In the last couple of weeks, I have written many small tools in Fsharp, mostly dealing with the AWS APIs, I like it so much that I replaced my Python first approach and I go and try to implement everything in F# first. I can develop at the same pace as with Python but the result is much more solid code and easier on deployments (goodbye pip).</p><p>I think Fsharp is exactly in the sweet spot of programming languages, good enough performance, nice enough features, and a ton of great libraries. It does not have the problem that Python suffers, you can create a single zip that will work on all platforms. It also free from exposing the low-level details that I do not want to care about in business domain code, what Rust does.</p></div></div></body><footer class="mw8-l center pa4"><a href=https://github.com/l1x class=pa2><i class="fab fa-github fa-2x"></i></a><a href=https://twitter.com/lix class=pa2><i class="fab fa-twitter fa-2x"></i></a><a href=https://www.linkedin.com/in/iszukacs class=pa2><i class="fab fa-linkedin fa-2x"></i></a><a href=https://dev.to/l1x class=pa2><i class="fab fa-dev fa-2x"></i></a></footer></html>