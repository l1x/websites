<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=/css/dosis.min.css><link rel=stylesheet href=/css/tachyons.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/fontawesome.min.css><title>l1x/dev | Running ASP.Net web application with Falco on AWS Lambda</title><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/img/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><meta name=image property="og:image" content><meta name=title property="og:title" content="Running ASP.Net web application with Falco on AWS Lambda"><meta name=description property="og:description" content="F# is a mature, open source, cross-platform, functional-first programming language. It empowers users and organizations to tackle complex computing problems with simple, maintainable and robust code."><meta name=type property="og:type" content="article"><meta name=url property="og:url" content="https://dev.l1x.be/posts/2020/12/18/running-asp.net-web-application-with-falco-on-aws-lambda/"><meta name=author content="l1x"></head><body><div class="content mw8-l center pl4"><header class="flex mw8-l center pt4"><div class=pt3><img src=/img/apple-touch-icon.png width=60 alt=apple-touch-icon></div><a href=/ class="title link pl3 pt2"><h1>l1x/dev</h1></a></header><h2 class=post-title>Running ASP.Net web application with Falco on AWS Lambda</h2><div class=gray>2020/12/18 :: #serverless #dotnet #.net #fsharp #aws #lambda #falco #asp #asp.net</div><div class=toc><nav id=TableOfContents><ol><li><a href=#intro>Intro</a></li><li><a href=#getting-aspnet--falco-running-locally-with-a-simple-web-application>Getting ASP.Net & Falco running locally with a simple web application</a><ol><li><a href=#introducing-falco>Introducing Falco</a></li><li><a href=#hello-world-from-local-falco>Hello World from local Falco</a></li><li><a href=#adding-a-route>Adding a route</a></li></ol></li><li><a href=#deploying-to-aws-lambda>Deploying to AWS Lambda</a><ol><li><a href=#aws-infrastructure-prerequisites>AWS infrastructure prerequisites</a></li><li><a href=#configuring-a-lambda-compatible-net-version>Configuring a Lambda compatible .Net version</a></li><li><a href=#adapt-the-f-project-for-use-with-aws-sam-tools>Adapt the F# project for use with AWS SAM tools</a></li><li><a href=#modify-the-program-for-lambda-compatibility>Modify the program for Lambda compatibility</a></li><li><a href=#setting-up-the-deployment-configuration>Setting up the deployment configuration</a></li></ol></li><li><a href=#conclusion>Conclusion</a></li></ol></nav></div><div class="f4 lh-copy"><h2 id=intro>Intro</h2><p>This article has been written by Gabor Gergely (kodfodrasz) as a guest post on this blog. He is the lead engineer of our engineering organization working on F#, AWS and Elm.</p><p>We have been using AWS Lambda with F# for a while and have some experience with it. Until now, we opted to use the plain AWS Lambda .Net Runtime provided by Amazon because we value simplicity and code being transparent so we can reason about its operation. This is also why we opted for using F#, as it provides a sweet spot in a simple to reason about functional code and rich features provided by the .Net Framework, all with good performance for our use case.</p><p>Still, we have met some pain points with developing for and running on AWS Lambda:</p><p>One is that the edit-compile-run loop takes a very long time as it involves deployment to Lambda. Testing and interactive debugging are really slow this way. To overcome this, one needs an emulator environment for the Lambda Runtime. Developing one is additional maintenance overhead, so the lookout for a suitable out-of-the-box solution became a background task in my mind.</p><p>While reading comments about the announcement of F# 5.0, I found out about the Falco framework, which is a functional-first Asp.Net Core framework. I wondered whether opting for and Asp.Net hosting in Lambda could provide a setup to allow simple local/CI execution while also providing a mostly similar hosting environment in AWS Lambda&mldr; so I started to build an experimental setup to evaluate the idea.</p><p>The experiment has the main steps:</p><ol><li>Getting ASP.Net & Falco running locally with a simple web application</li><li>Deploying to AWS Lambda</li><li>Using .Net 5.0 in AWS Lambda</li></ol><h2 id=getting-aspnet--falco-running-locally-with-a-simple-web-application>Getting ASP.Net & Falco running locally with a simple web application</h2><h3 id=introducing-falco>Introducing Falco</h3><p><a href=https://www.falcoframework.com/>Falco Framework</a> is an F# web application framework, based on ASP.Net Core. It is still a work in progress, but its minimalism and non-intrusive API made it really sympathetic for me. I have checked out some other F# web frameworks, but this is the first, which feels cleaner and more straightforward than only using ASP.Net the same object-oriented way I used it from C# in the past.</p><h3 id=hello-world-from-local-falco>Hello World from local Falco</h3><p>First, let&rsquo;s create a simple sample app to test the hosting setup. Let&rsquo;s stick to the <a href=https://www.falcoframework.com/#getting-started>Falco&rsquo;s Getting Started Guide</a>.</p><p>Let&rsquo;s create the official HelloWorld application!</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh>dotnet new -i <span style=color:#4e9a06>&#34;Falco.Template::*&#34;</span>
dotnet new falco -o HelloFalco
</code></pre></div><p>This installs the Falco templates, then creates a project in the <code>HelloFalco</code> directory based on the <code>falco</code> template just installed.</p><p>I usually use Visual Studio, so adding a solution for the project is also a good idea (for me).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh>dotnet new solution -n HelloFalco
dotnet sln add HelloFalco
</code></pre></div><p>Now I can simply open the solution and check the <code>Program.fs</code> file. For now, we simply stick to the contents in the template.</p><p>Let&rsquo;s start it! If using Visual Studio choose the HelloWordApp from the run configurations to use the Kestrel based hosting instead of IIS Express.</p><p><img src=/img/advent_article_part1-run_config.jpg alt="Where to select that run configuration"></p><p>Now you should see something like this:</p><p><img src=/img/advent_article_part1-it_runs.jpg alt="It runs!"></p><h3 id=adding-a-route>Adding a route</h3><p>Before we move on to the next phase, let&rsquo;s add another – parameterized – route from the Falco examples. This will be used to validate the hosting setup in the next phase. The complete program is still very compact, looks as follows:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fsharp data-lang=fsharp><span style=color:#204a87;font-weight:700>module</span> <span style=color:#000>HelloFalco.Program</span>

<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Falco</span>
<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Falco.Routing</span>
<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Falco.HostBuilder</span>
<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Microsoft.AspNetCore.Builder</span>
<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Microsoft.AspNetCore.Hosting</span>
<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Microsoft.Extensions.DependencyInjection</span>

<span style=color:#8f5902;font-style:italic>// ------------
</span><span style=color:#8f5902;font-style:italic>// Register services
</span><span style=color:#8f5902;font-style:italic>// ------------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>configureServices</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>services</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>IServiceCollection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#000>services</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>AddFalco</span><span style=color:#3465a4>()</span> <span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>ignore</span>

<span style=color:#8f5902;font-style:italic>// ------------
</span><span style=color:#8f5902;font-style:italic>// Activate middleware
</span><span style=color:#8f5902;font-style:italic>// ------------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>configureApp</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoints</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>HttpEndpoint</span> <span style=color:#204a87;font-weight:700>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>WebHostBuilderContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>app</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>IApplicationBuilder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>devMode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>StringUtils</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>strEquals</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>HostingEnvironment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>EnvironmentName</span> <span style=color:#4e9a06>&#34;Development&#34;</span>
    <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>UseWhen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>devMode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>fun</span> <span style=color:#000>app</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>UseDeveloperExceptionPage</span><span style=color:#3465a4>()</span><span style=color:#ce5c00;font-weight:700>)</span>
       <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>UseWhen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>not</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>devMode</span><span style=color:#ce5c00;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>fun</span> <span style=color:#000>app</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
            <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>UseFalcoExceptionHandler</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Response</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>withStatusCode</span> <span style=color:#000>500</span> <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>Response</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ofPlainText</span> <span style=color:#4e9a06>&#34;Server error&#34;</span><span style=color:#ce5c00;font-weight:700>))</span>
       <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>UseFalco</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>ignore</span>

<span style=color:#8f5902;font-style:italic>// -----------
</span><span style=color:#8f5902;font-style:italic>// Configure Web host
</span><span style=color:#8f5902;font-style:italic>// -----------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>configureWebHost</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoints</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>HttpEndpoint</span> <span style=color:#204a87;font-weight:700>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>webHost</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>IWebHostBuilder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#000>webHost</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ConfigureServices</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configureServices</span><span style=color:#ce5c00;font-weight:700>)</span>
        <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Configure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configureApp</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>helloHandler</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>HttpHandler</span> <span style=color:#ce5c00;font-weight:700>=</span>
  <span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>getMessage</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>route</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>RouteCollectionReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#000>route</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>GetString</span> <span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#4e9a06>&#34;stranger&#34;</span>
    <span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>sprintf</span> <span style=color:#4e9a06>&#34;Hello %s!&#34;</span>

  <span style=color:#000>Request</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mapRoute</span> <span style=color:#000>getMessage</span> <span style=color:#000>Response</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ofPlainText</span>

<span style=color:#ce5c00;font-weight:700>[&lt;</span><span style=color:#000>EntryPoint</span><span style=color:#ce5c00;font-weight:700>&gt;]</span>
<span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>main</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>=</span>
  <span style=color:#000>webHost</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>configure</span> <span style=color:#000>configureWebHost</span>

    <span style=color:#000>endpoints</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>get</span> <span style=color:#4e9a06>&#34;/&#34;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Response</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ofPlainText</span> <span style=color:#4e9a06>&#34;Hello world&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
                <span style=color:#000>get</span> <span style=color:#4e9a06>&#34;/hello/{name?}&#34;</span> <span style=color:#000>helloHandler</span> <span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>0</span>
</code></pre></div><p>Its operation can be quickly verified with cURL.</p><p><img src=/img/advent_article_part1_additional_routes.jpg alt="Image of locally running service responding to queries as expected"></p><p>It runs and responds as expected. 🎉👏</p><p>Ok, nothing extraordinary yet. We managed to start a vanilla demo template then extended it with some other demo code. Time for something more interesting.</p><h2 id=deploying-to-aws-lambda>Deploying to AWS Lambda</h2><p>We have managed to reproduce the official Falco tutorial so far. As mentioned earlier, we are actively using AWS Lambda, so now I will show how to deploy a Falco application to Lambda!</p><p>For this, I will be using <a href=https://docs.aws.amazon.com/serverless-application-model/>AWS Serverless Application Model</a>, with its .Net tooling.
I have also used some AWS Lambda function templates as a basis for the configuration files I will present below. All of these can be installed using the dotnet command.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh>dotnet tool install -g Amazon.Lambda.Tools
dotnet new -i <span style=color:#4e9a06>&#34;Amazon.Lambda.Templates::*&#34;</span>
</code></pre></div><p>The template I used is the <code>serverless.AspNetCoreWebAPI</code> one. I interested you can check it out with <code>dotnet new serverless.AspNetCoreWebAPI --language F# --name HelloServerlessAsp</code>.</p><h3 id=aws-infrastructure-prerequisites>AWS infrastructure prerequisites</h3><p>Deployment to Lambda using AWS SAM needs a bucket for the storage of the packaged Lambda functions. Assuming your AWS CLI is installed and your credentials are configured, it is a straightforward command to create it. I created the bucket <code>lambda.kodfodrasz.net</code> using my default credentials in the region closest to me.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh>aws s3api create-bucket --bucket lambda.kodfodrasz.net --acl private --create-bucket-configuration <span style=color:#000>LocationConstraint</span><span style=color:#ce5c00;font-weight:700>=</span>eu-central-1
</code></pre></div><h3 id=configuring-a-lambda-compatible-net-version>Configuring a Lambda compatible .Net version</h3><p>As of writing this article .Net 5.0 has been recently released. However, it is not supported out-of-the-box officially by Amazon, though workarounds exist.
I have .Net 5.0 installed on my machine, which would result in the app targeting this version, unless configured, which would ultimately result in runtime failures at Lambda invocation time.</p><p>To prevent the problems, we must adjust the version settings to target the latest supported runtime version in AWS Lambda: .Net Core 3.1.</p><p>First, let&rsquo;s retarget the <code>HelloFalco.fsproj</code> project, to contain <code>&lt;TargetFramework>netcoreapp3.1&lt;/TargetFramework></code>.</p><p>Second, a <code>global.json</code> file needs to be added and set up to prevent <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/global-json?tabs=netcore3x#rollforward">automatic version <em>roll forward</em></a>. Add the <code>global.json</code> file to the root of the projects (the solution directory).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;sdk&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;version&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;3.1.100&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;rollForward&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;latestMinor&#34;</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=adapt-the-f-project-for-use-with-aws-sam-tools>Adapt the F# project for use with AWS SAM tools</h3><p>The Amazon Serverless templates have some special fields set up in their project file. We should add these to ensure Amazon tools handle the project properly.</p><p>Also, we will need an additional NuGet package, an adapter between the Lambda runtime and ASP.Net. You could add it using the command <code>dotnet add package Amazon.Lambda.AspNetCoreServer</code>, but I simply tuned the <code>HelloFalco.fsproj</code> to include these changes mentioned.</p><p>However, this is not enough. We need to add the AWS Lambda facette to the Falco project file <code>HelloFalco.fsproj</code> as well:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=color:#204a87;font-weight:700>&lt;Project</span> <span style=color:#c4a000>Sdk=</span><span style=color:#4e9a06>&#34;Microsoft.NET.Sdk.Web&#34;</span><span style=color:#204a87;font-weight:700>&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;PropertyGroup&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;TargetFramework&gt;</span>netcoreapp3.1<span style=color:#204a87;font-weight:700>&lt;/TargetFramework&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- The next three properties were copied from the AWS Serverless template to ensure tooling compatibility (along with the next comment). --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;GenerateRuntimeConfigurationFiles&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/GenerateRuntimeConfigurationFiles&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;AWSProjectType&gt;</span>Lambda<span style=color:#204a87;font-weight:700>&lt;/AWSProjectType&gt;</span>

    <span style=color:#8f5902;font-style:italic>&lt;!-- This property makes the build directory similar to a publish directory and helps the AWS .NET Lambda Mock Test Tool find project dependencies. --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;CopyLocalLockFileAssemblies&gt;</span>true<span style=color:#204a87;font-weight:700>&lt;/CopyLocalLockFileAssemblies&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/PropertyGroup&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;ItemGroup&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;Compile</span> <span style=color:#c4a000>Include=</span><span style=color:#4e9a06>&#34;Program.fs&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/ItemGroup&gt;</span>

  <span style=color:#204a87;font-weight:700>&lt;ItemGroup&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;PackageReference</span> <span style=color:#c4a000>Include=</span><span style=color:#4e9a06>&#34;Falco&#34;</span> <span style=color:#c4a000>Version=</span><span style=color:#4e9a06>&#34;3.0.*&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
    <span style=color:#8f5902;font-style:italic>&lt;!-- Contains the adapter between AWS Lambda Runtime and ASP.Net Core --&gt;</span>
    <span style=color:#204a87;font-weight:700>&lt;PackageReference</span> <span style=color:#c4a000>Include=</span><span style=color:#4e9a06>&#34;Amazon.Lambda.AspNetCoreServer&#34;</span> <span style=color:#c4a000>Version=</span><span style=color:#4e9a06>&#34;5.2.0&#34;</span> <span style=color:#204a87;font-weight:700>/&gt;</span>
  <span style=color:#204a87;font-weight:700>&lt;/ItemGroup&gt;</span>
<span style=color:#204a87;font-weight:700>&lt;/Project&gt;</span>
</code></pre></div><h3 id=modify-the-program-for-lambda-compatibility>Modify the program for Lambda compatibility</h3><p>At this point, the program can be compiled and packaged for deployment to AWS. Before finalizing the other deployment configuration files, we need to change the program and support being hosted locally by Kestrel and in the cloud by the Lambda Runtime.</p><p>The modification needed:</p><ul><li>Move the endpoints to an outer scope, to be reachable from both hosting setup code.
Both setups should use this.</li><li>Add a hosting setup for Lambda, and use the same configuration code as the local setup.</li></ul><p>The modified code is still pretty compact and straightforward (but I added some additional comments for easy navigability):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fsharp data-lang=fsharp><span style=color:#204a87;font-weight:700>module</span> <span style=color:#000>HelloFalco.Program</span>

<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Falco</span>
<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Falco.Routing</span>
<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Falco.HostBuilder</span>
<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Microsoft.AspNetCore.Builder</span>
<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Microsoft.AspNetCore.Hosting</span>
<span style=color:#204a87;font-weight:700>open</span> <span style=color:#000>Microsoft.Extensions.DependencyInjection</span>

<span style=color:#8f5902;font-style:italic>// =============
</span><span style=color:#8f5902;font-style:italic>// The endpoints
</span><span style=color:#8f5902;font-style:italic>// =============
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>helloHandler</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>HttpHandler</span> <span style=color:#ce5c00;font-weight:700>=</span>
  <span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>getMessage</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>route</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>RouteCollectionReader</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#000>route</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>GetString</span> <span style=color:#4e9a06>&#34;name&#34;</span> <span style=color:#4e9a06>&#34;stranger&#34;</span>
    <span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>sprintf</span> <span style=color:#4e9a06>&#34;Hello %s!&#34;</span>

  <span style=color:#000>Request</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mapRoute</span> <span style=color:#000>getMessage</span> <span style=color:#000>Response</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ofPlainText</span>

<span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>endpointList</span> <span style=color:#ce5c00;font-weight:700>=</span>
  <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#000>get</span> <span style=color:#4e9a06>&#34;/&#34;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Response</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ofPlainText</span> <span style=color:#4e9a06>&#34;Hello world&#34;</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#000>get</span> <span style=color:#4e9a06>&#34;/hello/{name?}&#34;</span> <span style=color:#000>helloHandler</span> <span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#8f5902;font-style:italic>// ===========================
</span><span style=color:#8f5902;font-style:italic>// Common initializaition code
</span><span style=color:#8f5902;font-style:italic>// ===========================
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>// ------------
</span><span style=color:#8f5902;font-style:italic>// Register services
</span><span style=color:#8f5902;font-style:italic>// ------------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>configureServices</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>services</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>IServiceCollection</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>services</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>AddFalco</span><span style=color:#3465a4>()</span> <span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>ignore</span>

<span style=color:#8f5902;font-style:italic>// ------------
</span><span style=color:#8f5902;font-style:italic>// Activate middleware
</span><span style=color:#8f5902;font-style:italic>// ------------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>configureApp</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>HttpEndpoint</span> <span style=color:#204a87;font-weight:700>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>WebHostBuilderContext</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>IApplicationBuilder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span>
  <span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>devMode</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#000>StringUtils</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>strEquals</span> <span style=color:#000>ctx</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>HostingEnvironment</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>EnvironmentName</span> <span style=color:#4e9a06>&#34;Development&#34;</span>

  <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>UseWhen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>devMode</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>fun</span> <span style=color:#000>app</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>UseDeveloperExceptionPage</span><span style=color:#3465a4>()</span><span style=color:#ce5c00;font-weight:700>))</span>
     <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>UseWhen</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>not</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>devMode</span><span style=color:#ce5c00;font-weight:700>),</span>
              <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>fun</span> <span style=color:#000>app</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
                <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>UseFalcoExceptionHandler</span>
                  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Response</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>withStatusCode</span> <span style=color:#000>500</span>
                   <span style=color:#ce5c00;font-weight:700>&gt;&gt;</span> <span style=color:#000>Response</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ofPlainText</span> <span style=color:#4e9a06>&#34;Server error&#34;</span><span style=color:#ce5c00;font-weight:700>))).</span><span style=color:#000>UseHttpsRedirection</span><span style=color:#3465a4>()</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>UseFalco</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>ignore</span>

<span style=color:#8f5902;font-style:italic>// =======================
</span><span style=color:#8f5902;font-style:italic>// AWS Lambda Startup code
</span><span style=color:#8f5902;font-style:italic>// =======================
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>// Lambda entry point
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>LambdaEntryPoint</span><span style=color:#3465a4>()</span> <span style=color:#ce5c00;font-weight:700>=</span>

  <span style=color:#8f5902;font-style:italic>// The base class must be set to match the AWS service invoking the Lambda function. If not Amazon.Lambda.AspNetCoreServer
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// will fail to convert the incoming request correctly into a valid ASP.NET Core request.
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// API Gateway REST API                         -&gt; Amazon.Lambda.AspNetCoreServer.APIGatewayProxyFunction
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// API Gateway HTTP API payload version 1.0     -&gt; Amazon.Lambda.AspNetCoreServer.APIGatewayProxyFunction
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// API Gateway HTTP API payload version 2.0     -&gt; Amazon.Lambda.AspNetCoreServer.APIGatewayHttpApiV2ProxyFunction
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Application Load Balancer                    -&gt; Amazon.Lambda.AspNetCoreServer.ApplicationLoadBalancerFunction
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// Note: When using the AWS::Serverless::Function resource with an event type of &#34;HttpApi&#34; then payload version 2.0
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#8f5902;font-style:italic>// will be the default and you must make Amazon.Lambda.AspNetCoreServer.APIGatewayHttpApiV2ProxyFunction the base class.
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>inherit</span> <span style=color:#000>Amazon</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Lambda</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AspNetCoreServer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>APIGatewayProxyFunction</span><span style=color:#3465a4>()</span>

  <span style=color:#204a87;font-weight:700>override</span> <span style=color:#000>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Init</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>builder</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>IWebHostBuilder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#000>builder</span>
      <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ConfigureServices</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configureServices</span><span style=color:#ce5c00;font-weight:700>)</span>
      <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Configure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configureApp</span> <span style=color:#000>endpointList</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>ignore</span>


<span style=color:#8f5902;font-style:italic>// -----------
</span><span style=color:#8f5902;font-style:italic>// Configure Web host
</span><span style=color:#8f5902;font-style:italic>// -----------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>configureWebHost</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>HttpEndpoint</span> <span style=color:#204a87;font-weight:700>list</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>webHost</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>IWebHostBuilder</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span>
  <span style=color:#000>webHost</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ConfigureServices</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configureServices</span><span style=color:#ce5c00;font-weight:700>)</span>
    <span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Configure</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>configureApp</span> <span style=color:#000>endpoints</span><span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic>// ==========================
</span><span style=color:#8f5902;font-style:italic>// Local Kestrel startup code
</span><span style=color:#8f5902;font-style:italic>// ==========================
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#8f5902;font-style:italic>// Local execution entry point
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>[&lt;</span><span style=color:#000>EntryPoint</span><span style=color:#ce5c00;font-weight:700>&gt;]</span>
<span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>main</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>=</span>
  <span style=color:#000>webHost</span> <span style=color:#000>args</span> <span style=color:#ce5c00;font-weight:700>{</span>
    <span style=color:#000>configure</span> <span style=color:#000>configureWebHost</span>
    <span style=color:#000>endpoints</span> <span style=color:#000>endpointList</span>
  <span style=color:#ce5c00;font-weight:700>}</span>
  <span style=color:#000>0</span>
</code></pre></div><p>One thing to note is the common <code>UseStartup&lt;Startup>()</code> pattern is not used here. I initially tried that pattern, but it didn&rsquo;t fit seamlessly with the initialization model of Falco. The way I finally settled with is pretty straightforward and convenient, and totally native from both Falco, and vanilla ASP.Net Core.</p><p>We can try this code locally, and it will still work just as before.</p><h3 id=setting-up-the-deployment-configuration>Setting up the deployment configuration</h3><p>The final step before deployment is to define the deployment configuration for the SAM tools. We need to add two config files to the project directory.</p><p>First, add <code>aws-lambda-tools-defaults.json</code>. This file defines some defaults for the <code>dotnet lambda</code> command family. The deployment bucket created earlier is needed here. I specified my bucket, <code>lambda.kodfodrasz.net</code>. Also, an <em>S3 prefix</em> is needed, where the data related to this app will be stored. I simply used <code>HelloFalco</code>.</p><p>Also, we need to define a <em>stack name</em>, which is used to group the resources related to the Lambda function, for example, the API gateway settings. I chose the name <code>HelloFalco</code>.
If you don&rsquo;t want to use your default profile and region, you can also do so. Otherwise, leave the fields as empty strings.</p><p>Overall my config <code>aws-lambda-tools-defaults.json</code> looks like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;Information&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#4e9a06>&#34;This file provides default values for the deployment wizard inside Visual Studio and the AWS Lambda commands added to the .NET Core CLI.&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#4e9a06>&#34;To learn more about the Lambda commands with the .NET Core CLI execute the following command at the command line in the project root directory.&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#4e9a06>&#34;dotnet lambda help&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#4e9a06>&#34;All the command line options for the Lambda command can be specified in this file.&#34;</span>
  <span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;profile&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;region&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;configuration&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Release&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;framework&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;netcoreapp3.1&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;s3-prefix&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;HelloFalco&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;template&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;serverless.template&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;template-parameters&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;stack-name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;HelloFalco&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;s3-bucket&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;lambda.kodfodrasz.net&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>This file references a <em>template</em>, <code>serverless.template</code>. That will be the second config file we will need to create.
I copied this file over from the <code>serverless.AspNetCoreWebAPI</code> project template, and have tweaked it a bit.</p><p>The most important field is the <code>Handler</code> item, the entry point where the AWS Lambda Runtime invokes our code. I have the following structure:</p><p><code>&lt;assembly name>::&lt;handler class fully qualified name>::&lt;handler method></code>. In our case:</p><ul><li>The assembly name is <code>HelloFalco</code></li><li>The handler class FQN is <code>HelloFalco.Program+LambdaEntryPoint</code>. This means that it is an inner class (<code>LambdaEntryPoint</code>) of the (static) class <code>Program</code> in the <code>HelloFalco</code> namespace.
If you need to know more about F# and plain CLR interop, I suggest the great reads <a href=https://fsharpforfunandprofit.com/posts/classes/#tip-defining-classes-for-use-by-other-net-code>F# for Fun and profit about Classes</a> by <a href=https://twitter.com/ScottWlaschin>Scott Wlaschin</a> and <a href=https://connelhooley.uk/blog/2017/04/30/f-sharp-to-c-sharp>Calling F# Code in a C# Project</a> by <a href=https://twitter.com/connel_dev>Connel Hooley</a>.</li></ul><p>The other important part is <code>Events</code>, which sets up the API Gateway events to be forwarded to the app. This setup basically forwards everything, and all routing is up to Falco/ASP.Net.
This is the main difference from our current Lambda setup (with regards to routing), as we are using the API Gateway for route part matching, and are simply using the matched parts from the Lambda Event in the raw Lambda setup we currently have.</p><p>The <code>Policies</code> point is also important, it contains the IAM Policies applied to the web application. In this example I replaced the original template&rsquo;s <code>AWSLambdaFullAccess</code> with an almost completely constrained <code>AWSLambdaBasicExecutionRole</code>, which should still suffice for this example.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;AWSTemplateFormatVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;2010-09-09&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;Transform&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AWS::Serverless-2016-10-31&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;Description&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;An AWS Serverless Application that uses the ASP.NET Core framework running in Amazon Lambda.&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;Parameters&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{},</span>
  <span style=color:#204a87;font-weight:700>&#34;Resources&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;AspNetCoreFunction&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;Type&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AWS::Serverless::Function&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;Properties&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;Handler&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;HelloFalco::HelloFalco.Program+LambdaEntryPoint::FunctionHandlerAsync&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;Runtime&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;dotnetcore3.1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;CodeUri&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;MemorySize&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>256</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;Timeout&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;Role&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#204a87;font-weight:700>&#34;Policies&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;AWSLambdaBasicExecutionRole&#34;</span><span style=color:#000;font-weight:700>],</span>
        <span style=color:#204a87;font-weight:700>&#34;Environment&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;Variables&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{}</span>
        <span style=color:#000;font-weight:700>},</span>
        <span style=color:#204a87;font-weight:700>&#34;Events&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>&#34;ProxyResource&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;Type&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Api&#34;</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>&#34;Properties&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>&#34;Path&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;/{proxy+}&#34;</span><span style=color:#000;font-weight:700>,</span>
              <span style=color:#204a87;font-weight:700>&#34;Method&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ANY&#34;</span>
            <span style=color:#000;font-weight:700>}</span>
          <span style=color:#000;font-weight:700>},</span>
          <span style=color:#204a87;font-weight:700>&#34;RootResource&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;Type&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Api&#34;</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>&#34;Properties&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
              <span style=color:#204a87;font-weight:700>&#34;Path&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#000;font-weight:700>,</span>
              <span style=color:#204a87;font-weight:700>&#34;Method&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ANY&#34;</span>
            <span style=color:#000;font-weight:700>}</span>
          <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#204a87;font-weight:700>&#34;Outputs&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;ApiURL&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;Description&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;API endpoint URL for Prod environment&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;Value&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;Fn::Sub&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/&#34;</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>We can try to deploy out setup now.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#204a87>cd</span> HelloFalco
dotnet lambda deploy-serverless
</code></pre></div><p>If we cURL onto the path displayed at the end of the successful deployment, we can see that Falco does indeed work in AWS Lambda.</p><p><img src=/img/advent_article_part2-hello_serverless.jpg alt="Falco responding successfully from AWS Lambda"></p><h2 id=conclusion>Conclusion</h2><p>In the example above we have seen how to adapt a Falco based ASP.Net Core web application for hosting in AWS Lambda. AWS Lambda is not fit for every usecase, but if suits your usecase, it can be a cheapest way to host a low traffic web application, with minimal maintenance burden, and fine grained security.</p><p>I have evaluated the maintainability effects of supporting both local/self-hosted and AWS Lambda hosted execution models at the same time, and I came to the conclusion that it has a minimal overhead. This has the potential to improve the testability of our services in the partially-integrated setups in the CI pipeline, with minimal programmer effort. Also this could help to more easily track down some types of problems by executing the app in local debugger, with confidence in the highly similar nature of the request/response processing pipeline.</p><p>Given Falco&rsquo;s simple, readable API and the ease to use even if we will not change to it in every F# based Lambda service we have, I will definitely use it for projects where possible.</p><p>If you are interested in trying out the setup outlined without reproducing it step-by-step, then check out the <a href=https://github.com/kodfodrasz/fsharp-advent-calendar-article-2020-12-18/>repository containing the code and the article at GitHub</a>.</p></div></div></body><footer class="mw8-l center pa4"><a href=https://github.com/l1x class=pa2><i class="fab fa-github fa-2x"></i></a><a href=https://twitter.com/lix class=pa2><i class="fab fa-twitter fa-2x"></i></a><a href=https://www.linkedin.com/in/iszukacs class=pa2><i class="fab fa-linkedin fa-2x"></i></a><a href=https://dev.to/l1x class=pa2><i class="fab fa-dev fa-2x"></i></a></footer></html>