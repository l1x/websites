<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=/css/dosis.min.css><link rel=stylesheet href=/css/tachyons.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/fontawesome.min.css><title>l1x/dev | Diving into Firecracker with Alpine</title><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/img/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><meta name=image property="og:image" content><meta name=title property="og:title" content="Diving into Firecracker with Alpine"><meta name=description property="og:description" content="Firecracker is an open source virtualisation technology for creating and managing secure, multi-tenant container services."><meta name=type property="og:type" content="article"><meta name=url property="og:url" content="https://dev.l1x.be/posts/2020/12/13/diving-into-firecracker-with-alpine/"><meta name=author content="l1x"></head><body><div class="content mw8-l center pl4"><header class="flex mw8-l center pt4"><div class=pt3><img src=/img/apple-touch-icon.png width=60 alt=apple-touch-icon></div><a href=/ class="title link pl3 pt2"><h1>l1x/dev</h1></a></header><h2 class=post-title>Diving into Firecracker with Alpine</h2><div class=gray>2020/12/13 :: #containerisation #virtualisation #linux #cgroups #cloud</div><div class=toc><nav id=TableOfContents><ol><li><a href=#article-series>Article series</a></li><li><a href=#intro>Intro</a></li><li><a href=#setup-alpine>Setup Alpine</a><ol><li><a href=#installing-alpine-on-rpi-4>Installing Alpine on RPI 4</a><ol><li><a href=#creating-the-partition>Creating the partition</a></li><li><a href=#downloading-alpine-and-writing-it-to-the-sd-card>Downloading Alpine and writing it to the SD card</a></li><li><a href=#configuring-rpi-boot>Configuring RPI boot</a></li><li><a href=#booting-and-configuring-alpine>Booting and configuring Alpine</a></li></ol></li></ol></li><li><a href=#setting-up-firecracker-dev-environment>Setting up Firecracker dev environment</a></li><li><a href=#creating-a-microvm>Creating a microVM</a><ol><li><a href=#compiling-a-new-kernel>Compiling a new kernel</a></li><li><a href=#creating-a-new-rootfs>Creating a new rootfs</a></li><li><a href=#configuring-host-networking>Configuring host networking</a></li><li><a href=#enablig-non-root-access>Enablig non-root access</a></li><li><a href=#booting-up-the-microvm-using-pattacu>Booting up the microVM using Pattacu</a><ol><li><a href=#starting-firecracker>Starting Firecracker</a></li><li><a href=#starting-socat>Starting socat</a></li><li><a href=#configuring-which-kernel-to-boot-up-as-the-guest>Configuring which kernel to boot up as the guest</a></li><li><a href=#configuring-which-rootfs-to-be-used-by-the-guest>Configuring which rootfs to be used by the guest</a></li><li><a href=#configuring-guest-machine-config>Configuring guest machine config</a></li><li><a href=#configuring-guest-networking>Configuring guest networking</a></li><li><a href=#starting-up-the-instance>Starting up the instance</a></li></ol></li></ol></li><li><a href=#closing>Closing</a></li></ol></nav></div><div class="f4 lh-copy"><h2 id=article-series>Article series</h2><ul><li>1st part :: <a href=https://dev.l1x.be/posts/2020/11/22/getting-started-with-firecracker-on-raspberry-pi/>https://dev.l1x.be/posts/2020/11/22/getting-started-with-firecracker-on-raspberry-pi/</a></li><li>2nd part :: this</li></ul><h2 id=intro>Intro</h2><p>Last time in the 1st article I briefly introduced Firecracker as a lightweight virtualization/containerization solution for extreme-scale (like AWS Lambda functions). This time around I am going to dig a bit deeper into the API and the management of microVMs. I am going to install Alpine on RPI, install Rust and Python, Docker, get the Linux kernel source and compile a new kernel with minimal config, compile our own Firecracker and then create a new rootfs to be able to boot up a guest. Most of these steps are optional, you can use the stock kernel the Firecracker team provides or download Firecracker release from Github.</p><h2 id=setup-alpine>Setup Alpine</h2><p>If you do not care about Alpine on RPI you can jump to the Firecracker section.</p><p>I would like to keep going with <a href=https://amzn.to/2Klb9fx>Raspberry Pi 4B 8GB</a> or <a href=https://amzn.to/2KeohTO>Raspberry Pi 4B 4GB</a> for many reasons. It is a small system that you can easily hack on without any change on your desktop. It is also an ARM64 (ARM Cortex-A72) system that has great performance even without active cooling. I usually use it with a <a href=https://amzn.to/3naOS2L>alu case</a> that provides the best heat dispersion and a cool CPU. It has enough CPU power and memory to compile any software including Firecracker, the Linux kernel, and more. Since this project is a side project I don&rsquo;t care how long it takes to finish a new kernel, usually finishes within 2 hours (I might get exact timing later).</p><p>Another item on my to-do list is to get Alpine Linux as both the host and the guest system. For those who do not know Alpine is a small Linux distribution designed for security, simplicity, and resource efficiency. It comes with sane defaults and Musl as its C standard library. Alpine uses its own package management system, apk-tools, providing super-fast package installation. Alpine allows a very small system with minimal installation being around 130 MB. The init system is the lightweight OpenRC, Alpine does not use systemd. This was the primary reason I wanted to get into Alpine.</p><h3 id=installing-alpine-on-rpi-4>Installing Alpine on RPI 4</h3><p>This is the most complicated part of the setup because RPI has a special boot procedure that uses a FAT partition and the GPU. When installing Alpine first you need to create a FAT partition at the beginning of the SD card with MBR. I am using MacOS this time. I am pretty sure it is easy to translate this to Linux (not sure about Windows.)</p><h4 id=creating-the-partition>Creating the partition</h4><p>My microSD card is /dev/disk6. I create a partition with the name ALP (1024MB), then activate it with fdisk.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>diskutil list
diskutil partitionDisk /dev/disk6 MBR <span style=color:#d88200>&#34;FAT32&#34;</span> ALP 1024MB <span style=color:#d88200>&#34;Free Space&#34;</span> SYS R
sudo fdisk -e /dev/disk6
&gt; f <span style=color:#ae81ff>1</span>
&gt; w
&gt; <span style=color:#111>exit</span>
</code></pre></div><p>After this command runs successfully MacOS mounts the newly created partition in /Volumes/ALP.</p><h4 id=downloading-alpine-and-writing-it-to-the-sd-card>Downloading Alpine and writing it to the SD card</h4><p>You can initiate the download anywhere, make sure the previously created partition is mounted.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>wget http://dl-cdn.alpinelinux.org/alpine/v3.12/releases/aarch64/alpine-rpi-3.12.1-aarch64.tar.gz
tar xzvf alpine-rpi-3.12.1-aarch64.tar.gz -C /Volumes/ALP/
</code></pre></div><h4 id=configuring-rpi-boot>Configuring RPI boot</h4><p>This part is optional, you can disable audio, wifi, Bluetooth, etc and enable UART, configure GPU mem. The full documentation is here:</p><p><a href=https://www.raspberrypi.org/documentation/configuration/config-txt/>https://www.raspberrypi.org/documentation/configuration/config-txt/</a></p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#111>cd</span> /Volumes/ALP/
<span style=color:#111>echo</span> <span style=color:#d88200>&#39;dtparam=audio=off&#39;</span>          &gt;&gt; usercfg.txt
<span style=color:#111>echo</span> <span style=color:#d88200>&#39;dtoverlay=pi3-disable-wifi&#39;</span> &gt;&gt; usercfg.txt
<span style=color:#111>echo</span> <span style=color:#d88200>&#39;enable_uart=1&#39;</span>              &gt;&gt; usercfg.txt
<span style=color:#111>echo</span> <span style=color:#d88200>&#39;gpu_mem=64&#39;</span>                 &gt;&gt; usercfg.txt
<span style=color:#111>echo</span> <span style=color:#d88200>&#39;disable_overscan=1&#39;</span>         &gt;&gt; usercfg.txt
</code></pre></div><p>You are ready to remove the SD card.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#111>cd</span>
diskutil eject /dev/disk6
</code></pre></div><h4 id=booting-and-configuring-alpine>Booting and configuring Alpine</h4><p>After inserting the SD card into the RPI you can boot it up. I am using a special converter that converts the mini HDMI to a normal HDMI <a href=https://amzn.to/3452Ziz>converter</a> that makes it easy to connect a TV or a monitor to the PI. I usually connect the device to the network with an ethernet cable and plug in a wired USB keyboard.</p><p>Once the device is booting up you can login with root (no password).</p><p>Alpine has a neat tool to configure a new system. It asks a few questions about keyboard layout and timezone, also makes you create a root password.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>setup-alpine
</code></pre></div><p>Once setup-alpine is done you need to change a few things around because up to this moment you operated on the FAT partition. After updating the system and adding cfdisk you can create a new partition and use the remaining space on the SD card to have a proper system. In cfdisk, select “Free space” and the option “New”. It suggests using the entire available space, just press enter, then select the option “primary”, followed by “Write”. Type “yes” to write the partition table to disk, then select “Quit”.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>apk update
apk upgrade
apk add cfdisk e2fsprogs
cfdisk /dev/mmcblk0
</code></pre></div><p>Once our new partition is ready you need to create a filesystem on it and install a basic Alpine system with setup-disk. In &ldquo;sys&rdquo; mode, it&rsquo;s an installer, it permanently installs Alpine on the disk. Ignore the errors, there might be some while executing setup-disk.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>mkfs.ext4 /dev/mmcblk0p2
mount /dev/mmcblk0p2 /mnt
setup-disk -m sys /mnt
mount -o remount,rw /media/mmcblk0p1
</code></pre></div><p>This section is what I found on the Alpine wiki and it works. There might be an easier way.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>rm -f /media/mmcblk0p1/boot/*
<span style=color:#111>cd</span> /mnt
rm boot/boot
mv boot/* /media/mmcblk0p1/boot/
rm -Rf boot
mkdir media/mmcblk0p1
ln -s media/mmcblk0p1/boot boot
</code></pre></div><p>There are only two steps left, adjusting fstab and cmdline.txt.</p><p>Fstab:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#111>UUID</span><span style=color:#f92672>=</span>your-uui-id  /                 ext4  rw,relatime  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>
/dev/mmcblk0p1    /media/mmcblk0p1  vfat  rw           <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span>
</code></pre></div><p>Add the following content to etc/fstab (please note no starting /).</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>vi etc/fstab
</code></pre></div><p>Appending the following to the cmdline.txt:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#111>root</span><span style=color:#f92672>=</span>/dev/mmcblk0p2
</code></pre></div><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>vi /media/mmcblk0p1/cmdline.txt
</code></pre></div><p>It looks like this for me:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>cat /media/mmcblk0p1/cmdline.txt
<span style=color:#111>modules</span><span style=color:#f92672>=</span>loop,squashfs,sd-mod,usb-storage quiet <span style=color:#111>console</span><span style=color:#f92672>=</span>tty1 <span style=color:#111>root</span><span style=color:#f92672>=</span>/dev/mmcblk0p2
</code></pre></div><p>I am not sure if lbu commit is necessary here. When Alpine Linux boots in diskless mode, initially it only loads a few required packages from the boot device by default. But local adjustments in RAM are possible, e.g. by installing a package or adjusting some configuration.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>lbu commit -d
</code></pre></div><p>You can reboot and log in with root and verify everything is working. Going forward it is best to have a user other than root.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>adduser l1x
addgroup l1x wheel
</code></pre></div><p>I usually add the following packages and start to use sudo going forward:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo apk add tmux fish ninja clang g++ sudo git python3 socat curl vim procps
</code></pre></div><p>Make sure that wheel group can use sudo:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>%wheel <span style=color:#111>ALL</span><span style=color:#f92672>=(</span>ALL<span style=color:#f92672>)</span> NOPASSWD: ALL
</code></pre></div><p>Changing my shell to fish:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>l1x:x:1000:1000:Linux User,,,:/home/l1x:/usr/bin/fish
</code></pre></div><p>Hopefully, by now you have a working environment. I use a bigger drive for /data where I store all the development folders.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>l1x@alpine ~&gt; mount <span style=color:#111>|</span> column -t <span style=color:#111>|</span> egrep <span style=color:#d88200>&#39;^/dev&#39;</span>
/dev/mmcblk0p2  on  /                 <span style=color:#111>type</span>  ext4        <span style=color:#f92672>(</span>rw,relatime<span style=color:#f92672>)</span>
/dev/mmcblk0p1  on  /media/mmcblk0p1  <span style=color:#111>type</span>  vfat        <span style=color:#f92672>(</span>rw,relatime,fmask<span style=color:#f92672>=</span>0022,dmask<span style=color:#f92672>=</span>0022,codepage<span style=color:#f92672>=</span>437,...<span style=color:#f92672>)</span>
/dev/sda1       on  /data             <span style=color:#111>type</span>  xfs         <span style=color:#f92672>(</span>rw,relatime,attr2,inode64,logbufs<span style=color:#f92672>=</span>8,logbsize<span style=color:#f92672>=</span>32k,...<span style=color:#f92672>)</span>
</code></pre></div><h2 id=setting-up-firecracker-dev-environment>Setting up Firecracker dev environment</h2><p>Once you logged in via SSH to your Alpine system make sure you have the dev tools you are going to need. I usually use the following tools, and some more:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo apk add tmux git python3 curl vim
</code></pre></div><p>I was trying to figure out how to install Rust on ARM64 linux and the most straightforward way looks like:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>curl --proto <span style=color:#d88200>&#39;=https&#39;</span> --tlsv1.2 -sSf https://sh.rustup.rs <span style=color:#111>|</span> sh
</code></pre></div><p>If you want to compile Firecracker yourself you also need Docker. Docker for this version of Alpine lives in the community repo. Simply append the community line to your repositories:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>cat /etc/apk/repositories
<span style=color:#75715e>#/media/mmcblk0p1/apks</span>
http://your.nearest.mirror/mirrors/pub/alpine/v3.12/main
http://your.nearest.mirror/mirrors/pub/alpine/v3.12/community
</code></pre></div><p>Installing Docker:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo apk add docker
sudo addgroup <span style=color:#111>$USER</span> docker
sudo rc-update add docker boot
sudo service docker start
</code></pre></div><p>After Docker is running you can clone the Firecracker repo:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>git clone git@github.com:firecracker-microvm/firecracker.git
</code></pre></div><p>Before you can compile a release you need to install two more packages:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo apk add bash ncurses
</code></pre></div><p>Now you can compile the Firecracker binaries:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>./tools/devtool build --release --libc musl
<span style=color:#f92672>[</span>Firecracker devtool<span style=color:#f92672>]</span> About to pull docker image fcuvm/dev:v24
<span style=color:#f92672>[</span>Firecracker devtool<span style=color:#f92672>]</span> Continue? <span style=color:#f92672>(</span>y/n<span style=color:#f92672>)</span> y
Digest: sha256:12b8efe9a91d31349a6241b7d81c26d50bf913e369b5845a921be720e5de5796
Status: Downloaded newer image <span style=color:#00a8c8>for</span> fcuvm/dev:v24
docker.io/fcuvm/dev:v24
<span style=color:#f92672>[</span>Firecracker devtool<span style=color:#f92672>]</span> Starting build <span style=color:#f92672>(</span>release, musl<span style=color:#f92672>)</span> ...


</code></pre></div><p>There are few binaries generated:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>ls build/cargo_target/aarch64-unknown-linux-musl/release/<span style=color:#f92672>{</span>firecracker,jailer<span style=color:#f92672>}</span>
 build/cargo_target/aarch64-unknown-linux-musl/release/firecracker*
 build/cargo_target/aarch64-unknown-linux-musl/release/jailer*
file build/cargo_target/aarch64-unknown-linux-musl/release/<span style=color:#f92672>{</span>firecracker,jailer<span style=color:#f92672>}</span>
build/cargo_target/aarch64-unknown-linux-musl/release/firecracker:
ELF 64-bit LSB executable, ARM aarch64, version <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>GNU/Linux<span style=color:#f92672>)</span>,
statically linked, BuildID<span style=color:#f92672>[</span>sha1<span style=color:#f92672>]=</span>4da58d970ac0c51aad276309866f2b701cc397cd, with debug_info, not stripped
build/cargo_target/aarch64-unknown-linux-musl/release/jailer:
ELF 64-bit LSB executable, ARM aarch64, version <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>GNU/Linux<span style=color:#f92672>)</span>,
statically linked, BuildID<span style=color:#f92672>[</span>sha1<span style=color:#f92672>]=</span>3e3c780b4e0fbd74b661c54f11192f9a15b89cba, with debug_info, not stripped
</code></pre></div><p>Using these binaries we can create the VMs.</p><h2 id=creating-a-microvm>Creating a microVM</h2><p>Before getting started, there are multiple ways to start a microVM with Firecracker. Here are a few:</p><ul><li>starting up the Firecracker binary and through the Unix socket configure it and then start a VM</li><li>starting Firecracker with a complete VM config without the Unix socket API</li><li>starting Firecracker with Jailer so it uses cgroups to containerize the VM</li></ul><p>We are going to check out the first way.</p><p>When I started to fiddle with FC I was trying to use the official CLI (Firectl) and because it is written in Go you need to have a Go compiler if you would like to build it yourself. I did not like this option too much so I have created a new CLI called <a href=https://github.com/l1x/pattacu>Pattacu</a> written in Python.</p><h3 id=compiling-a-new-kernel>Compiling a new kernel</h3><p>This is optional. You can download the official kernel from Firecracker:</p><p><a href=https://github.com/firecracker-microvm/firecracker/blob/master/docs/rootfs-and-kernel-setup.md>https://github.com/firecracker-microvm/firecracker/blob/master/docs/rootfs-and-kernel-setup.md</a></p><p>If you decided to compile a new Linux kernel there are few things you need to have.</p><ul><li>kernel-source</li><li>tools to compile</li></ul><p>I usually use one of the long term releases:</p><ul><li><a href=https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.14.212.tar.xz>https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.14.212.tar.xz</a></li><li><a href=https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.19.163.tar.xz>https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.19.163.tar.xz</a></li><li><a href=https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.4.83.tar.xz>https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.4.83.tar.xz</a></li></ul><p>After extracting the kernel source to a folder you can grab the config I have prepared with some help from an OpenWrt developer:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>wget https://raw.githubusercontent.com/l1x/pattacu/main/kernel-config/microvm-kernel-arm64.4.19.config -O .config
</code></pre></div><p>There are more tools required for building a new kernel:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo apk add bison clang make flex linux-headers openssl-dev perl
</code></pre></div><p>With these the kernel can be compiled:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>make olddefconfig
<span style=color:#111>time</span> make Image.gz
</code></pre></div><p>This is going to take a while. After that, the kernel file we need for the microVM will be arch/arm64/boot/Image.</p><h3 id=creating-a-new-rootfs>Creating a new rootfs</h3><p>This is optional. You can download the official rootfs from Firecracker:</p><p><a href=https://github.com/firecracker-microvm/firecracker/blob/master/docs/rootfs-and-kernel-setup.md>https://github.com/firecracker-microvm/firecracker/blob/master/docs/rootfs-and-kernel-setup.md</a></p><p>There is a project that can be used to create an Alpine rootfs. With a bit of additional shell scripting, we can create a customized rootfs that can boot up in Firecracker.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>wget https://raw.githubusercontent.com/alpinelinux/alpine-make-rootfs/v0.5.1/alpine-make-rootfs -O alpine-make-rootfs <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>echo</span> <span style=color:#d88200>&#39;a7159f17b01ad5a06419b83ea3ca9bbe7d3f8c03 alpine-make-rootfs&#39;</span> <span style=color:#111>|</span> sha1sum -c <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>  <span style=color:#f92672>||</span> <span style=color:#111>exit</span> <span style=color:#ae81ff>1</span>
chmod +x alpine-make-rootfs
sudo ./alpine-make-rootfs <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>  --branch v3.12 <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>  --packages <span style=color:#d88200>&#39;openrc util-linux&#39;</span> <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>  --timezone <span style=color:#d88200>&#39;Europe/Budapest&#39;</span> <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>  --script-chroot <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>    rootfs-<span style=color:#00a8c8>$(</span>date +%Y%m%d<span style=color:#00a8c8>)</span>.tar.gz - <span style=color:#d88200>&lt;&lt;&#39;SHELL&#39;
</span><span style=color:#d88200>    ln -s agetty /etc/init.d/agetty.ttyS0
</span><span style=color:#d88200>    echo ttyS0 &gt; /etc/securetty
</span><span style=color:#d88200>    echo &#39;nameserver 1.1.1.1&#39; &gt; /etc/resolv.conf
</span><span style=color:#d88200>    rc-update add agetty.ttyS0 default
</span><span style=color:#d88200>    rc-update add devfs boot
</span><span style=color:#d88200>    rc-update add procfs boot
</span><span style=color:#d88200>    rc-update add sysfs boot
</span><span style=color:#d88200>SHELL</span>

dd <span style=color:#00a8c8>if</span><span style=color:#f92672>=</span>/dev/zero <span style=color:#111>of</span><span style=color:#f92672>=</span>alpine.ext4 <span style=color:#111>bs</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> <span style=color:#111>count</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> <span style=color:#111>seek</span><span style=color:#f92672>=</span>256M
mkfs.ext4 alpine.ext4
sudo mkdir /tmp/alpine-rootfs
sudo mount alpine.ext4 /tmp/alpine-rootfs
sudo tar xzvf rootfs-<span style=color:#00a8c8>$(</span>date +%Y%m%d<span style=color:#00a8c8>)</span>.tar.gz -C /tmp/alpine-rootfs
sudo umount /tmp/alpine-rootfs
</code></pre></div><h3 id=configuring-host-networking>Configuring host networking</h3><p>If you would like to use networking with Firecracker the host network has to be configured to support this.</p><p>First loading the kernel driver, installing iproute2 (the ip command):</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>modprobe tun
sudo apk add iproute2 acl
sudo ip tuntap add tap0 mode tap
</code></pre></div><p>Second, configuring networking and forwarding:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo ip addr add 172.16.0.1/24 dev tap0
sudo ip link <span style=color:#111>set</span> tap0 up
sudo sh -c <span style=color:#d88200>&#34;echo 1 &gt; /proc/sys/net/ipv4/ip_forward&#34;</span>
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i tap0 -o eth0 -j ACCEPT
</code></pre></div><h3 id=enablig-non-root-access>Enablig non-root access</h3><p>I like to run Firecracker as a non-root user and it is easy to achieve:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo setfacl -m u:<span style=color:#111>$USER</span>:rw /dev/kvm
sudo setcap <span style=color:#111>cap_net_bind_service</span><span style=color:#f92672>=</span>+ep /usr/bin/socat
</code></pre></div><p>This gives your user access to /dev/kvm and enabled socat bind to port 80 without root, using the new Linux kernel capabilities.</p><h3 id=booting-up-the-microvm-using-pattacu>Booting up the microVM using Pattacu</h3><p>For running Pattacu the only dependency is Python3 (I have not tested it with Python2).</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>sudo apk add python3
<span style=color:#111>cd</span>
python3 -m venv venv
<span style=color:#75715e># Depending on your shell</span>
. ~/venv/bin/activate.fish
<span style=color:#111>cd</span> /where/you/store/repos
git clone git@github.com:l1x/pattacu.git
<span style=color:#111>cd</span> pattacu
pip install -r requirements.txt
./bin/pattacu -h
./bin/pattacu -h
usage: pattacu <span style=color:#f92672>[</span>-h<span style=color:#f92672>]</span> <span style=color:#f92672>{</span>describe-instance,put-boot-source,put-drives,put-machine-config,put-network-interfaces,put-actions<span style=color:#f92672>}</span> ...

positional arguments:
  <span style=color:#f92672>{</span>describe-instance,put-boot-source,put-drives,put-machine-config,put-network-interfaces,put-actions<span style=color:#f92672>}</span>

optional arguments:
  -h, --help            show this <span style=color:#111>help</span> message and <span style=color:#111>exit</span>
2020-12-13 20:35:01 INFO Quitting...
</code></pre></div><p>For starting up a microVM there are few things to be configured:</p><ul><li>starting Firecracker</li><li>starting socat</li><li>configuring which kernel to boot up as the guest</li><li>configuring which rootfs to be used by the guest</li><li>configuring guest machine config</li><li>configuring guest networking</li></ul><p>In this order:</p><h4 id=starting-firecracker>Starting Firecracker</h4><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#111>export</span> <span style=color:#111>socket_path</span><span style=color:#f92672>=</span>/data/fc/firecracker.socket
rm -f <span style=color:#d88200>&#34;</span><span style=color:#111>$socket_path</span><span style=color:#d88200>&#34;</span>
./firecracker --api-sock <span style=color:#d88200>&#34;</span><span style=color:#111>$socket_path</span><span style=color:#d88200>&#34;</span> --level Debug --log-path firecracker.log --show-log-origin --id fc-test
</code></pre></div><h4 id=starting-socat>Starting socat</h4><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>socat -v -v TCP-LISTEN:80,reuseaddr,fork UNIX-CLIENT:<span style=color:#d88200>&#34;</span><span style=color:#111>$socket_path</span><span style=color:#d88200>&#34;</span>
</code></pre></div><h4 id=configuring-which-kernel-to-boot-up-as-the-guest>Configuring which kernel to boot up as the guest</h4><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>./bin/pattacu put-boot-source <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>	--boot-args <span style=color:#d88200>&#34;keep_bootcon console=ttyS0 reboot=k panic=1 pci=off ip=172.16.0.42::172.16.0.1:255.255.255.0::eth0:off&#34;</span> <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>	--kernel-image-path /linux/arm64/kernel/4.14.210.image

2020-12-13 20:44:12 INFO ARGS: Namespace<span style=color:#f92672>(</span><span style=color:#111>boot_args</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;keep_bootcon console=ttyS0
</span><span style=color:#d88200>reboot=k panic=1 pci=off ip=172.16.0.42::172.16.0.1:255.255.255.0::eth0:off&#39;</span>, <span style=color:#111>func</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;put-boot-source&#39;</span>,
<span style=color:#111>initrd_path</span><span style=color:#f92672>=</span>None, <span style=color:#111>kernel_image_path</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;/linux/arm64/kernel/4.14.210.image&#39;</span><span style=color:#f92672>)</span>
2020-12-13 20:44:12 INFO <span style=color:#f92672>{</span><span style=color:#d88200>&#34;boot_args&#34;</span>: <span style=color:#d88200>&#34;keep_bootcon console=ttyS0 reboot=k
</span><span style=color:#d88200>panic=1 pci=off ip=172.16.0.42::172.16.0.1:255.255.255.0::eth0:off&#34;</span>,
<span style=color:#d88200>&#34;kernel_image_path&#34;</span>: <span style=color:#d88200>&#34;/linux/arm64/kernel/4.14.210.image&#34;</span><span style=color:#f92672>}</span>
2020-12-13 20:44:12 INFO HTTP Status: <span style=color:#ae81ff>204</span> HTTP Reason:  HTTP body: <span style=color:#d88200>&#34;&#34;</span>
2020-12-13 20:44:12 INFO Quitting...
</code></pre></div><h4 id=configuring-which-rootfs-to-be-used-by-the-guest>Configuring which rootfs to be used by the guest</h4><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>./bin/pattacu put-drives <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>  --drive-id rootfs <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>  --path /data/pattacu/rootfs/example-20201213.tar.gz <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>  --read-only <span style=color:#111>false</span> <span style=color:#8045ff>\
</span><span style=color:#8045ff></span>  --root-device <span style=color:#111>true</span>
2020-12-13 20:46:30 INFO ARGS: Namespace<span style=color:#f92672>(</span><span style=color:#111>drive_id</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;rootfs&#39;</span>,
<span style=color:#111>func</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;put-drives&#39;</span>, <span style=color:#111>path</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;/data/pattacu/rootfs/example-20201213.tar.gz&#39;</span>, <span style=color:#111>read_only</span><span style=color:#f92672>=</span>False, <span style=color:#111>root_device</span><span style=color:#f92672>=</span>True<span style=color:#f92672>)</span>
2020-12-13 20:46:30 INFO <span style=color:#f92672>{</span><span style=color:#d88200>&#34;drive_id&#34;</span>: <span style=color:#d88200>&#34;rootfs&#34;</span>, <span style=color:#d88200>&#34;path_on_host&#34;</span>:
<span style=color:#d88200>&#34;/data/pattacu/rootfs/example-20201213.tar.gz&#34;</span>, <span style=color:#d88200>&#34;is_root_device&#34;</span>: true, <span style=color:#d88200>&#34;is_read_only&#34;</span>: false<span style=color:#f92672>}</span>
2020-12-13 20:46:30 INFO HTTP Status: <span style=color:#ae81ff>204</span> HTTP Reason:  HTTP body: <span style=color:#d88200>&#34;&#34;</span>
2020-12-13 20:46:30 INFO Quitting...
</code></pre></div><h4 id=configuring-guest-machine-config>Configuring guest machine config</h4><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>./bin/pattacu put-machine-config --mem-size-mib <span style=color:#ae81ff>128</span> --vcpu-count <span style=color:#ae81ff>2</span> --ht-enabled <span style=color:#111>false</span>

2020-12-13 20:47:58 INFO ARGS: Namespace<span style=color:#f92672>(</span><span style=color:#111>cpu_template</span><span style=color:#f92672>=</span>None, <span style=color:#111>func</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;put-machine-config&#39;</span>,
<span style=color:#111>ht_enabled</span><span style=color:#f92672>=</span>False, <span style=color:#111>mem_size_mib</span><span style=color:#f92672>=</span>128, <span style=color:#111>track_dirty_pages</span><span style=color:#f92672>=</span>None, <span style=color:#111>vcpu_count</span><span style=color:#f92672>=</span>2<span style=color:#f92672>)</span>
2020-12-13 20:47:58 INFO <span style=color:#f92672>{</span><span style=color:#d88200>&#34;vcpu_count&#34;</span>: 2, <span style=color:#d88200>&#34;mem_size_mib&#34;</span>: 128, <span style=color:#d88200>&#34;ht_enabled&#34;</span>: false<span style=color:#f92672>}</span>
2020-12-13 20:47:58 INFO HTTP Status: <span style=color:#ae81ff>204</span> HTTP Reason:  HTTP body: <span style=color:#d88200>&#34;&#34;</span>
2020-12-13 20:47:58 INFO Quitting...
</code></pre></div><h4 id=configuring-guest-networking>Configuring guest networking</h4><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>./bin/pattacu put-network-interfaces --iface-id eth0 --guest-mac <span style=color:#d88200>&#34;AA:FC:00:00:00:01&#34;</span> --host-dev-name tap0
2020-12-13 20:48:57 INFO ARGS: Namespace<span style=color:#f92672>(</span><span style=color:#111>func</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;put-network-interfaces&#39;</span>,
<span style=color:#111>guest_mac</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;AA:FC:00:00:00:01&#39;</span>, <span style=color:#111>host_dev_name</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;tap0&#39;</span>, <span style=color:#111>iface_id</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;eth0&#39;</span><span style=color:#f92672>)</span>
2020-12-13 20:48:57 INFO <span style=color:#f92672>{</span><span style=color:#d88200>&#34;iface_id&#34;</span>: <span style=color:#d88200>&#34;eth0&#34;</span>,
<span style=color:#d88200>&#34;guest_mac&#34;</span>: <span style=color:#d88200>&#34;AA:FC:00:00:00:01&#34;</span>, <span style=color:#d88200>&#34;host_dev_name&#34;</span>: <span style=color:#d88200>&#34;tap0&#34;</span><span style=color:#f92672>}</span>
2020-12-13 20:48:58 INFO HTTP Status: <span style=color:#ae81ff>204</span> HTTP Reason:  HTTP body: <span style=color:#d88200>&#34;&#34;</span>
2020-12-13 20:48:58 INFO Quitting...
</code></pre></div><h4 id=starting-up-the-instance>Starting up the instance</h4><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>./bin/pattacu put-actions --action-type InstanceStart
2020-12-13 20:49:19 INFO ARGS: Namespace<span style=color:#f92672>(</span><span style=color:#111>action_type</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;InstanceStart&#39;</span>, <span style=color:#111>func</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;put-actions&#39;</span><span style=color:#f92672>)</span>
2020-12-13 20:49:19 INFO <span style=color:#f92672>{</span><span style=color:#d88200>&#34;action_type&#34;</span>: <span style=color:#d88200>&#34;InstanceStart&#34;</span><span style=color:#f92672>}</span>
2020-12-13 20:49:20 INFO HTTP Status: <span style=color:#ae81ff>204</span> HTTP Reason:  HTTP body: <span style=color:#d88200>&#34;&#34;</span>
2020-12-13 20:49:20 INFO Quitting...
</code></pre></div><p>You can switch to the other tmux window and see the system booting up.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>    1.739745<span style=color:#f92672>]</span> random: fast init <span style=color:#00a8c8>done</span> <span style=color:#f92672>[</span>27/1844<span style=color:#f92672>]</span> <span style=color:#f92672>[</span> ok <span style=color:#f92672>]</span>
 * Mounting /sys ... <span style=color:#f92672>[</span> ok <span style=color:#f92672>]</span>
 * Mounting security filesystem ... <span style=color:#f92672>[</span> ok <span style=color:#f92672>]</span>
 * Mounting debug filesystem ... <span style=color:#f92672>[</span> ok <span style=color:#f92672>]</span>
 * Mounting SELinux filesystem ... <span style=color:#f92672>[</span> ok <span style=color:#f92672>]</span>
 * Mounting persistent storage <span style=color:#f92672>(</span>pstore<span style=color:#f92672>)</span> filesystem ... <span style=color:#f92672>[</span> ok <span style=color:#f92672>]</span>

Welcome to Alpine Linux 3.12
Kernel 4.20.0 on an aarch64 <span style=color:#f92672>(</span>ttyS0<span style=color:#f92672>)</span>

<span style=color:#ae81ff>172</span> login: root
Welcome to Alpine!

The Alpine Wiki contains a large number of how-to guides and general
information about administrating Alpine systems.
See &lt;http://wiki.alpinelinux.org/&gt;.

You can <span style=color:#111>set</span> up the system with the command: setup-alpine

You may change this message by editing /etc/motd.

login<span style=color:#f92672>[</span>840<span style=color:#f92672>]</span>: root login on <span style=color:#d88200>&#39;ttyS0&#39;</span>
172:~# ping hackernews.org
PING hackernews.org <span style=color:#f92672>(</span>162.255.119.249<span style=color:#f92672>)</span>: <span style=color:#ae81ff>56</span> data bytes
<span style=color:#ae81ff>64</span> bytes from 162.255.119.249: <span style=color:#111>seq</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> <span style=color:#111>ttl</span><span style=color:#f92672>=</span><span style=color:#ae81ff>42</span> <span style=color:#111>time</span><span style=color:#f92672>=</span>180.868 ms
</code></pre></div><h2 id=closing>Closing</h2><p>I think Firecracker has a great potential to be the next platform for containerization especially because of its lean nature. If we could create a reasonable service that hosts FC images that are easy to deploy it could replace Docker easily. I hope it takes off.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>172:~# poweroff
The system is going down NOW!
Sent SIGTERM to all processes
Sent SIGKILL to all processes
Requesting system poweroff
<span style=color:#f92672>[</span>  202.707132<span style=color:#f92672>]</span> reboot: Power down
<span style=color:#f92672>[</span>  202.707132<span style=color:#f92672>]</span> reboot: Power down
</code></pre></div></div></div></body><footer class="mw8-l center pa4"><a href=https://github.com/l1x class=pa2><i class="fab fa-github fa-2x"></i></a><a href=https://twitter.com/lix class=pa2><i class="fab fa-twitter fa-2x"></i></a><a href=https://www.linkedin.com/in/iszukacs class=pa2><i class="fab fa-linkedin fa-2x"></i></a><a href=https://dev.to/l1x class=pa2><i class="fab fa-dev fa-2x"></i></a></footer></html>