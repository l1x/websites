<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=/css/dosis.min.css><link rel=stylesheet href=/css/tachyons.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/fontawesome.min.css><title>l1x/dev | Compressing AWS S3 logs after getting HackerNewsed</title><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/img/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><meta name=image property="og:image" content><meta name=title property="og:title" content="Compressing AWS S3 logs after getting HackerNewsed"><meta name=description property="og:description" content="Compressing AWS S3 logs after getting HackerNewsed"><meta name=type property="og:type" content="article"><meta name=url property="og:url" content="https://dev.l1x.be/posts/2020/12/20/compressing-aws-s3-logs-after-getting-hackernewsed/"><meta name=author content="l1x"></head><body><div class="content mw8-l center pl4"><header class="flex mw8-l center pt4"><div class=pt3><img src=/img/apple-touch-icon.png width=60 alt=apple-touch-icon></div><a href=/ class="title link pl3 pt2"><h1>l1x/dev</h1></a></header><h2 class=post-title>Compressing AWS S3 logs after getting HackerNewsed</h2><div class=gray>2020/12/20 :: #parquet #aws #s3 #plotly #dash #fsharp</div><div class=toc><nav id=TableOfContents><ol><li><a href=#abstract>Abstract</a></li><li><a href=#processing-log-files>Processing log files</a></li><li><a href=#visualization>Visualization</a><ol><li><a href=#referers>Referers</a></li><li><a href=#top-posts>Top Posts</a></li><li><a href=#top-iatas>Top IATAs</a></li><li><a href=#hit-distribution-over-time>Hit distribution over time</a></li></ol></li></ol></nav></div><div class="f4 lh-copy"><h2 id=abstract>Abstract</h2><p>One of my previous articles about Firecracker and RPI got posted on HN, and I just realized that many months ago, I enabled logging on the S3 bucket hosting this content. I quickly wanted to peek into the stats, and when I discovered that Athena could not process compressed S3 logs.</p><p>I was already working on a larger AWS codebase in F#, so I decided to write a tool that can download the raw logs from S3 and merge all the small files, convert it to Parquet and upload those back.</p><p>C# has excellent AWS libraries, and after a bit of wrapping, those are suitable for F# dvelopment.</p><h2 id=processing-log-files>Processing log files</h2><p>First, I just created types so I can handle error on the caller side:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Fsharp data-lang=Fsharp><span style=color:#8f5902;font-style:italic>// S3ReadError can be used for other read oprations not just for Get
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>S3ReadError</span> <span style=color:#ce5c00;font-weight:700>=</span>
  <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>NotFound</span> <span style=color:#204a87;font-weight:700>of</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>string</span>
  <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>S3ReadPermissionDenied</span> <span style=color:#204a87;font-weight:700>of</span> <span style=color:#000>keyOrPrefix</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>string</span>
  <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>S3ReadException</span> <span style=color:#204a87;font-weight:700>of</span> <span style=color:#000>keyOrPrefix</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>isRecoverable</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>httpStatus</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>int</span> <span style=color:#000>option</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Exception</span> <span style=color:#000>option</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>S3GetBytesSuccess</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>S3GetBytesSuccess</span> <span style=color:#204a87;font-weight:700>of</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>value</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#3465a4>[]</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>S3GetBytesReturn</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S3GetBytesSuccess</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>S3ReadError</span><span style=color:#ce5c00;font-weight:700>&gt;</span>
</code></pre></div><p>AWS already makes you use async code, but it is easy to turn that into sync calls if you do not want to have async in your code. Bob already pointed out why async as we use it in many languages is problematic.</p><p><a href=https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/>What color is your function</a></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Fsharp data-lang=Fsharp><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// READ - GET - ASYNC
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>member</span> <span style=color:#000>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetS3ObjectBytesAsync</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bucket</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#ce5c00;font-weight:700>):</span> <span style=color:#000>Async</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>S3GetBytesReturn</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>=</span>
<span style=color:#000>async</span> <span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>try</span>
    <span style=color:#204a87;font-weight:700>let!</span> <span style=color:#000>ct</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CancellationToken</span>

    <span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#000>GetObjectRequest</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>BucketName</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bucket</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Key</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>)</span>

    <span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>awsS3Client</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>GetObjectAsync</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>ct</span><span style=color:#ce5c00;font-weight:700>)</span>

    <span style=color:#204a87;font-weight:700>let!</span> <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>Async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AwaitTask</span>

    <span style=color:#204a87;font-weight:700>match</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>HttpStatusCode</span> <span style=color:#204a87;font-weight:700>with</span>
    <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>HttpStatusCode</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OK</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Ok</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>S3GetBytesSuccess</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>readAllBytes</span> <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ResponseStream</span><span style=color:#ce5c00;font-weight:700>)))</span>
    <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>httpStatus</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>S3ReadException</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>Some</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>int</span> <span style=color:#000>httpStatus</span><span style=color:#ce5c00;font-weight:700>)),</span> <span style=color:#000>None</span><span style=color:#ce5c00;font-weight:700>))</span>

  <span style=color:#204a87;font-weight:700>with</span> <span style=color:#000>ex</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>handleReadException</span> <span style=color:#000>key</span> <span style=color:#000>ex</span><span style=color:#ce5c00;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>}</span>


<span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic>// READ - GET - SYNC
</span><span style=color:#8f5902;font-style:italic>//
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>member</span> <span style=color:#000>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetS3ObjectBytes</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bucket</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#ce5c00;font-weight:700>):</span> <span style=color:#000>S3GetBytesReturn</span> <span style=color:#ce5c00;font-weight:700>=</span>
<span style=color:#000>this</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>GetS3ObjectBytesAsync</span> <span style=color:#000>bucket</span> <span style=color:#000>key</span>
<span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>Async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunSynchronously</span>
</code></pre></div><p>With such functions, it is straightforward to write parallel code, where we can control parallelism. This is the first version. I use a global state variable, which not very idiomatic in functional programming, but since this is a simple linear execution with single points of mutations, it does not matter. I quite often see functional programming going to the extreme and declaring that all mutations are evil. This is why F# is one of the most productive languages out there because it lets me do mutations when I need those.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Fsharp data-lang=Fsharp><span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>doDownloadFiles</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileStates</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>Dictionary</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>FileState</span><span style=color:#ce5c00;font-weight:700>&gt;)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>s3v2</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>S3v2</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>localFolder</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>bucket</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span>

  <span style=color:#204a87;font-weight:700>let</span> <span style=color:#000>asynTaskList</span> <span style=color:#ce5c00;font-weight:700>=</span>
    <span style=color:#000>fileStates</span>
    <span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>Seq</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>map</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>fun</span> <span style=color:#000>fileEntry</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span>
        <span style=color:#000>async</span> <span style=color:#ce5c00;font-weight:700>{</span>
          <span style=color:#204a87;font-weight:700>match</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>downloadFile</span> <span style=color:#000>s3v2</span> <span style=color:#000>localFolder</span> <span style=color:#000>bucket</span> <span style=color:#000>fileEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Key</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>with</span>
          <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Ok</span> <span style=color:#ce5c00;font-weight:700>_</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>Downloaded</span><span style=color:#ce5c00;font-weight:700>)</span>
          <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>Error</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>fileEntry</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Key</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>FileStateError</span> <span style=color:#000>err</span><span style=color:#ce5c00;font-weight:700>))</span>
        <span style=color:#ce5c00;font-weight:700>})</span>

  <span style=color:#000>Async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Parallel</span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>asynTaskList</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>10</span><span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>Async</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunSynchronously</span>
  <span style=color:#ce5c00;font-weight:700>|&gt;</span> <span style=color:#000>Seq</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>iter</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>fun</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>,</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>fileStates</span><span style=color:#ce5c00;font-weight:700>.[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>v</span><span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><p>The complete code is here:</p><p><a href=https://github.com/l1x/s3logs>https://github.com/l1x/s3logs</a></p><h2 id=visualization>Visualization</h2><p>After I could download, process the text files, and upload the Parquet files, I was looking to visualize the data. I am a long-time fan of <a href=https://plotly.com/>Plotly</a> for many reasons, and they have a project called <a href=https://plotly.com/dash/>Dash</a> that I wanted to try for a long time.</p><p>There must be a bit of reshuffling of data for processing weblogs, maybe some aggregation in many cases. For that, Python&rsquo;s Pandas library is an ok choice. I am not saying it is excellent because there are many ways of doing the same thing, the error messages are not clear, and after working with it for 5 years, I still could not use it without reading its documentation and StackOverflow, often both.</p><h3 id=referers>Referers</h3><p>The first metric I was curious about is top referrers. The &ldquo;null&rdquo; values must be removed, and then we can then use Pandas and groupby to get the top 15 referrers.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Python data-lang=Python><span style=color:#000>df_ref</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>df</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>df</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;CsReferer&#39;</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#39;-&#39;</span><span style=color:#000;font-weight:700>]</span>
<span style=color:#000>filter_self</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>df_ref</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;CsReferer&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contains</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;dev</span><span style=color:#4e9a06>\\</span><span style=color:#4e9a06>.l1x</span><span style=color:#4e9a06>\\</span><span style=color:#4e9a06>.be&#39;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>df_ref</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>df_ref</span><span style=color:#000;font-weight:700>[</span><span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>filter_self</span><span style=color:#000;font-weight:700>]</span>
<span style=color:#000>top_ref</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>df_ref</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>groupby</span><span style=color:#000;font-weight:700>([</span><span style=color:#4e9a06>&#39;CsReferer&#39;</span><span style=color:#000;font-weight:700>])[</span><span style=color:#4e9a06>&#39;CsReferer&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nlargest</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>to_frame</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000>top_ref</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>rename</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>columns</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;CsReferer&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#39;Cnt&#39;</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000>errors</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;raise&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>inplace</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>top_ref</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reset_index</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>inplace</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><p>We can display this with Dash / Plotly as a table.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Python data-lang=Python>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>generate_table</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dataframe</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>max_rows</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>):</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Table</span><span style=color:#000;font-weight:700>([</span>
    <span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Thead</span><span style=color:#000;font-weight:700>(</span>
      <span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Tr</span><span style=color:#000;font-weight:700>([</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Th</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>col</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>dataframe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>columns</span><span style=color:#000;font-weight:700>])</span>
    <span style=color:#000;font-weight:700>),</span>
    <span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Tbody</span><span style=color:#000;font-weight:700>([</span>
      <span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Tr</span><span style=color:#000;font-weight:700>([</span>
          <span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Td</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dataframe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>iloc</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>][</span><span style=color:#000>col</span><span style=color:#000;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>col</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>dataframe</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>columns</span>
      <span style=color:#000;font-weight:700>])</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>i</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#204a87>range</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>min</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dataframe</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>max_rows</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000;font-weight:700>])</span>
  <span style=color:#000;font-weight:700>])</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>generate_top_referes</span><span style=color:#000;font-weight:700>():</span>
  <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#000>top_refs</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
  <span style=color:#000>top_refs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>H3</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Top Referers&#39;</span><span style=color:#000;font-weight:700>))</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>top_ref</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>get_top_referers</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>months_report</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
    <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>H4</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s3_file_names</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>idx</span><span style=color:#000;font-weight:700>]))</span>
    <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>generate_table</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>top_ref</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>top_refs</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Div</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;row&#39;</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
</code></pre></div><p>This yields a simple table:</p><p><img src=/img/top_referers_2020.11.png alt="Top Referers"></p><h3 id=top-posts>Top Posts</h3><p>This metric is about the most visited posts. I had to remove the CSS, fonts, etc., urls.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Python data-lang=Python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get_top_posts</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>months_report</span><span style=color:#000;font-weight:700>):</span>
  <span style=color:#000>top_urls</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>df</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>months_report</span><span style=color:#000;font-weight:700>:</span>
    <span style=color:#000>df</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>df</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>df</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;CsUriStreamClean&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>str</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>contains</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;posts&#39;</span><span style=color:#000;font-weight:700>)]</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>copy</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>top_url</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>df</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>groupby</span><span style=color:#000;font-weight:700>([</span><span style=color:#4e9a06>&#39;CsUriStreamClean&#39;</span><span style=color:#000;font-weight:700>])[</span><span style=color:#4e9a06>&#39;CsUriStreamClean&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nlargest</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>to_frame</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>top_url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>rename</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>columns</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#39;CsUriStreamClean&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#39;Cnt&#39;</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000>errors</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;raise&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>inplace</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>top_url</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>reset_index</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>level</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>inplace</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>top_urls</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>top_url</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>top_urls</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Python data-lang=Python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>generate_top_posts</span><span style=color:#000;font-weight:700>():</span>
  <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#000>top_posts</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
  <span style=color:#000>top_posts</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>H3</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Top Posts&#39;</span><span style=color:#000;font-weight:700>))</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>top_url</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>get_top_posts</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>months_report</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
    <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>H4</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s3_file_names</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>idx</span><span style=color:#000;font-weight:700>]))</span>
    <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>generate_table</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>top_url</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>top_posts</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Div</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;row&#39;</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
</code></pre></div><p>And it looks like this:</p><p><img src=/img/top_posts_2020.11.png alt="Top Posts"></p><h3 id=top-iatas>Top IATAs</h3><p>I was also curious a bit about where the readers are from. AWS uses IATA code for naming their pops. This is easy to visualize:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Python data-lang=Python>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get_iata_codes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>months_report</span><span style=color:#000;font-weight:700>):</span>
  <span style=color:#000>top_iata</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>df</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>months_report</span><span style=color:#000;font-weight:700>:</span>
    <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>df</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>groupby</span><span style=color:#000;font-weight:700>([</span><span style=color:#4e9a06>&#39;IATA&#39;</span><span style=color:#000;font-weight:700>])[</span><span style=color:#4e9a06>&#39;hcip&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>count</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>nlargest</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>to_frame</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>fig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>px</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>bar</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>index</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hcip</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>top_iata</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fig</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>top_iata</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>generate_top_iata</span><span style=color:#000;font-weight:700>():</span>
  <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#000>top_iatas</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
  <span style=color:#000>top_iatas</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>H3</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Top IATAs&#39;</span><span style=color:#000;font-weight:700>))</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>top_iata</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>get_iata_codes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>months_report</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
    <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>H4</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s3_file_names</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>idx</span><span style=color:#000;font-weight:700>]))</span>
    <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dcc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Graph</span><span style=color:#000;font-weight:700>(</span>
        <span style=color:#204a87>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Top IATA codes where readers are {}&#39;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>format</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx</span><span style=color:#000;font-weight:700>),</span>
        <span style=color:#000>figure</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>top_iata</span>
    <span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>top_iatas</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Div</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;row&#39;</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
</code></pre></div><p>Using a simple bar chart:</p><p><img src=/img/top_iatas_2020.11.png alt="Top Posts"></p><p>Full code is <a href=https://github.com/l1x/s3logs/blob/main/viz/viz.py>here</a>.</p><h3 id=hit-distribution-over-time>Hit distribution over time</h3><p>For this metric, it would be great to use a heatmap. Luckily Plotly has a highly customizable heatmap that is easy to use.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Python data-lang=Python>
<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>visitor_heatmap</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>df</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>scale</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;lin&#39;</span><span style=color:#000;font-weight:700>):</span>

  <span style=color:#000>dfa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>convert_to_time_indexed</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>generate_aggregates</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>df</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;day&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;hour&#39;</span><span style=color:#000;font-weight:700>],</span> <span style=color:#4e9a06>&#39;ScStatus&#39;</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;day&#39;</span><span style=color:#000;font-weight:700>)</span>

  <span style=color:#000>size_lin</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>dfa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Cnt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>values</span>
  <span style=color:#000>size_log_2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dfa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Cnt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>values</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>np</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>log</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span>

  <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>size_lin</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>scale</span><span style=color:#ce5c00;font-weight:700>==</span><span style=color:#4e9a06>&#39;lin&#39;</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000>size_log_2</span>

  <span style=color:#000>fig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>go</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Figure</span><span style=color:#000;font-weight:700>(</span>
    <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>go</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Scattergl</span><span style=color:#000;font-weight:700>(</span>
      <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>dfa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>index</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>dfa</span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;hour&#39;</span><span style=color:#000;font-weight:700>],</span>
      <span style=color:#000>mode</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;markers&#39;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#000>marker</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>dict</span><span style=color:#000;font-weight:700>(</span>
        <span style=color:#000>color</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>dfa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Cnt</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#000>colorscale</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;portland&#39;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#000>line_width</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#000>showscale</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#3465a4>True</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#000>sizemin</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span>
      <span style=color:#000;font-weight:700>)</span>
    <span style=color:#000;font-weight:700>)</span>
  <span style=color:#000;font-weight:700>)</span>

  <span style=color:#000>fig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>update_layout</span><span style=color:#000;font-weight:700>(</span>
    <span style=color:#000>height</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>600</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>title_text</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Number of request per hour over time&#39;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>yaxis_nticks</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>xaxis_nticks</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>31</span>
  <span style=color:#000;font-weight:700>)</span>

  <span style=color:#000>fig</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>update_yaxes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>autorange</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;reversed&#34;</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fig</span>


<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>get_visiting_times</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>months_report</span><span style=color:#000;font-weight:700>):</span>
  <span style=color:#000>times</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>df</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>months_report</span><span style=color:#000;font-weight:700>:</span>
    <span style=color:#000>fig</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>visitor_heatmap</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>df</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;log&#39;</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>times</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fig</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>times</span>

<span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>generate_visting_times</span><span style=color:#000;font-weight:700>():</span>
  <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#000>times</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
  <span style=color:#000>times</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>H3</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Visiting Times&#39;</span><span style=color:#000;font-weight:700>))</span>
  <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>time_fig</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>get_visiting_times</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>months_report</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>children</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
    <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>H4</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s3_file_names</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>idx</span><span style=color:#000;font-weight:700>]))</span>
    <span style=color:#000>children</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dcc</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Graph</span><span style=color:#000;font-weight:700>(</span>
        <span style=color:#204a87>id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Hit distribution over time {}&#39;</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>format</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx</span><span style=color:#000;font-weight:700>),</span>
        <span style=color:#000>figure</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>time_fig</span>
    <span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>times</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>html</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>Div</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>children</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>className</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;row&#39;</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>idx</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#0000cf;font-weight:700>1</span>
</code></pre></div><p><img src=/img/visiting_times_2020.11.png alt="Visiting Times"></p><p>Full code is <a href=https://github.com/l1x/s3logs/blob/main/viz/viz.py>here</a>.</p></div></div></body><footer class="mw8-l center pa4"><a href=https://github.com/l1x class=pa2><i class="fab fa-github fa-2x"></i></a><a href=https://twitter.com/lix class=pa2><i class="fab fa-twitter fa-2x"></i></a><a href=https://www.linkedin.com/in/iszukacs class=pa2><i class="fab fa-linkedin fa-2x"></i></a><a href=https://dev.to/l1x class=pa2><i class="fab fa-dev fa-2x"></i></a></footer></html>