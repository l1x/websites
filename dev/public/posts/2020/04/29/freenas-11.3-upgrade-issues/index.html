<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=/css/dosis.min.css><link rel=stylesheet href=/css/tachyons.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/fontawesome.min.css><title>l1x/dev | FreeNAS 11.3 upgrade issues</title><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/img/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><meta name=image property="og:image" content><meta name=title property="og:title" content="FreeNAS 11.3 upgrade issues"><meta name=description property="og:description" content="How to roll back to a previous version"><meta name=type property="og:type" content="article"><meta name=url property="og:url" content="https://dev.l1x.be/posts/2020/04/29/freenas-11.3-upgrade-issues/"><meta name=author content="l1x"></head><body><div class="content mw8-l center pl4"><header class="flex mw8-l center pt4"><div class=pt3><img src=/img/apple-touch-icon.png width=60></div><a href=/ class="title link pl3 pt2"><h1>l1x/dev</h1></a></header><h2 class=post-title>FreeNAS 11.3 upgrade issues</h2><div class=gray>2020/04/29 :: #freebsd #freenas #rollback #jail</div><div class="f4 lh-copy"><p>I have an interesting experience with the latest upgrade of FreeNAS 11.3-U2.1. Applications that were deployed in the jail were gone. After fiddling with iocage (the tool that FreeNAS provides to manage jails) I could restore a previous state where all seems fine and dandy.</p><h2 id=steps-to-restore>Steps to restore</h2><ul><li>list of snapshots</li></ul><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>iocage snaplist tr -l
+-------------------------------------------------------------------------+-----------------------+-------+-------+
<span style=color:#111>|</span>                                  NAME                                   <span style=color:#111>|</span>        CREATED        <span style=color:#111>|</span> RSIZE <span style=color:#111>|</span> USED  <span style=color:#111>|</span>
+<span style=color:#f92672>=========================================================================</span>+<span style=color:#f92672>=======================</span>+<span style=color:#f92672>=======</span>+<span style=color:#f92672>=======</span>+
<span style=color:#111>|</span> fux/iocage/jails/tr/root@ioc_plugin_update_2020-04-29                   <span style=color:#111>|</span> Wed Apr <span style=color:#ae81ff>29</span> 14:55 <span style=color:#ae81ff>2020</span> <span style=color:#111>|</span> 799G  <span style=color:#111>|</span> 11.6K <span style=color:#111>|</span>
+-------------------------------------------------------------------------+-----------------------+-------+-------+
<span style=color:#111>|</span> fux/iocage/jails/tr/root@ioc_update_11.3-RELEASE-p8_2020-04-29_14-55-07 <span style=color:#111>|</span> Wed Apr <span style=color:#ae81ff>29</span> 14:55 <span style=color:#ae81ff>2020</span> <span style=color:#111>|</span> 799G  <span style=color:#111>|</span> 575K  <span style=color:#111>|</span>
+-------------------------------------------------------------------------+-----------------------+-------+-------+
<span style=color:#111>|</span> fux/iocage/jails/tr/root@ioc_update_11.3-RELEASE-p8_2020-04-29_14-55-22 <span style=color:#111>|</span> Wed Apr <span style=color:#ae81ff>29</span> 14:55 <span style=color:#ae81ff>2020</span> <span style=color:#111>|</span> 799G  <span style=color:#111>|</span> 11.6K <span style=color:#111>|</span>
+-------------------------------------------------------------------------+-----------------------+-------+-------+
<span style=color:#111>|</span> fux/iocage/jails/tr@ioc_plugin_update_2020-04-29                        <span style=color:#111>|</span> Wed Apr <span style=color:#ae81ff>29</span> 14:55 <span style=color:#ae81ff>2020</span> <span style=color:#111>|</span> 517K  <span style=color:#111>|</span> 81.4K <span style=color:#111>|</span>
+-------------------------------------------------------------------------+-----------------------+-------+-------+
<span style=color:#111>|</span> fux/iocage/jails/tr@ioc_update_11.3-RELEASE-p8_2020-04-29_14-55-07      <span style=color:#111>|</span> Wed Apr <span style=color:#ae81ff>29</span> 14:55 <span style=color:#ae81ff>2020</span> <span style=color:#111>|</span> 517K  <span style=color:#111>|</span> 81.4K <span style=color:#111>|</span>
+-------------------------------------------------------------------------+-----------------------+-------+-------+
<span style=color:#111>|</span> fux/iocage/jails/tr@ioc_update_11.3-RELEASE-p8_2020-04-29_14-55-22      <span style=color:#111>|</span> Wed Apr <span style=color:#ae81ff>29</span> 14:55 <span style=color:#ae81ff>2020</span> <span style=color:#111>|</span> 517K  <span style=color:#111>|</span> 81.4K <span style=color:#111>|</span>
+-------------------------------------------------------------------------+-----------------------+-------+-------+
</code></pre></div><ul><li>stop the jail</li></ul><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>root@freenas<span style=color:#f92672>[</span>~<span style=color:#f92672>]</span><span style=color:#75715e># iocage stop tr</span>
* Stopping tr
  + Executing prestop OK
  + Stopping services OK
  + Tearing down VNET OK
  + Removing devfs_ruleset: <span style=color:#ae81ff>5</span> OK
  + Removing jail process OK
  + Executing poststop OK
</code></pre></div><ul><li>rollback</li></ul><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>root@freenas<span style=color:#f92672>[</span>~<span style=color:#f92672>]</span><span style=color:#75715e># iocage rollback tr -n ioc_update_11.3-RELEASE-p8_2020-04-29_14-55-07</span>

This will destroy ALL data created including ALL snapshots taken after the snapshot ioc_update_11.3-RELEASE-p8_2020-04-29_14-55-07

Are you sure? <span style=color:#f92672>[</span>y/N<span style=color:#f92672>]</span>: y
Rolled back to: fux/iocage/jails/tr
</code></pre></div><ul><li>start the jail</li></ul><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>root@freenas<span style=color:#f92672>[</span>~<span style=color:#f92672>]</span><span style=color:#75715e># iocage start tr</span>
No default gateway found <span style=color:#00a8c8>for</span> ipv6.
* Starting tr
  + Started OK
  + Using devfs_ruleset: <span style=color:#ae81ff>5</span>
  + Configuring VNET OK
  + Using IP options: vnet
  + Starting services OK
  + Executing poststart OK
  + DHCP Address: 192.168.1.111/24
</code></pre></div><p>And we are back.</p></div></div></body><footer class="mw8-l center pa4"><a href=https://github.com/l1x class=pa2><i class="fab fa-github fa-2x"></i></a><a href=https://twitter.com/lix class=pa2><i class="fab fa-twitter fa-2x"></i></a><a href=https://www.linkedin.com/in/iszukacs class=pa2><i class="fab fa-linkedin fa-2x"></i></a><a href=https://dev.to/l1x class=pa2><i class="fab fa-dev fa-2x"></i></a></footer></html>