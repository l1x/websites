<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=/css/dosis.min.css><link rel=stylesheet href=/css/tachyons.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/fontawesome.min.css><title>l1x/dev | Matching binary patterns</title><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/img/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><meta name=image property="og:image" content="/img/elafi_logo.png"><meta name=title property="og:title" content="Matching binary patterns"><meta name=description property="og:description" content="Using binary pattern matching for working with network protocols"><meta name=type property="og:type" content="article"><meta name=url property="og:url" content="https://dev.l1x.be/posts/2020/04/29/matching-binary-patterns/"><meta name=author content="l1x"></head><body><div class="content mw8-l center pl4"><header class="flex mw8-l center pt4"><div class=pt3><img src=/img/apple-touch-icon.png width=60></div><a href=/ class="title link pl3 pt2"><h1>l1x/dev</h1></a></header><h2 class=post-title>Matching binary patterns</h2><div class=white>2020/04/29 :: #erlang #beam #elixir</div><div class="f4 lh-copy"><h1 id=matching-binary-patterns>Matching binary patterns</h1><p>In Erlang, it is easy to construct binaries and bitstrings and matching binary patterns. I was running into Mitchell Perilstein&rsquo;s excellent work on NTP with Erlang and I thought I am going to use this to explain how bitstrings and binaries work in Erlang.</p><p>Two concepts:</p><ul><li><p>A bitstring is a sequence of zero or more bits, where the number of bits does not need to be divisible by 8.</p></li><li><p>A binary is when the number of bits is divisible by 8.</p></li></ul><p>The syntax is as follows:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang> &lt;&lt;<span style=color:#40ffff>B1</span>, <span style=color:#40ffff>B2</span>, ... <span style=color:#40ffff>Bn</span>&gt;&gt;
</code></pre></div><p>Each element specifies a certain segment of the bitstring. A segment is a set of contiguous bits of the binary (not necessarily on a byte boundary).</p><p>A real-life example:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang> &lt;&lt; <span style=color:#3677a9>0</span>:<span style=color:#3677a9>2</span>, <span style=color:#3677a9>4</span>:<span style=color:#3677a9>3</span>, <span style=color:#3677a9>3</span>:<span style=color:#3677a9>3</span>,  <span style=color:#3677a9>0</span>:(<span style=color:#3677a9>3</span>*<span style=color:#3677a9>8</span> + <span style=color:#3677a9>3</span>*<span style=color:#3677a9>32</span> + <span style=color:#3677a9>4</span>*<span style=color:#3677a9>64</span>) &gt;&gt;.
</code></pre></div><p>Let&rsquo;s unpack a bit of what is going on here. For this, it is worth knowing the whole syntax.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang>&lt;&lt; <span style=color:#40ffff>Value</span>:<span style=color:#40ffff>Size</span>/<span style=color:#40ffff>TypeSpecifierList</span>, <span style=color:#40ffff>Value</span>:<span style=color:#40ffff>Size</span>/<span style=color:#40ffff>TypeSpecifierList</span>, ...&gt;&gt;
</code></pre></div><p>Or alternatively:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang><span style=color:#40ffff>Ei</span> = <span style=color:#40ffff>Value</span> |
     <span style=color:#40ffff>Value</span>:<span style=color:#40ffff>Size</span> |
     <span style=color:#40ffff>Value</span>/<span style=color:#40ffff>TypeSpecifierList</span> |
     <span style=color:#40ffff>Value</span>:<span style=color:#40ffff>Size</span>/<span style=color:#40ffff>TypeSpecifierList</span>
</code></pre></div><p>This means in the real-life example, we have 0 as the value, 2 is the size (2 bits), four as a value, 3 bits as size, and so on. We did not specify any of the type specifiers.</p><p>TypeSpecifierList is a list of type specifiers, in any order, separated by hyphens or dash (-). Default values are used for any omitted type specifier.</p><p>The following type specifiers are supported:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang><span style=color:#40ffff>Type</span> = integer | <span style=color:#24909d>float</span> | binary | bytes | bitstring | bits | utf8 | utf16 | utf32
</code></pre></div><p>The default is an integer. bytes is a shorthand for binary and bits is a shorthand for bitstring.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang><span style=color:#40ffff>Signedness</span>= signed | unsigned
</code></pre></div><p>It only matters for matching and when the type is an integer. The default is unsigned.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang><span style=color:#40ffff>Endianness</span>= big | little | native
</code></pre></div><p>Native-endian means that the endianness is resolved at load time to be either big-endian or little-endian, depending on what is native for the CPU that the Erlang machine is run on. Endianness only matters when the Type is either integer, utf16, utf32, or float. The default is big.</p><h2 id=a-complete-example>A complete example</h2><p>One of the simplest protocols out there is NTP. The header file looks like the following:</p><p><img src=https://dev-to-uploads.s3.amazonaws.com/i/imigpr35l0uhlkpbbh74.png alt="Alt Text"></p><p>This is used for both the request and the response. Let&rsquo;s craft the request first.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang><span style=color:#447fcf>create_ntp_request</span>() -&gt;
  &lt;&lt; <span style=color:#3677a9>0</span>:<span style=color:#3677a9>2</span>, <span style=color:#3677a9>4</span>:<span style=color:#3677a9>3</span>, <span style=color:#3677a9>3</span>:<span style=color:#3677a9>3</span>,  <span style=color:#3677a9>0</span>:(<span style=color:#3677a9>3</span>*<span style=color:#3677a9>8</span> + <span style=color:#3677a9>3</span>*<span style=color:#3677a9>32</span> + <span style=color:#3677a9>4</span>*<span style=color:#3677a9>64</span>) &gt;&gt;.
</code></pre></div><p>Based on the header structure we can see that we have a 2-bit integer (Li), 3-bit integer version number, 3-bit integer mode, 8-bit stratum, 8-bit poll, 8-bit precision, and so on. We only need to set the first 3 values, the rest (376 bits) can be 0.</p><p>Let&rsquo;s try this in the wild.</p><h3 id=creating-the-request>Creating the request</h3><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang><span style=color:#3677a9>1</span>&gt; <span style=color:#40ffff>Request</span> = &lt;&lt; <span style=color:#3677a9>0</span>:<span style=color:#3677a9>2</span>, <span style=color:#3677a9>4</span>:<span style=color:#3677a9>3</span>, <span style=color:#3677a9>3</span>:<span style=color:#3677a9>3</span>,  <span style=color:#3677a9>0</span>:(<span style=color:#3677a9>3</span>*<span style=color:#3677a9>8</span> + <span style=color:#3677a9>3</span>*<span style=color:#3677a9>32</span> + <span style=color:#3677a9>4</span>*<span style=color:#3677a9>64</span>) &gt;&gt;.
&lt;&lt;<span style=color:#3677a9>35</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,
  <span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,...&gt;&gt;
</code></pre></div><h3 id=sending-and-receiving>Sending and receiving</h3><p>We can use Erlang&rsquo;s built-in functions for this one, gen_udp has a pretty comprehensive low-level UDP implementation, that can do all we want.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang>
<span style=color:#999;font-style:italic>% open a local socket, 0 indicates that it will pick a random local port
</span><span style=color:#999;font-style:italic>% active=false means we need to receive ourselves
</span><span style=color:#999;font-style:italic></span>
<span style=color:#3677a9>2</span>&gt; {ok, <span style=color:#40ffff>Socket</span>} = <span style=color:#447fcf;text-decoration:underline>gen_udp</span>:<span style=color:#447fcf>open</span>(<span style=color:#3677a9>0</span>, [binary, {active, false}]),
<span style=color:#3677a9>2</span>&gt; <span style=color:#447fcf;text-decoration:underline>gen_udp</span>:<span style=color:#24909d>send</span>(<span style=color:#40ffff>Socket</span>, <span style=color:#ed9d13>&#34;0.europe.pool.ntp.org&#34;</span>, <span style=color:#3677a9>123</span>, <span style=color:#40ffff>Request</span>),
<span style=color:#3677a9>2</span>&gt; {ok, {_<span style=color:#40ffff>Address</span>, _<span style=color:#40ffff>Port</span>, <span style=color:#40ffff>Resp</span>}} = <span style=color:#447fcf;text-decoration:underline>gen_udp</span>:<span style=color:#447fcf>recv</span>(<span style=color:#40ffff>Socket</span>, <span style=color:#3677a9>0</span>, <span style=color:#3677a9>500</span>).
{ok,{{<span style=color:#3677a9>212</span>,<span style=color:#3677a9>59</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>1</span>},
     <span style=color:#3677a9>123</span>,
     &lt;&lt;<span style=color:#3677a9>36</span>,<span style=color:#3677a9>2</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>231</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>110</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>25</span>,<span style=color:#3677a9>212</span>,<span style=color:#3677a9>59</span>,<span style=color:#3677a9>3</span>,<span style=color:#3677a9>3</span>,<span style=color:#3677a9>226</span>,<span style=color:#3677a9>84</span>,<span style=color:#3677a9>62</span>,<span style=color:#3677a9>89</span>,
       <span style=color:#3677a9>208</span>,<span style=color:#3677a9>192</span>,<span style=color:#3677a9>202</span>,<span style=color:#3677a9>156</span>,...&gt;&gt;}}
</code></pre></div><h3 id=processing-the-response-first-few-bits>Processing the response, first few bits</h3><p>The response is just a binary that we need to slice and dice, similarly how we created the request.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang><span style=color:#3677a9>3</span>&gt; <span style=color:#40ffff>Resp</span>.
&lt;&lt;<span style=color:#3677a9>36</span>,<span style=color:#3677a9>2</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>231</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>110</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>25</span>,<span style=color:#3677a9>212</span>,<span style=color:#3677a9>59</span>,<span style=color:#3677a9>3</span>,<span style=color:#3677a9>3</span>,<span style=color:#3677a9>226</span>,<span style=color:#3677a9>84</span>,<span style=color:#3677a9>62</span>,<span style=color:#3677a9>89</span>,
  <span style=color:#3677a9>208</span>,<span style=color:#3677a9>192</span>,<span style=color:#3677a9>202</span>,<span style=color:#3677a9>156</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,...&gt;&gt;
</code></pre></div><p>First, we can just get the first few bits.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang><span style=color:#3677a9>4</span>&gt; &lt;&lt; <span style=color:#40ffff>Li</span>:<span style=color:#3677a9>2</span>, <span style=color:#40ffff>Version</span>:<span style=color:#3677a9>3</span>, <span style=color:#40ffff>Mode</span>:<span style=color:#3677a9>3</span>, _rest/binary &gt;&gt; = <span style=color:#40ffff>Resp</span>.
&lt;&lt;<span style=color:#3677a9>36</span>,<span style=color:#3677a9>2</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>231</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>110</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>25</span>,<span style=color:#3677a9>212</span>,<span style=color:#3677a9>59</span>,<span style=color:#3677a9>3</span>,<span style=color:#3677a9>3</span>,<span style=color:#3677a9>226</span>,<span style=color:#3677a9>84</span>,<span style=color:#3677a9>62</span>,<span style=color:#3677a9>89</span>,
  <span style=color:#3677a9>208</span>,<span style=color:#3677a9>192</span>,<span style=color:#3677a9>202</span>,<span style=color:#3677a9>156</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,...&gt;&gt;
<span style=color:#3677a9>5</span>&gt; {li, <span style=color:#40ffff>Li</span>, version, <span style=color:#40ffff>Version</span>, mode, <span style=color:#40ffff>Mode</span>}.
{li,<span style=color:#3677a9>0</span>,version,<span style=color:#3677a9>4</span>,mode,<span style=color:#3677a9>4</span>}
</code></pre></div><p>It works.</p><p>The rest of the header a bit more tricky but with the bitstring syntax, it is easy to manage.</p><h3 id=processing-the-response-the-rest>Processing the response, the rest</h3><p>Finally matching all the mandatory fields.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang><span style=color:#3677a9>6</span>&gt;   &lt;&lt; <span style=color:#40ffff>LI</span>:<span style=color:#3677a9>2</span>, <span style=color:#40ffff>Version</span>:<span style=color:#3677a9>3</span>, <span style=color:#40ffff>Mode</span>:<span style=color:#3677a9>3</span>, <span style=color:#40ffff>Stratum</span>:<span style=color:#3677a9>8</span>, <span style=color:#40ffff>Poll</span>:<span style=color:#3677a9>8</span>/signed, <span style=color:#40ffff>Precision</span>:<span style=color:#3677a9>8</span>/signed,
<span style=color:#3677a9>6</span>&gt;      <span style=color:#40ffff>RootDel</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>RootDisp</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>R1</span>:<span style=color:#3677a9>8</span>, <span style=color:#40ffff>R2</span>:<span style=color:#3677a9>8</span>, <span style=color:#40ffff>R3</span>:<span style=color:#3677a9>8</span>, <span style=color:#40ffff>R4</span>:<span style=color:#3677a9>8</span>, <span style=color:#40ffff>RtsI</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>RtsF</span>:<span style=color:#3677a9>32</span>,
<span style=color:#3677a9>6</span>&gt;      <span style=color:#40ffff>OtsI</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>OtsF</span>:<span style=color:#3677a9>32</span>,   <span style=color:#40ffff>RcvI</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>RcvF</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>XmtI</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>XmtF</span>:<span style=color:#3677a9>32</span> &gt;&gt; = <span style=color:#40ffff>Resp</span>.
&lt;&lt;<span style=color:#3677a9>36</span>,<span style=color:#3677a9>2</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>231</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>110</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>25</span>,<span style=color:#3677a9>212</span>,<span style=color:#3677a9>59</span>,<span style=color:#3677a9>3</span>,<span style=color:#3677a9>3</span>,<span style=color:#3677a9>226</span>,<span style=color:#3677a9>84</span>,<span style=color:#3677a9>62</span>,<span style=color:#3677a9>89</span>,
  <span style=color:#3677a9>208</span>,<span style=color:#3677a9>192</span>,<span style=color:#3677a9>202</span>,<span style=color:#3677a9>156</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,<span style=color:#3677a9>0</span>,...&gt;&gt;
</code></pre></div><p>Making sense of these values requires a bit more legwork. First, we need a utility function for binary fractions.</p><p>In Erlang, function arity differentiates functions so we can do the following:</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang><span style=color:#447fcf>binfrac</span>(<span style=color:#40ffff>Bin</span>) -&gt;
  binfrac(<span style=color:#40ffff>Bin</span>, <span style=color:#3677a9>2</span>, <span style=color:#3677a9>0</span>).
<span style=color:#447fcf>binfrac</span>(<span style=color:#3677a9>0</span>, _, <span style=color:#40ffff>Frac</span>) -&gt;
  <span style=color:#40ffff>Frac</span>;
<span style=color:#447fcf>binfrac</span>(<span style=color:#40ffff>Bin</span>, <span style=color:#40ffff>N</span>, <span style=color:#40ffff>Frac</span>) -&gt;
  binfrac(<span style=color:#40ffff>Bin</span> <span style=color:#6ab825;font-weight:700>bsr</span> <span style=color:#3677a9>1</span>, <span style=color:#40ffff>N</span>*<span style=color:#3677a9>2</span>, <span style=color:#40ffff>Frac</span> + (<span style=color:#40ffff>Bin</span> <span style=color:#6ab825;font-weight:700>band</span> <span style=color:#3677a9>1</span>)/<span style=color:#40ffff>N</span>).
</code></pre></div><p>With this function, we can implement the one that processes the response and returns the values we are interested in.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang><span style=color:#999;font-style:italic>% 2208988800 is the offset (1900 to Unix epoch)
</span><span style=color:#999;font-style:italic></span>
<span style=color:#447fcf>process_ntp_response</span>(<span style=color:#40ffff>Ntp_response</span>) -&gt;
  &lt;&lt; <span style=color:#40ffff>LI</span>:<span style=color:#3677a9>2</span>, <span style=color:#40ffff>Version</span>:<span style=color:#3677a9>3</span>, <span style=color:#40ffff>Mode</span>:<span style=color:#3677a9>3</span>, <span style=color:#40ffff>Stratum</span>:<span style=color:#3677a9>8</span>, <span style=color:#40ffff>Poll</span>:<span style=color:#3677a9>8</span>/signed, <span style=color:#40ffff>Precision</span>:<span style=color:#3677a9>8</span>/signed,
     <span style=color:#40ffff>RootDel</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>RootDisp</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>R1</span>:<span style=color:#3677a9>8</span>, <span style=color:#40ffff>R2</span>:<span style=color:#3677a9>8</span>, <span style=color:#40ffff>R3</span>:<span style=color:#3677a9>8</span>, <span style=color:#40ffff>R4</span>:<span style=color:#3677a9>8</span>, <span style=color:#40ffff>RtsI</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>RtsF</span>:<span style=color:#3677a9>32</span>,
     <span style=color:#40ffff>OtsI</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>OtsF</span>:<span style=color:#3677a9>32</span>,   <span style=color:#40ffff>RcvI</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>RcvF</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>XmtI</span>:<span style=color:#3677a9>32</span>, <span style=color:#40ffff>XmtF</span>:<span style=color:#3677a9>32</span> &gt;&gt; = <span style=color:#40ffff>Ntp_response</span>,
  {<span style=color:#40ffff>NowMS</span>, <span style=color:#40ffff>NowS</span>, <span style=color:#40ffff>NowUS</span>} = <span style=color:#447fcf;text-decoration:underline>erlang</span>:<span style=color:#447fcf>timestamp</span>(),
  <span style=color:#40ffff>NowTimestamp</span> = <span style=color:#40ffff>NowMS</span> * <span style=color:#3677a9>1</span>.<span style=color:#3677a9>0</span>e6 + <span style=color:#40ffff>NowS</span> + <span style=color:#40ffff>NowUS</span>/<span style=color:#3677a9>1000</span>,
  <span style=color:#40ffff>TransmitTimestamp</span> = <span style=color:#40ffff>XmtI</span> - <span style=color:#3677a9>2208988800</span> + binfrac(<span style=color:#40ffff>XmtF</span>),
  { {li, <span style=color:#40ffff>LI</span>}, {vn, <span style=color:#40ffff>Version</span>}, {mode, <span style=color:#40ffff>Mode</span>}, {stratum, <span style=color:#40ffff>Stratum</span>}, {poll, <span style=color:#40ffff>Poll</span>}, {precision, <span style=color:#40ffff>Precision</span>},
    {rootDelay, <span style=color:#40ffff>RootDel</span>}, {rootDispersion, <span style=color:#40ffff>RootDisp</span>}, {referenceId, <span style=color:#40ffff>R1</span>, <span style=color:#40ffff>R2</span>, <span style=color:#40ffff>R3</span>, <span style=color:#40ffff>R4</span>},
    {referenceTimestamp, <span style=color:#40ffff>RtsI</span> - <span style=color:#3677a9>2208988800</span> + binfrac(<span style=color:#40ffff>RtsF</span>)},
    {originateTimestamp, <span style=color:#40ffff>OtsI</span> - <span style=color:#3677a9>2208988800</span> + binfrac(<span style=color:#40ffff>OtsF</span>)},
    {receiveTimestamp,   <span style=color:#40ffff>RcvI</span> - <span style=color:#3677a9>2208988800</span> + binfrac(<span style=color:#40ffff>RcvF</span>)},
    {transmitTimestamp,  <span style=color:#40ffff>TransmitTimestamp</span>},
    {clientReceiveTimestamp, <span style=color:#40ffff>NowTimestamp</span>},
    {offset, <span style=color:#40ffff>TransmitTimestamp</span> - <span style=color:#40ffff>NowTimestamp</span>} }.
</code></pre></div><p>And wit that we can just process the response.</p><div class=highlight><pre style=color:#d0d0d0;background-color:#202020;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-erlang data-lang=erlang>{{li,<span style=color:#3677a9>0</span>},
 {vn,<span style=color:#3677a9>4</span>},
 {mode,<span style=color:#3677a9>4</span>},
 {stratum,<span style=color:#3677a9>2</span>},
 {poll,<span style=color:#3677a9>3</span>},
 {precision,-<span style=color:#3677a9>24</span>},
 {rootDelay,<span style=color:#3677a9>9</span>},
 {rootDispersion,<span style=color:#3677a9>140</span>},
 {referenceId,<span style=color:#3677a9>85</span>,<span style=color:#3677a9>158</span>,<span style=color:#3677a9>25</span>,<span style=color:#3677a9>75</span>},
 {referenceTimestamp,<span style=color:#3677a9>1588186010</span>.<span style=color:#3677a9>7517557</span>},
 {originateTimestamp,-<span style=color:#3677a9>2208988800</span>},
 {receiveTimestamp,<span style=color:#3677a9>1588186048</span>.<span style=color:#3677a9>3557627</span>},
 {transmitTimestamp,<span style=color:#3677a9>1588186048</span>.<span style=color:#3677a9>8841336</span>},
 {clientReceiveTimestamp,<span style=color:#3677a9>1588186606</span>.<span style=color:#3677a9>531</span>},
 {offset,-<span style=color:#3677a9>557</span>.<span style=color:#3677a9>6468663215637</span>}}
</code></pre></div><p>Please note, this is the first step in the NTP workflow and does not implement the complete NTP protocol. We do not take into consideration a bunch of details.</p><p>Next time we might look into how to implement a simple server (like DNS) in Erlang.</p><p>Michael&rsquo;s original work:</p><p><a href=https://github.com/mnp/erlang-ntp>https://github.com/mnp/erlang-ntp</a></p><p>Up to date version and Elixir port:</p><p><a href=https://gist.github.com/l1x/b0a7f844b283ac08e3125d1ba6e81eeb>https://gist.github.com/l1x/b0a7f844b283ac08e3125d1ba6e81eeb</a></p></div></div></body><footer class="mw8-l center pa4"><a href=https://github.com/l1x class=pa2><i class="fab fa-github fa-2x"></i></a><a href=https://twitter.com/lix class=pa2><i class="fab fa-twitter fa-2x"></i></a><a href=https://www.linkedin.com/in/iszukacs class=pa2><i class="fab fa-linkedin fa-2x"></i></a><a href=https://dev.to/l1x class=pa2><i class="fab fa-dev fa-2x"></i></a></footer></html>