<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>


<link rel="stylesheet" href="/css/tachyons.min.css">


<link rel="stylesheet" href="/css/style.min.css">

<title>l1x/dev | Matching binary patterns </title>
    


    
  </head>
<body class="body bg-near-white">

  <header class="bg-dark-gray pt3">
  <div class="mw9 mw8-ns center ph3-ns">
    <div class="pa1">
      <a href="/" class="header-logo link near-white">
        <div class="pr3 f2 lh-copy">l1x/dev</div>
      </a>
    </div>
    <div class="pa2 tc">
      <a href="https://github.com/l1x" class="pa2 link dim near-white">Github</a>
      <a href="https://twitter.com/lix" class="pa2 link dim near-white">Twitter</a>
      <a href="https://www.linkedin.com/in/iszukacs/" class="pa2 link dim near-white">Linkedin</a>
    </div>
  </div>
</header>

  
  
  <div class="mw9 mw8-ns center ph3-ns bg-white f5 dark-gray">
    <h1 id="matching-binary-patterns">Matching binary patterns</h1>
<p>In Erlang, it is easy to construct binaries and bitstrings and matching binary patterns. I was running into Mitchell Perilstein&rsquo;s excellent work on NTP with Erlang and I thought I am going to use this to explain how bitstrings and binaries work in Erlang.</p>
<p>Two concepts:</p>
<ul>
<li>
<p>A bitstring is a sequence of zero or more bits, where the number of bits does not need to be divisible by 8.</p>
</li>
<li>
<p>A binary is when the number of bits is divisible by 8.</p>
</li>
</ul>
<p>The syntax is as follows:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"> <span style="color:#555">&lt;&lt;</span><span style="color:#033">B1</span>, <span style="color:#033">B2</span>, ... <span style="color:#033">Bn</span><span style="color:#555">&gt;&gt;</span>
</code></pre></div><p>Each element specifies a certain segment of the bitstring. A segment is a set of contiguous bits of the binary (not necessarily on a byte boundary).</p>
<p>A real-life example:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"> <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">0</span>:<span style="color:#f60">2</span>, <span style="color:#f60">4</span>:<span style="color:#f60">3</span>, <span style="color:#f60">3</span>:<span style="color:#f60">3</span>,  <span style="color:#f60">0</span>:(<span style="color:#f60">3</span><span style="color:#555">*</span><span style="color:#f60">8</span> <span style="color:#555">+</span> <span style="color:#f60">3</span><span style="color:#555">*</span><span style="color:#f60">32</span> <span style="color:#555">+</span> <span style="color:#f60">4</span><span style="color:#555">*</span><span style="color:#f60">64</span>) <span style="color:#555">&gt;&gt;</span>.
</code></pre></div><p>Let&rsquo;s unpack a bit of what is going on here. For this, it is worth knowing the whole syntax.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#555">&lt;&lt;</span> <span style="color:#033">Value</span>:<span style="color:#033">Size</span><span style="color:#555">/</span><span style="color:#033">TypeSpecifierList</span>, <span style="color:#033">Value</span>:<span style="color:#033">Size</span><span style="color:#555">/</span><span style="color:#033">TypeSpecifierList</span>, ...<span style="color:#555">&gt;&gt;</span>
</code></pre></div><p>Or alternatively:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#033">Ei</span> <span style="color:#555">=</span> <span style="color:#033">Value</span> |
     <span style="color:#033">Value</span>:<span style="color:#033">Size</span> |
     <span style="color:#033">Value</span><span style="color:#555">/</span><span style="color:#033">TypeSpecifierList</span> |
     <span style="color:#033">Value</span>:<span style="color:#033">Size</span><span style="color:#555">/</span><span style="color:#033">TypeSpecifierList</span>
</code></pre></div><p>This means in the real-life example, we have 0 as the value, 2 is the size (2 bits), four as a value, 3 bits as size, and so on. We did not specify any of the type specifiers.</p>
<p>TypeSpecifierList is a list of type specifiers, in any order, separated by hyphens or dash (-). Default values are used for any omitted type specifier.</p>
<p>The following type specifiers are supported:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#033">Type</span> <span style="color:#555">=</span> integer | <span style="color:#366">float</span> | binary | bytes | bitstring | bits | utf8 | utf16 | utf32
</code></pre></div><p>The default is an integer. bytes is a shorthand for binary and bits is a shorthand for bitstring.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#033">Signedness</span><span style="color:#555">=</span> signed | unsigned
</code></pre></div><p>It only matters for matching and when the type is an integer. The default is unsigned.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#033">Endianness</span><span style="color:#555">=</span> big | little | native
</code></pre></div><p>Native-endian means that the endianness is resolved at load time to be either big-endian or little-endian, depending on what is native for the CPU that the Erlang machine is run on. Endianness only matters when the Type is either integer, utf16, utf32, or float. The default is big.</p>
<h2 id="a-complete-example">A complete example</h2>
<p>One of the simplest protocols out there is NTP. The header file looks like the following:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/i/imigpr35l0uhlkpbbh74.png" alt="Alt Text"></p>
<p>This is used for both the request and the response. Let&rsquo;s craft the request first.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#c0f">create_ntp_request</span>() <span style="color:#555">-&gt;</span>
  <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">0</span>:<span style="color:#f60">2</span>, <span style="color:#f60">4</span>:<span style="color:#f60">3</span>, <span style="color:#f60">3</span>:<span style="color:#f60">3</span>,  <span style="color:#f60">0</span>:(<span style="color:#f60">3</span><span style="color:#555">*</span><span style="color:#f60">8</span> <span style="color:#555">+</span> <span style="color:#f60">3</span><span style="color:#555">*</span><span style="color:#f60">32</span> <span style="color:#555">+</span> <span style="color:#f60">4</span><span style="color:#555">*</span><span style="color:#f60">64</span>) <span style="color:#555">&gt;&gt;</span>.
</code></pre></div><p>Based on the header structure we can see that we have a 2-bit integer (Li), 3-bit integer version number, 3-bit integer mode, 8-bit stratum, 8-bit poll, 8-bit precision, and so on. We only need to set the first 3 values, the rest (376 bits) can be 0.</p>
<p>Let&rsquo;s try this in the wild.</p>
<h3 id="creating-the-request">Creating the request</h3>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#f60">1</span><span style="color:#555">&gt;</span> <span style="color:#033">Request</span> <span style="color:#555">=</span> <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">0</span>:<span style="color:#f60">2</span>, <span style="color:#f60">4</span>:<span style="color:#f60">3</span>, <span style="color:#f60">3</span>:<span style="color:#f60">3</span>,  <span style="color:#f60">0</span>:(<span style="color:#f60">3</span><span style="color:#555">*</span><span style="color:#f60">8</span> <span style="color:#555">+</span> <span style="color:#f60">3</span><span style="color:#555">*</span><span style="color:#f60">32</span> <span style="color:#555">+</span> <span style="color:#f60">4</span><span style="color:#555">*</span><span style="color:#f60">64</span>) <span style="color:#555">&gt;&gt;</span>.
<span style="color:#555">&lt;&lt;</span><span style="color:#f60">35</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,
  <span style="color:#f60">0</span>,<span style="color:#f60">0</span>,...<span style="color:#555">&gt;&gt;</span>
</code></pre></div><h3 id="sending-and-receiving">Sending and receiving</h3>
<p>We can use Erlang&rsquo;s built-in functions for this one, gen_udp has a pretty comprehensive low-level UDP implementation, that can do all we want.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang">
<span style="color:#09f;font-style:italic">% open a local socket, 0 indicates that it will pick a random local port
</span><span style="color:#09f;font-style:italic">% active=false means we need to receive ourselves
</span><span style="color:#09f;font-style:italic"></span>
<span style="color:#f60">2</span><span style="color:#555">&gt;</span> {ok, <span style="color:#033">Socket</span>} <span style="color:#555">=</span> <span style="color:#0cf;font-weight:bold">gen_udp</span>:<span style="color:#c0f">open</span>(<span style="color:#f60">0</span>, [binary, {active, false}]),
<span style="color:#f60">2</span><span style="color:#555">&gt;</span> <span style="color:#0cf;font-weight:bold">gen_udp</span>:<span style="color:#366">send</span>(<span style="color:#033">Socket</span>, <span style="color:#c30">&#34;0.europe.pool.ntp.org&#34;</span>, <span style="color:#f60">123</span>, <span style="color:#033">Request</span>),
<span style="color:#f60">2</span><span style="color:#555">&gt;</span> {ok, {_<span style="color:#033">Address</span>, _<span style="color:#033">Port</span>, <span style="color:#033">Resp</span>}} <span style="color:#555">=</span> <span style="color:#0cf;font-weight:bold">gen_udp</span>:<span style="color:#c0f">recv</span>(<span style="color:#033">Socket</span>, <span style="color:#f60">0</span>, <span style="color:#f60">500</span>).
{ok,{{<span style="color:#f60">212</span>,<span style="color:#f60">59</span>,<span style="color:#f60">0</span>,<span style="color:#f60">1</span>},
     <span style="color:#f60">123</span>,
     <span style="color:#555">&lt;&lt;</span><span style="color:#f60">36</span>,<span style="color:#f60">2</span>,<span style="color:#f60">0</span>,<span style="color:#f60">231</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">110</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">25</span>,<span style="color:#f60">212</span>,<span style="color:#f60">59</span>,<span style="color:#f60">3</span>,<span style="color:#f60">3</span>,<span style="color:#f60">226</span>,<span style="color:#f60">84</span>,<span style="color:#f60">62</span>,<span style="color:#f60">89</span>,
       <span style="color:#f60">208</span>,<span style="color:#f60">192</span>,<span style="color:#f60">202</span>,<span style="color:#f60">156</span>,...<span style="color:#555">&gt;&gt;</span>}}
</code></pre></div><h3 id="processing-the-response-first-few-bits">Processing the response, first few bits</h3>
<p>The response is just a binary that we need to slice and dice, similarly how we created the request.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#f60">3</span><span style="color:#555">&gt;</span> <span style="color:#033">Resp</span>.
<span style="color:#555">&lt;&lt;</span><span style="color:#f60">36</span>,<span style="color:#f60">2</span>,<span style="color:#f60">0</span>,<span style="color:#f60">231</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">110</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">25</span>,<span style="color:#f60">212</span>,<span style="color:#f60">59</span>,<span style="color:#f60">3</span>,<span style="color:#f60">3</span>,<span style="color:#f60">226</span>,<span style="color:#f60">84</span>,<span style="color:#f60">62</span>,<span style="color:#f60">89</span>,
  <span style="color:#f60">208</span>,<span style="color:#f60">192</span>,<span style="color:#f60">202</span>,<span style="color:#f60">156</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,...<span style="color:#555">&gt;&gt;</span>
</code></pre></div><p>First, we can just get the first few bits.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#f60">4</span><span style="color:#555">&gt;</span> <span style="color:#555">&lt;&lt;</span> <span style="color:#033">Li</span>:<span style="color:#f60">2</span>, <span style="color:#033">Version</span>:<span style="color:#f60">3</span>, <span style="color:#033">Mode</span>:<span style="color:#f60">3</span>, _rest<span style="color:#555">/</span>binary <span style="color:#555">&gt;&gt;</span> <span style="color:#555">=</span> <span style="color:#033">Resp</span>.
<span style="color:#555">&lt;&lt;</span><span style="color:#f60">36</span>,<span style="color:#f60">2</span>,<span style="color:#f60">0</span>,<span style="color:#f60">231</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">110</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">25</span>,<span style="color:#f60">212</span>,<span style="color:#f60">59</span>,<span style="color:#f60">3</span>,<span style="color:#f60">3</span>,<span style="color:#f60">226</span>,<span style="color:#f60">84</span>,<span style="color:#f60">62</span>,<span style="color:#f60">89</span>,
  <span style="color:#f60">208</span>,<span style="color:#f60">192</span>,<span style="color:#f60">202</span>,<span style="color:#f60">156</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,...<span style="color:#555">&gt;&gt;</span>
<span style="color:#f60">5</span><span style="color:#555">&gt;</span> {li, <span style="color:#033">Li</span>, version, <span style="color:#033">Version</span>, mode, <span style="color:#033">Mode</span>}.
{li,<span style="color:#f60">0</span>,version,<span style="color:#f60">4</span>,mode,<span style="color:#f60">4</span>}
</code></pre></div><p>It works.</p>
<p>The rest of the header a bit more tricky but with the bitstring syntax, it is easy to manage.</p>
<h3 id="processing-the-response-the-rest">Processing the response, the rest</h3>
<p>Finally matching all the mandatory fields.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#f60">6</span><span style="color:#555">&gt;</span>   <span style="color:#555">&lt;&lt;</span> <span style="color:#033">LI</span>:<span style="color:#f60">2</span>, <span style="color:#033">Version</span>:<span style="color:#f60">3</span>, <span style="color:#033">Mode</span>:<span style="color:#f60">3</span>, <span style="color:#033">Stratum</span>:<span style="color:#f60">8</span>, <span style="color:#033">Poll</span>:<span style="color:#f60">8</span><span style="color:#555">/</span>signed, <span style="color:#033">Precision</span>:<span style="color:#f60">8</span><span style="color:#555">/</span>signed,
<span style="color:#f60">6</span><span style="color:#555">&gt;</span>      <span style="color:#033">RootDel</span>:<span style="color:#f60">32</span>, <span style="color:#033">RootDisp</span>:<span style="color:#f60">32</span>, <span style="color:#033">R1</span>:<span style="color:#f60">8</span>, <span style="color:#033">R2</span>:<span style="color:#f60">8</span>, <span style="color:#033">R3</span>:<span style="color:#f60">8</span>, <span style="color:#033">R4</span>:<span style="color:#f60">8</span>, <span style="color:#033">RtsI</span>:<span style="color:#f60">32</span>, <span style="color:#033">RtsF</span>:<span style="color:#f60">32</span>,
<span style="color:#f60">6</span><span style="color:#555">&gt;</span>      <span style="color:#033">OtsI</span>:<span style="color:#f60">32</span>, <span style="color:#033">OtsF</span>:<span style="color:#f60">32</span>,   <span style="color:#033">RcvI</span>:<span style="color:#f60">32</span>, <span style="color:#033">RcvF</span>:<span style="color:#f60">32</span>, <span style="color:#033">XmtI</span>:<span style="color:#f60">32</span>, <span style="color:#033">XmtF</span>:<span style="color:#f60">32</span> <span style="color:#555">&gt;&gt;</span> <span style="color:#555">=</span> <span style="color:#033">Resp</span>.
<span style="color:#555">&lt;&lt;</span><span style="color:#f60">36</span>,<span style="color:#f60">2</span>,<span style="color:#f60">0</span>,<span style="color:#f60">231</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">110</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">25</span>,<span style="color:#f60">212</span>,<span style="color:#f60">59</span>,<span style="color:#f60">3</span>,<span style="color:#f60">3</span>,<span style="color:#f60">226</span>,<span style="color:#f60">84</span>,<span style="color:#f60">62</span>,<span style="color:#f60">89</span>,
  <span style="color:#f60">208</span>,<span style="color:#f60">192</span>,<span style="color:#f60">202</span>,<span style="color:#f60">156</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,<span style="color:#f60">0</span>,...<span style="color:#555">&gt;&gt;</span>
</code></pre></div><p>Making sense of these values requires a bit more legwork. First, we need a utility function for binary fractions.</p>
<p>In Erlang, function arity differentiates functions so we can do the following:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#c0f">binfrac</span>(<span style="color:#033">Bin</span>) <span style="color:#555">-&gt;</span>
  binfrac(<span style="color:#033">Bin</span>, <span style="color:#f60">2</span>, <span style="color:#f60">0</span>).
<span style="color:#c0f">binfrac</span>(<span style="color:#f60">0</span>, _, <span style="color:#033">Frac</span>) <span style="color:#555">-&gt;</span>
  <span style="color:#033">Frac</span>;
<span style="color:#c0f">binfrac</span>(<span style="color:#033">Bin</span>, <span style="color:#033">N</span>, <span style="color:#033">Frac</span>) <span style="color:#555">-&gt;</span>
  binfrac(<span style="color:#033">Bin</span> <span style="color:#000;font-weight:bold">bsr</span> <span style="color:#f60">1</span>, <span style="color:#033">N</span><span style="color:#555">*</span><span style="color:#f60">2</span>, <span style="color:#033">Frac</span> <span style="color:#555">+</span> (<span style="color:#033">Bin</span> <span style="color:#000;font-weight:bold">band</span> <span style="color:#f60">1</span>)<span style="color:#555">/</span><span style="color:#033">N</span>).
</code></pre></div><p>With this function, we can implement the one that processes the response and returns the values we are interested in.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang"><span style="color:#09f;font-style:italic">% 2208988800 is the offset (1900 to Unix epoch)
</span><span style="color:#09f;font-style:italic"></span>
<span style="color:#c0f">process_ntp_response</span>(<span style="color:#033">Ntp_response</span>) <span style="color:#555">-&gt;</span>
  <span style="color:#555">&lt;&lt;</span> <span style="color:#033">LI</span>:<span style="color:#f60">2</span>, <span style="color:#033">Version</span>:<span style="color:#f60">3</span>, <span style="color:#033">Mode</span>:<span style="color:#f60">3</span>, <span style="color:#033">Stratum</span>:<span style="color:#f60">8</span>, <span style="color:#033">Poll</span>:<span style="color:#f60">8</span><span style="color:#555">/</span>signed, <span style="color:#033">Precision</span>:<span style="color:#f60">8</span><span style="color:#555">/</span>signed,
     <span style="color:#033">RootDel</span>:<span style="color:#f60">32</span>, <span style="color:#033">RootDisp</span>:<span style="color:#f60">32</span>, <span style="color:#033">R1</span>:<span style="color:#f60">8</span>, <span style="color:#033">R2</span>:<span style="color:#f60">8</span>, <span style="color:#033">R3</span>:<span style="color:#f60">8</span>, <span style="color:#033">R4</span>:<span style="color:#f60">8</span>, <span style="color:#033">RtsI</span>:<span style="color:#f60">32</span>, <span style="color:#033">RtsF</span>:<span style="color:#f60">32</span>,
     <span style="color:#033">OtsI</span>:<span style="color:#f60">32</span>, <span style="color:#033">OtsF</span>:<span style="color:#f60">32</span>,   <span style="color:#033">RcvI</span>:<span style="color:#f60">32</span>, <span style="color:#033">RcvF</span>:<span style="color:#f60">32</span>, <span style="color:#033">XmtI</span>:<span style="color:#f60">32</span>, <span style="color:#033">XmtF</span>:<span style="color:#f60">32</span> <span style="color:#555">&gt;&gt;</span> <span style="color:#555">=</span> <span style="color:#033">Ntp_response</span>,
  {<span style="color:#033">NowMS</span>, <span style="color:#033">NowS</span>, <span style="color:#033">NowUS</span>} <span style="color:#555">=</span> <span style="color:#0cf;font-weight:bold">erlang</span>:<span style="color:#c0f">timestamp</span>(),
  <span style="color:#033">NowTimestamp</span> <span style="color:#555">=</span> <span style="color:#033">NowMS</span> <span style="color:#555">*</span> <span style="color:#f60">1</span>.<span style="color:#f60">0</span>e6 <span style="color:#555">+</span> <span style="color:#033">NowS</span> <span style="color:#555">+</span> <span style="color:#033">NowUS</span><span style="color:#555">/</span><span style="color:#f60">1000</span>,
  <span style="color:#033">TransmitTimestamp</span> <span style="color:#555">=</span> <span style="color:#033">XmtI</span> <span style="color:#555">-</span> <span style="color:#f60">2208988800</span> <span style="color:#555">+</span> binfrac(<span style="color:#033">XmtF</span>),
  { {li, <span style="color:#033">LI</span>}, {vn, <span style="color:#033">Version</span>}, {mode, <span style="color:#033">Mode</span>}, {stratum, <span style="color:#033">Stratum</span>}, {poll, <span style="color:#033">Poll</span>}, {precision, <span style="color:#033">Precision</span>},
    {rootDelay, <span style="color:#033">RootDel</span>}, {rootDispersion, <span style="color:#033">RootDisp</span>}, {referenceId, <span style="color:#033">R1</span>, <span style="color:#033">R2</span>, <span style="color:#033">R3</span>, <span style="color:#033">R4</span>},
    {referenceTimestamp, <span style="color:#033">RtsI</span> <span style="color:#555">-</span> <span style="color:#f60">2208988800</span> <span style="color:#555">+</span> binfrac(<span style="color:#033">RtsF</span>)},
    {originateTimestamp, <span style="color:#033">OtsI</span> <span style="color:#555">-</span> <span style="color:#f60">2208988800</span> <span style="color:#555">+</span> binfrac(<span style="color:#033">OtsF</span>)},
    {receiveTimestamp,   <span style="color:#033">RcvI</span> <span style="color:#555">-</span> <span style="color:#f60">2208988800</span> <span style="color:#555">+</span> binfrac(<span style="color:#033">RcvF</span>)},
    {transmitTimestamp,  <span style="color:#033">TransmitTimestamp</span>},
    {clientReceiveTimestamp, <span style="color:#033">NowTimestamp</span>},
    {offset, <span style="color:#033">TransmitTimestamp</span> <span style="color:#555">-</span> <span style="color:#033">NowTimestamp</span>} }.
</code></pre></div><p>And wit that we can just process the response.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-erlang" data-lang="erlang">{{li,<span style="color:#f60">0</span>},
 {vn,<span style="color:#f60">4</span>},
 {mode,<span style="color:#f60">4</span>},
 {stratum,<span style="color:#f60">2</span>},
 {poll,<span style="color:#f60">3</span>},
 {precision,<span style="color:#555">-</span><span style="color:#f60">24</span>},
 {rootDelay,<span style="color:#f60">9</span>},
 {rootDispersion,<span style="color:#f60">140</span>},
 {referenceId,<span style="color:#f60">85</span>,<span style="color:#f60">158</span>,<span style="color:#f60">25</span>,<span style="color:#f60">75</span>},
 {referenceTimestamp,<span style="color:#f60">1588186010</span>.<span style="color:#f60">7517557</span>},
 {originateTimestamp,<span style="color:#555">-</span><span style="color:#f60">2208988800</span>},
 {receiveTimestamp,<span style="color:#f60">1588186048</span>.<span style="color:#f60">3557627</span>},
 {transmitTimestamp,<span style="color:#f60">1588186048</span>.<span style="color:#f60">8841336</span>},
 {clientReceiveTimestamp,<span style="color:#f60">1588186606</span>.<span style="color:#f60">531</span>},
 {offset,<span style="color:#555">-</span><span style="color:#f60">557</span>.<span style="color:#f60">6468663215637</span>}}
</code></pre></div><p>Please note, this is the first step in the NTP workflow and does not implement the complete NTP protocol. We do not take into consideration a bunch of details.</p>
<p>Next time we might look into how to implement a simple server (like DNS) in Erlang.</p>
<p>Michael&rsquo;s original work:</p>
<p><a href="https://github.com/mnp/erlang-ntp">https://github.com/mnp/erlang-ntp</a></p>
<p>Up to date version and Elixir port:</p>
<p><a href="https://gist.github.com/l1x/b0a7f844b283ac08e3125d1ba6e81eeb">https://gist.github.com/l1x/b0a7f844b283ac08e3125d1ba6e81eeb</a></p>

  </div>



</body>
<footer class="pa4 center bg-dark-gray v-btm">
  <div class="mw9 mw8-ns center ph3-ns">
    <div class="pt2 tc">
      <a href="https://github.com/l1x" class="pa1 link dim near-white">Github</a>
      <a href="https://twitter.com/lix" class="pa1 link dim near-white">Twitter</a>
      <a href="https://www.linkedin.com/in/iszukacs/" class="pa1 link dim near-white">Linkedin</a>
    </div>
  </div>
</footer>
</html>