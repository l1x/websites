<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=/css/dosis.min.css><link rel=stylesheet href=/css/tachyons.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/fontawesome.min.css><title>l1x/dev | Compressing data with Parquet</title><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/img/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><meta name=image property="og:image" content><meta name=title property="og:title" content="Compressing data with Parquet"><meta name=description property="og:description" content="Compressing data with Parquet"><meta name=type property="og:type" content="article"><meta name=url property="og:url" content="https://dev.l1x.be/posts/2021/03/08/compressing-data-with-parquet/"><meta name=author content="l1x"></head><body><div class="content mw8-l center pl4"><header class="flex mw8-l center pt4"><div class=pt3><img src=/img/apple-touch-icon.png width=60 alt=apple-touch-icon></div><a href=/ class="title link pl3 pt2"><h1>l1x/dev</h1></a></header><h2 class=post-title>Compressing data with Parquet</h2><div class=gray>2021/03/08 :: #parquet #sqlite</div><div class=toc><nav id=TableOfContents><ol><li><a href=#abstract>Abstract</a></li><li><a href=#the-rise-of-columnar-formats>The rise of columnar formats</a></li><li><a href=#the-use-case>The use case</a></li><li><a href=#the-initial-dataset>The initial dataset</a></li><li><a href=#exporting-data>Exporting data</a></li><li><a href=#closing>Closing</a></li></ol></nav></div><div class="f4 lh-copy"><h2 id=abstract>Abstract</h2><p>Many times I see that people use <a href=https://www.sqlite.org/index.html>Sqlite</a> for distributing large datasets. When the use case is analytical (OLAP), there are often better options. We are going to investigate how much better we could do if we use something other than Sqlite. To make sure, I love Sqlite and use it a lot when a simple SQL single file database does it. For this particular use case, I think using <a href=http://parquet.apache.org/>Parquet</a> is better suited. We are going to explore why.</p><h2 id=the-rise-of-columnar-formats>The rise of columnar formats</h2><p>A while back, when <a href=https://research.fb.com/wp-content/uploads/2011/01/rcfile-a-fast-and-space-efficient-data-placement-structure-in-mapreduce-based-warehouse-systems.pdf>Facebook and Ohio State University investigated</a> what would be the best option to store a large volume of data not too surprisingly, a columnar system came out to be the winner. There are many reasons why and I am not going to go into the details in this article because I do not have that much time. The point is that if you have repetition in your data, a columnar format can be compressed much better than a row-oriented format. On top of that, if you run a query that queries only a subset of the table fields, columnar can skip reading a whole lot of data that speeds up processing. Furthermore, a strong compression (gzip, brotli, zstd) is applied to columnar files, making those even smaller. Smaller files are preferable because the slowest part of data processing is still disk IO.</p><h2 id=the-use-case>The use case</h2><p>While reading through a <a href="https://news.ycombinator.com/item?id=26371706">post on HN</a>, I have run into this comment from <a href="https://news.ycombinator.com/user?id=zomglings">zomglings</a> explaining that they got a dataset that is an export of some Github data.</p><blockquote><p>The dataset for a single crawl comes in at about 60GB. We uploaded the data to Kaggle because we thought it would be a good place for people to work with > the data. Unfortunately, the Kaggle notebook experience is not tailored to such large datasets. Our dataset is in an SQLite database. It takes a long time > for the dataset to load into Kaggle notebooks, and I don&rsquo;t think they are provisioned with SSDs as queries take a long time. Our best workaround to this
is to partition into 3 datasets on Kaggle - train, eval, and development, but it will be a pain to manage this for every update, especially as we enrich
the dataset with results of static analysis, etc.</p></blockquote><p>I was wondering if we could do better than the SQLite version.</p><h2 id=the-initial-dataset>The initial dataset</h2><p>After downloading the sample dataset from <a href=https://www.kaggle.com/simiotic/github-code-snippets-development-sample>Kaggle</a> I started to explore a bit.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-SQL data-lang=SQL> <span style=color:#000>sqlite3</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>header</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>csv</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>readonly</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>header</span> <span style=color:#000>snippets</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>dev</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>db</span> <span style=color:#4e9a06>&#39;.schema snippets&#39;</span>
<span style=color:#204a87;font-weight:700>CREATE</span> <span style=color:#204a87;font-weight:700>TABLE</span> <span style=color:#000>snippets</span> <span style=color:#000;font-weight:700>(</span>
    <span style=color:#000>id</span> <span style=color:#204a87>INTEGER</span> <span style=color:#204a87;font-weight:700>PRIMARY</span> <span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>snippet</span> <span style=color:#204a87>TEXT</span> <span style=color:#204a87;font-weight:700>NOT</span> <span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>language</span> <span style=color:#204a87>TEXT</span> <span style=color:#204a87;font-weight:700>NOT</span> <span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>repo_file_name</span> <span style=color:#204a87>TEXT</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>github_repo_url</span> <span style=color:#204a87>TEXT</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>license</span> <span style=color:#204a87>TEXT</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>commit_hash</span> <span style=color:#204a87>TEXT</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>starting_line_number</span> <span style=color:#204a87>INTEGER</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>chunk_size</span> <span style=color:#204a87>INTEGER</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>UNIQUE</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>commit_hash</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>repo_file_name</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>github_repo_url</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>chunk_size</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>starting_line_number</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>CREATE</span> <span style=color:#204a87;font-weight:700>INDEX</span> <span style=color:#000>snippets_github_repo_url</span> <span style=color:#204a87;font-weight:700>on</span> <span style=color:#000>snippets</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>github_repo_url</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>CREATE</span> <span style=color:#204a87;font-weight:700>INDEX</span> <span style=color:#000>snippets_license</span> <span style=color:#204a87;font-weight:700>on</span> <span style=color:#000>snippets</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>license</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#204a87;font-weight:700>CREATE</span> <span style=color:#204a87;font-weight:700>INDEX</span> <span style=color:#000>snippets_language</span> <span style=color:#204a87;font-weight:700>on</span> <span style=color:#000>snippets</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>language</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>The first thing I found that there is a weird spacing going on with the commit_hash column:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-SQL data-lang=SQL><span style=color:#000>sqlite</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>SELECT</span> <span style=color:#000>commit_hash</span> <span style=color:#204a87;font-weight:700>FROM</span> <span style=color:#000>snippets</span> <span style=color:#204a87;font-weight:700>LIMIT</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>

<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>

<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>

<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>

<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>

<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>

<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>

<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>

<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>

<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>
</code></pre></div><p>I realized that there is a trailing newline for each commit hash. I quickly fixed that.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-SQL data-lang=SQL><span style=color:#000>sqlite</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>UPDATE</span> <span style=color:#000>snippets</span> <span style=color:#204a87;font-weight:700>SET</span> <span style=color:#000>commit_hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>commit_hash</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>CHAR</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>);</span>
<span style=color:#000>sqlite</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>UPDATE</span> <span style=color:#000>snippets</span> <span style=color:#204a87;font-weight:700>SET</span> <span style=color:#000>commit_hash</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>commit_hash</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>CHAR</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>),</span> <span style=color:#4e9a06>&#39;&#39;</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><p>Now the commit hashes looked ok.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-SQL data-lang=SQL><span style=color:#000>sqlite</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>SELECT</span> <span style=color:#000>commit_hash</span> <span style=color:#204a87;font-weight:700>FROM</span> <span style=color:#000>snippets</span> <span style=color:#204a87;font-weight:700>LIMIT</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>
<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>
<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>
<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>
<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>
<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>
<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>
<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>
<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>
<span style=color:#0000cf;font-weight:700>000427352</span><span style=color:#000>ad89da7fb4325037c116a3b06745608</span>
</code></pre></div><p>Before I continued working with the dataset, I quickly vacuumed that database:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-SQL data-lang=SQL><span style=color:#000>sqlite</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>PRAGMA</span> <span style=color:#000>auto_vacuum</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>FULL</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000>sqlite</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>VACUUM</span><span style=color:#000;font-weight:700>;</span>
</code></pre></div><p>It reduced the size by 100MB.</p><p>Next step I just looked into the fields (skipping the snippet part):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-SQL data-lang=SQL><span style=color:#000>sqlite</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>SELECT</span> <span style=color:#000>id</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>language</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#000>repo_file_name</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#000>github_repo_url</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#000>license</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#000>commit_hash</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#000>starting_line_number</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#000>chunk_size</span>
<span style=color:#204a87;font-weight:700>FROM</span> <span style=color:#000>snippets</span>
<span style=color:#204a87;font-weight:700>LIMIT</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000>id</span>          <span style=color:#204a87;font-weight:700>language</span>    <span style=color:#000>repo_file_name</span>            <span style=color:#000>github_repo_url</span>                   <span style=color:#000>license</span>     <span style=color:#000>commit_hash</span>                               <span style=color:#000>starting_line_number</span>  <span style=color:#000>chunk_size</span>
<span style=color:#8f5902;font-style:italic>----------  ----------  ------------------------  --------------------------------  ----------  ----------------------------------------  --------------------  ----------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>491</span>         <span style=color:#000>DOTFILE</span>     <span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>gitignore</span>  <span style=color:#000>https</span><span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#000>github</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span>  <span style=color:#000>GPL</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>21634</span><span style=color:#000>e2681fb1329bcbab7b2e19418ebdb1012e1</span>  <span style=color:#0000cf;font-weight:700>65</span>                    <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#0000cf;font-weight:700>512</span>         <span style=color:#204a87;font-weight:700>UNKNOWN</span>     <span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>LICENSE</span>     <span style=color:#000>https</span><span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#000>github</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span>  <span style=color:#000>GPL</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>21634</span><span style=color:#000>e2681fb1329bcbab7b2e19418ebdb1012e1</span>  <span style=color:#0000cf;font-weight:700>100</span>                   <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#0000cf;font-weight:700>584</span>         <span style=color:#204a87;font-weight:700>UNKNOWN</span>     <span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>LICENSE</span>     <span style=color:#000>https</span><span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#000>github</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span>  <span style=color:#000>GPL</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>21634</span><span style=color:#000>e2681fb1329bcbab7b2e19418ebdb1012e1</span>  <span style=color:#0000cf;font-weight:700>460</span>                   <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#0000cf;font-weight:700>610</span>         <span style=color:#204a87;font-weight:700>UNKNOWN</span>     <span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>LICENSE</span>     <span style=color:#000>https</span><span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#000>github</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span>  <span style=color:#000>GPL</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>21634</span><span style=color:#000>e2681fb1329bcbab7b2e19418ebdb1012e1</span>  <span style=color:#0000cf;font-weight:700>590</span>                   <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#0000cf;font-weight:700>627</span>         <span style=color:#000>JavaScript</span>  <span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>group</span>  <span style=color:#000>https</span><span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#000>github</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span>  <span style=color:#000>GPL</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>21634</span><span style=color:#000>e2681fb1329bcbab7b2e19418ebdb1012e1</span>  <span style=color:#0000cf;font-weight:700>5</span>                     <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#0000cf;font-weight:700>638</span>         <span style=color:#000>JavaScript</span>  <span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>group</span>  <span style=color:#000>https</span><span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#000>github</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span>  <span style=color:#000>GPL</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>21634</span><span style=color:#000>e2681fb1329bcbab7b2e19418ebdb1012e1</span>  <span style=color:#0000cf;font-weight:700>60</span>                    <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#0000cf;font-weight:700>646</span>         <span style=color:#000>JavaScript</span>  <span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>group</span>  <span style=color:#000>https</span><span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#000>github</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span>  <span style=color:#000>GPL</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>21634</span><span style=color:#000>e2681fb1329bcbab7b2e19418ebdb1012e1</span>  <span style=color:#0000cf;font-weight:700>100</span>                   <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#0000cf;font-weight:700>673</span>         <span style=color:#000>JavaScript</span>  <span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>group</span>  <span style=color:#000>https</span><span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#000>github</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span>  <span style=color:#000>GPL</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>21634</span><span style=color:#000>e2681fb1329bcbab7b2e19418ebdb1012e1</span>  <span style=color:#0000cf;font-weight:700>235</span>                   <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#0000cf;font-weight:700>690</span>         <span style=color:#000>JavaScript</span>  <span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>group</span>  <span style=color:#000>https</span><span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#000>github</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span>  <span style=color:#000>GPL</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>21634</span><span style=color:#000>e2681fb1329bcbab7b2e19418ebdb1012e1</span>  <span style=color:#0000cf;font-weight:700>320</span>                   <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#0000cf;font-weight:700>714</span>         <span style=color:#000>JavaScript</span>  <span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>group</span>  <span style=color:#000>https</span><span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>//</span><span style=color:#000>github</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>NodeBB</span>  <span style=color:#000>GPL</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span>     <span style=color:#0000cf;font-weight:700>21634</span><span style=color:#000>e2681fb1329bcbab7b2e19418ebdb1012e1</span>  <span style=color:#0000cf;font-weight:700>440</span>                   <span style=color:#0000cf;font-weight:700>5</span>
</code></pre></div><p>Based on this, I saw that there is a potentially high repetition in many of the fields. It can be quickly verified:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-SQL data-lang=SQL><span style=color:#204a87;font-weight:700>SELECT</span>
  <span style=color:#204a87;font-weight:700>COUNT</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span> <span style=color:#204a87;font-weight:700>language</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>AS</span>  <span style=color:#000>language_dcnt</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>COUNT</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span> <span style=color:#000>repo_file_name</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>AS</span> <span style=color:#000>repo_file_name_dcnt</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>COUNT</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span> <span style=color:#000>github_repo_url</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>AS</span> <span style=color:#000>github_repo_url_dcnt</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>COUNT</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span> <span style=color:#000>license</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>AS</span> <span style=color:#000>license_dcnt</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>COUNT</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span> <span style=color:#000>commit_hash</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>AS</span> <span style=color:#000>commit_hash_dcnt</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>COUNT</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span> <span style=color:#000>starting_line_number</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>AS</span> <span style=color:#000>starting_line_number_dcnt</span>
  <span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>COUNT</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>DISTINCT</span> <span style=color:#000>chunk_size</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>AS</span> <span style=color:#000>chunk_size_dcnt</span>
<span style=color:#204a87;font-weight:700>FROM</span> <span style=color:#000>snippets</span> <span style=color:#204a87;font-weight:700>LIMIT</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#000>language_dcnt</span>
<span style=color:#8f5902;font-style:italic>-------------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>21</span>

<span style=color:#000>repo_file_name_dcnt</span>
<span style=color:#8f5902;font-style:italic>-------------------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>1150333</span>

<span style=color:#000>github_repo_url_dcnt</span>
<span style=color:#8f5902;font-style:italic>--------------------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>1621</span>

<span style=color:#000>license_dcnt</span>
<span style=color:#8f5902;font-style:italic>------------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>21</span>

<span style=color:#000>commit_hash_dcnt</span>
<span style=color:#8f5902;font-style:italic>----------------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>1621</span>

<span style=color:#000>starting_line_number_dcnt</span>
<span style=color:#8f5902;font-style:italic>-------------------------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>27833</span>

<span style=color:#000>chunk_size_dcnt</span>
<span style=color:#8f5902;font-style:italic>---------------
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#0000cf;font-weight:700>1</span>
</code></pre></div><h2 id=exporting-data>Exporting data</h2><p>Based on the previous distinct counts, I decided to export the data the following way:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-SQL data-lang=SQL><span style=color:#000>sqlite3</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>header</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>csv</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>readonly</span> <span style=color:#000>snippets</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>dev</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>db</span> <span style=color:#4e9a06>&#39;SELECT * FROM snippets ORDER BY chunk_size, license, language, github_repo_url, commit_hash&#39;</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>test1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>csv</span>
</code></pre></div><p>Using the freshly exported file, I can now convert the CSV to Parquet with default settings first.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Python data-lang=Python><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>pandas</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>pd</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>sys</span>
<span style=color:#000>df</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>read_csv</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>argv</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>])</span>
<span style=color:#000>df</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>to_parquet</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>argv</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>])</span>
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>python par.py test1.csv test1.parquet
</code></pre></div><p>The results are already good:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>2.9G Mar  <span style=color:#0000cf;font-weight:700>8</span> 08:37 snippets-dev.db
427M Mar  <span style=color:#0000cf;font-weight:700>8</span> 14:05 test1.parquet
</code></pre></div><p>Now we can import the CSV file into a DataFrame using Python:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Python data-lang=Python><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>pandas</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>pd</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>sys</span>

<span style=color:#000>df</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pd</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>read_parquet</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>argv</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>engine</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;pyarrow&#39;</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><p>Then I remembered that the default compression for Parquet in the Python library is still snappy for some weird reason. Changing that to gzip, we can get much better.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-Python data-lang=Python><span style=color:#000>df</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>to_parquet</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sys</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>argv</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>compression</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;gzip&#39;</span><span style=color:#000;font-weight:700>)</span>
</code></pre></div><p>After creating another version, compressing it with gzip, this time the result is much better.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>265M Mar  <span style=color:#0000cf;font-weight:700>8</span> 17:28 test1.gzip.parquet
</code></pre></div><p>Results:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>Sqlite:           <span style=color:#ce5c00;font-weight:700>||||||||||||||||||||||||||||||</span>  3000MB 100%
Parquet<span style=color:#ce5c00;font-weight:700>(</span>Snappy<span style=color:#ce5c00;font-weight:700>)</span>:  <span style=color:#ce5c00;font-weight:700>||||</span>                            427MB  14.2%
Parquet<span style=color:#ce5c00;font-weight:700>(</span>Gzip<span style=color:#ce5c00;font-weight:700>)</span>:    <span style=color:#ce5c00;font-weight:700>||</span><span style=color:#000;font-weight:700>|</span>                             265MB  8.83%
</code></pre></div><h2 id=closing>Closing</h2><p>91.17% reduction with Parquet is not that bad. If you need some help with data engineering or have any performance related question (especially querying large datasets) feel free to reach out. See the links below.</p></div></div></body><footer class="mw8-l center pa4"><a href=https://github.com/l1x class=pa2><i class="fab fa-github fa-2x"></i></a><a href=https://twitter.com/lix class=pa2><i class="fab fa-twitter fa-2x"></i></a><a href=https://www.linkedin.com/in/iszukacs class=pa2><i class="fab fa-linkedin fa-2x"></i></a><a href=https://dev.to/l1x class=pa2><i class="fab fa-dev fa-2x"></i></a></footer></html>